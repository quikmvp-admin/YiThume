<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Favicon: Gradient square with a white Y -->
  <link
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%2310b981'/%3E%3Cstop offset='100%25' stop-color='%23059669'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect rx='12' width='36' height='36' fill='url(%23g)'/%3E%3Cpath d='M10 10h4l4 4 4-4h4l-8 8v8h-4v-8z' fill='%23fff'/%3E%3C/svg%3E"
  />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YiThume — Health delivered. Fast.</title>
  <meta name="description" content="YiThume delivers OTC meds to remote and hard-to-reach places. Start in the Eastern Cape — expanding nationwide. Order on the website, confirm in WhatsApp." />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --emerald-600:#059669; --emerald-500:#10b981; --emerald-400:#34d399; --emerald-800:#047857; --emerald-900:#065f46;
      --map-bg:#f6f8f9; --hero-h: 360px;
    }
    @media (max-width:640px){ :root{ --hero-h: 280px; } }

    /* Leaflet layers above Tailwind sections */
    .leaflet-pane,
    .leaflet-top,
    .leaflet-bottom { z-index: 10 !important; }
    #heroMap{
      height:var(--hero-h);
      border-radius:16px;
      position:relative;
      overflow:hidden;
      background:var(--map-bg);
    }
    .leaflet-control-container{display:none;}

    /* Animated map markers */
    .car-dot{transform:translate(-50%,-50%);}
    .car-dot svg{
      width:18px;
      height:18px;
      filter:drop-shadow(0 1px 1px rgba(0,0,0,.18));
    }
    .pkg-dot{transform:translate(-50%,-50%);}
    .pkg-dot svg{
      width:20px;
      height:20px;
      filter:drop-shadow(0 1px 1px rgba(0,0,0,.15))
    }

    /* Overlay tint + region badge */
    .tint{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(5,150,105,.04),rgba(5,150,105,.03));
      pointer-events:none;
    }
    .ec-badge{
      position:absolute;
      left:14px;
      bottom:12px;
      padding:6px 10px;
      border-radius:10px;
      background:rgba(15,23,42,.75);
      color:#fff;
      font-size:12px;
      line-height:1.2;
      backdrop-filter: blur(2px);
    }

    /* Body scroll lock class used while modals are open */
    .overflow-locked {
      overflow: hidden;
      touch-action: none;
    }

    /* =========================
       Orders Admin layout helpers
       ========================= */
    .yt-modal-body{
      max-height:70vh;      /* scroll body only */
      overflow-y:auto;
    }
    .yt-sticky{ position:sticky; z-index:10; background:#fff; }
    .yt-sticky-top{ top:0; }
    .yt-sticky-bottom{ bottom:0; }
    .yt-chip{ line-height:1.1; }

    /* Driver card grid for "Drivers" tab content */
    .yt-driver-card{
      display:grid;
      grid-template-columns: 1fr auto; /* info | actions */
      gap:.75rem;
    }
    @media (max-width:640px){
      .yt-driver-card{ grid-template-columns: 1fr; } /* stack on mobile */
    }
    .yt-actions{
      display:flex; align-items:flex-start; justify-content:flex-end;
      gap:.5rem; flex-wrap:wrap;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900">

<!-- Header -->
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <!-- Header logo: Gradient square with a white Y -->
      <svg width="36" height="36" viewBox="0 0 36 36" class="rounded-2xl" aria-label="YiThume logo">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stop-color="#10b981"/><stop offset="100%" stop-color="#059669"/>
          </linearGradient>
        </defs>
        <rect rx="12" width="36" height="36" fill="url(#g)"/>
        <path d="M10 10h4l4 4 4-4h4l-8 8v8h-4v-8z" fill="#fff"/>
      </svg>
      <div class="text-xl font-semibold tracking-tight">YiThume</div>
    </div>

    <!-- Desktop nav -->
    <nav class="hidden md:flex items-center gap-6" aria-label="Primary">
      <a href="#how" class="text-sm hover:text-emerald-700">How It Works</a>
      <a href="#services" class="text-sm hover:text-emerald-700">Services</a>
      <a href="#pricing" class="text-sm hover:text-emerald-700">Pricing</a>
      <a href="#drivers" class="text-sm hover:text-emerald-700">For Drivers</a>
      <a href="#faq" class="text-sm hover:text-emerald-700">FAQ</a>
    </nav>

    <div class="flex items-center gap-2">
      <!-- Mobile hamburger -->
      <button id="mobileMenuBtn"
        class="md:hidden p-2 rounded-lg border border-slate-300 active:scale-95 transition"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobileNavDropdown">
        <svg id="mobileMenuIconOpen" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 6h16M4 12h16M4 18h16"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg id="mobileMenuIconClose" width="20" height="20" viewBox="0 0 24 24" class="hidden" fill="none" aria-hidden="true">
          <path d="M6 6L18 18M6 18L18 6"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <!-- CTAs (desktop / sm+) -->
      <div class="hidden sm:flex items-center gap-2">
        <button id="openOrderBuilderTop"
          class="px-3 py-2 text-sm rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
          Start order
        </button>
        <button id="openDriverModalTop"
          class="px-3 py-2 text-sm rounded-xl border border-slate-300 hover:bg-slate-100">
          Driver sign-in / up
        </button>

        <button id="adminLoginBtn"
          class="px-3 py-2 text-xs rounded-xl border border-slate-300 hover:bg-slate-100">
          Admin
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile dropdown nav -->
  <div id="mobileNavDropdown"
       class="md:hidden hidden border-t border-slate-200 bg-white shadow-xl"
       role="menu" aria-label="Mobile navigation">
    <nav class="px-4 py-4 text-sm flex flex-col gap-2 max-w-6xl mx-auto w-full">
      <a href="#how" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">How It Works</a>
      <a href="#services" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">Services</a>
      <a href="#pricing" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">Pricing</a>
      <a href="#drivers" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">For Drivers</a>
      <a href="#faq" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">FAQ</a>

      <div class="h-px bg-slate-200 my-3"></div>

      <button id="openOrderBuilderTopMobile"
        class="w-full py-2 rounded-xl bg-emerald-600 text-white text-center active:scale-[.98] transition mobile-nav-link">
        Start order
      </button>

      <button id="openDriverModalTopMobile"
        class="w-full py-2 rounded-xl border border-slate-300 text-center active:scale-[.98] transition mobile-nav-link">
        Driver sign-in / up
      </button>

      <button id="adminLoginBtnMobile"
        class="w-full py-2 rounded-xl border border-slate-300 text-center text-xs active:scale-[.98] transition mobile-nav-link">
        Admin
      </button>
    </nav>
  </div>
</header>

<!-- Hero -->
<section class="relative">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-14 sm:py-20 grid md:[grid-template-columns:1.2fr_1fr] gap-10 items-stretch">
    <!-- Left card -->
    <div class="flex">
      <div class="rounded-3xl border bg-white p-6 shadow-sm h-full w-full min-h-[var(--hero-h)] flex flex-col">
        <div>
          <h1 class="text-4xl sm:text-5xl font-bold leading-tight">
            Health delivered. <span class="text-emerald-600">Fast</span>.
          </h1>
          <p class="mt-4 text-slate-700 max-w-xl">
            Order on the website, then we confirm and send a secure payment link in WhatsApp. Clear pricing, trusted local drivers.
          </p>
        </div>
        <ul class="mt-6 grid grid-cols-2 gap-3 text-sm">
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Website ➜ WhatsApp</b>
              <div class="text-slate-500 text-xs">No app needed</div>
            </div>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Same-day windows</b>
              <div class="text-slate-500 text-xs">08–10 • 12–14 • 16–18</div>
            </div>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Card or EFT</b>
              <div class="text-slate-500 text-xs">Yoco link / Ozow EFT</div>
            </div>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Deposit + COD</b>
              <div class="text-slate-500 text-xs">Returning customers only</div>
            </div>
          </li>
        </ul>
        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <button id="openOrderBuilder" class="px-5 py-3 rounded-2xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700">
            Start order
          </button>
          <button id="openDriverModal" class="px-5 py-3 rounded-2xl border border-slate-300 text-slate-800 text-sm font-medium hover:bg-slate-100">
            Sign up / Log in (Driver)
          </button>
        </div>
        <div class="mt-3 text-xs text-slate-500">Build your basket here — we’ll send it to WhatsApp for confirmation &amp; payment.</div>
        <div class="mt-auto"></div>
      </div>
    </div>

    <!-- Right map card -->
    <div class="flex">
      <div class="rounded-3xl border bg-white p-3 shadow-sm h-full w-full relative min-h-[var(--hero-h)]">
        <div class="flex items-center justify-between px-1 pb-2">
          <div class="text-sm text-slate-600">Coverage map</div>
          <span class="px-2 py-1 text-xs rounded-lg bg-emerald-100 text-emerald-700">LIVE</span>
        </div>
        <div id="heroMap" class="rounded-2xl" aria-label="Active delivery coverage map"></div>
        <div class="tint" aria-hidden="true"></div>
        <div class="ec-badge" id="coverageBadge">Starting in Eastern Cape • expanding nationwide</div>
      </div>
    </div>
  </div>
</section>

<!-- How it works -->
<section id="how" class="py-12 sm:py-16 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <h2 class="text-2xl sm:text-3xl font-bold">How YiThume Works</h2>
    <div class="mt-6 grid md:grid-cols-4 gap-4">
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 1</div>
        <div class="mt-1 font-semibold">Build order</div>
        <p class="mt-2 text-sm text-slate-700">Choose items and your nearest pickup depot on the website.</p>
      </div>
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 2</div>
        <div class="mt-1 font-semibold">WhatsApp confirm</div>
        <p class="mt-2 text-sm text-slate-700">We send summary + payment instructions in WhatsApp.</p>
      </div>
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 3</div>
        <div class="mt-1 font-semibold">Pay online</div>
        <p class="mt-2 text-sm text-slate-700">
          Card link (Yoco) or Instant EFT (Ozow). Returning customers can do 50% deposit + COD.
        </p>
      </div>
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 4</div>
        <div class="mt-1 font-semibold">Delivery</div>
        <p class="mt-2 text-sm text-slate-700">
          We dispatch a verified local driver in your time window.
        </p>
      </div>
    </div>
  </div>
</section>

<!-- Services / Drivers pitch block -->
<section id="drivers" class="py-12 sm:py-16 border-t border-slate-200 bg-white/50">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 grid md:grid-cols-2 gap-8">
    <div class="rounded-2xl border bg-white shadow-sm p-6 flex flex-col">
      <div class="text-xs font-semibold uppercase tracking-wide text-emerald-700">Drive with us</div>
      <h2 class="text-2xl sm:text-3xl font-bold mt-2 leading-tight">
        We deliver to remote locations using trusted local drivers.
      </h2>
      <p class="mt-3 text-sm text-slate-700 leading-relaxed">
        Sign up to put your community on the map and get paid per successful delivery.
        Flexible windows, weekly EFT payouts.
      </p>
      <ul class="mt-4 text-sm space-y-2">
        <li class="flex items-start gap-2">
          <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700 text-[11px] font-bold">1</span>
          <div>
            Take small health + essentials orders from local shops to local people.
          </div>
        </li>
        <li class="flex items-start gap-2">
          <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700 text-[11px] font-bold">2</span>
          <div>
            Get a payout per drop. You’ll always see the amount before you accept.
          </div>
        </li>
        <li class="flex items-start gap-2">
          <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700 text-[11px] font-bold">3</span>
          <div>
            We handle payment and customer support. You just deliver.
          </div>
        </li>
      </ul>

      <button id="openDriverModalSection"
        class="mt-6 inline-flex justify-center px-4 py-3 rounded-xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700">
        Become a driver
      </button>

      <div class="mt-3 text-[11px] text-slate-500 leading-snug">
        We’re especially looking for reliable drivers in rural / township areas.
      </div>
    </div>

    <div class="rounded-2xl border bg-white shadow-sm p-6 flex flex-col" id="services">
      <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">What we deliver</div>
      <h2 class="text-xl sm:text-2xl font-bold mt-2 leading-tight">OTC meds &amp; essentials</h2>
      <p class="mt-3 text-sm text-slate-700 leading-relaxed">
        Flu, pain, stomach, allergy, dressings, hydration, pads, nappies, hygiene basics —
        all from local independent pharmacies and shops.
      </p>
      <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">Headache &amp; fever</div>
          <div class="text-[11px] text-slate-500">Panado, etc.</div>
        </div>
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">Cold &amp; flu</div>
          <div class="text-[11px] text-slate-500">Cough syrups, throat</div>
        </div>
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">Tummy &amp; hydration</div>
          <div class="text-[11px] text-slate-500">Electrolytes, nausea</div>
        </div>
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">First aid &amp; hygiene</div>
          <div class="text-[11px] text-slate-500">Bandages, pads, etc.</div>
        </div>
      </div>

      <div class="mt-auto pt-6 text-[11px] text-slate-500 leading-snug">
        We are a delivery service only. We do not provide medical advice.
      </div>
    </div>
  </div>
</section>

<!-- Pricing (distance-based, no zones) -->
<section id="pricing" class="py-12 sm:py-16 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <h2 class="text-2xl sm:text-3xl font-bold">Pricing</h2>

    <div class="mt-6 grid md:grid-cols-3 gap-4">
      <div class="rounded-2xl border bg-white p-5 shadow-sm">
        <div class="text-sm text-slate-500">Base</div>
        <div class="mt-1 text-2xl font-bold">R15</div>
        <div class="mt-2 text-sm text-slate-600">Base delivery fee per order.</div>
      </div>
      <div class="rounded-2xl border bg-white p-5 shadow-sm">
        <div class="text-sm text-slate-500">Distance</div>
        <div class="mt-1 text-2xl font-bold">R8 / km</div>
        <div class="mt-2 text-sm text-slate-600">From pickup depot to your address.</div>
      </div>
      <div class="rounded-2xl border bg-white p-5 shadow-sm">
        <div class="text-sm text-slate-500">Rush (optional)</div>
        <div class="mt-1 text-2xl font-bold">+ R30</div>
        <div class="mt-2 text-sm text-slate-600">When available in your area.</div>
      </div>
    </div>

    <div class="mt-6 rounded-2xl border bg-white p-5 shadow-sm">
      <div class="text-sm text-slate-500">Pickup depots (select in checkout)</div>
      <ul class="mt-2 text-sm text-slate-700 list-disc pl-5" id="depotList">
        <li>Port Alfred Depot</li>
        <li>Alice Depot</li>
        <li>Makhanda / Grahamstown</li>
        <li>Gqeberha (Port Elizabeth)</li>
        <li>Pretoria (Main Depot)</li>
      </ul>
      <div class="mt-3 text-xs text-slate-500">
        No defaults — choose the nearest pickup depot at checkout for the most accurate quote.
      </div>
    </div>

    <div class="mt-4 text-xs text-slate-500">Delivery days: Wed–Sun. Windows: 08–10 • 12–14 • 16–18. If we can’t deliver, you’re refunded.</div>
  </div>
</section>

<!-- FAQ -->
<section id="faq" class="py-12 sm:py-16 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <h2 class="text-2xl sm:text-3xl font-bold">FAQ</h2>
    <div class="mt-6 grid md:grid-cols-2 gap-4">
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">How do I pay?</summary>
        <p class="mt-2 text-sm text-slate-700">
          We send a secure <b>Yoco card link</b> or <b>Ozow Instant EFT</b> via WhatsApp. Returning customers may use
          <b>50% deposit + COD</b> for the balance at delivery.
        </p>
      </details>
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">Cash on delivery?</summary>
        <p class="mt-2 text-sm text-slate-700">
          To keep orders safe, first-time customers pay online. For repeat customers, COD is available with a
          <b>50% deposit</b>. Drivers wait up to 5 minutes. Failed delivery forfeits the deposit.
        </p>
      </details>
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">Do you give medical advice?</summary>
        <p class="mt-2 text-sm text-slate-700">
          No. YiThume provides delivery only. Always follow your healthcare provider’s guidance.
        </p>
      </details>
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">Where do you operate?</summary>
        <p class="mt-2 text-sm text-slate-700">
          We’re <b>starting in the Eastern Cape</b> (Port Alfred, Bathurst, Kenton-on-Sea, Makhanda/Grahamstown, Alice, Alexandria, Alicedale)
          and <b>expanding to remote &amp; hard-to-reach areas nationwide</b>. If your town is hard to reach, we want to cover it.
        </p>
      </details>
    </div>
  </div>
</section>

<!-- Footer -->
<footer class="py-10 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div class="flex items-center gap-2">
        <!-- Mini Y logo in footer for consistency -->
        <svg width="24" height="24" viewBox="0 0 36 36" class="rounded-xl" aria-hidden="true">
          <defs>
            <linearGradient id="gf" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0%" stop-color="#10b981"/><stop offset="100%" stop-color="#059669"/>
            </linearGradient>
          </defs>
          <rect rx="8" width="36" height="36" fill="url(#gf)"/>
          <path d="M10 10h4l4 4 4-4h4l-8 8v8h-4v-8z" fill="#fff"/>
        </svg>
        <div>
          <div class="font-semibold">YiThume</div>
          <div class="text-xs text-slate-500">
            Delivery service only • POPIA compliant • © <span id="year"></span>
          </div>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row gap-3">
        <button id="openOrderBuilderFooter"
          class="px-3 py-2 text-sm rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
          Start order
        </button>
        <button id="openDriverModalFooter"
          class="px-3 py-2 text-sm rounded-xl border border-slate-300 hover:bg-slate-100">
          Driver sign-in / up
        </button>
        <button id="openStoreModalFooter"
          class="px-3 py-2 text-sm rounded-xl border border-emerald-300 text-emerald-700 hover:bg-emerald-50">
          Add your store
        </button>
      </div>
    </div>
  </div>
</footer>

<!-- Driver Auth Modal -->
<div id="driverModal"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[9999] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="driverModalTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-md flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold">
        <div id="driverModalTitle">Driver Portal</div>
        <div class="text-xs text-slate-500">Get paid weekly per drop</div>
      </div>
      <button id="closeDriverModal" class="text-slate-500 hover:text-slate-700" aria-label="Close driver modal">✕</button>
    </div>

    <div class="p-4 text-sm">
      <div class="flex gap-2 mb-4" role="tablist" aria-label="Driver auth tabs">
        <button id="tabSignup" class="flex-1 py-2 text-center rounded-lg bg-emerald-600 text-white" role="tab" aria-selected="true">Sign up</button>
        <button id="tabLogin"  class="flex-1 py-2 text-center rounded-lg border border-slate-300" role="tab" aria-selected="false">Log in</button>
      </div>

      <!-- Signup form -->
      <form id="driverFormSignup" class="space-y-3" aria-label="Driver signup form">
        <label class="block">
          <div class="text-xs font-medium text-slate-600">Full Name</div>
          <input id="drvName" class="mt-1 w-full border rounded-lg p-2" placeholder="Name" required />
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">WhatsApp Number</div>
          <input id="drvPhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required />
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">Your Zone</div>
          <select id="drvZone" class="mt-1 w-full border rounded-lg p-2">
            <option value="A">Zone A – Port Alfred</option>
            <option value="B">Zone B – Bathurst</option>
            <option value="C">Zone C – Kenton</option>
            <option value="D">Zone D – Makhanda / Grahamstown / Alice</option>
            <option value="E">Zone E – Alexandria / Alicedale</option>
          </select>
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">How far you’ll drive (km)</div>
          <input id="drvRadius" type="number" min="1" class="mt-1 w-full border rounded-lg p-2" value="10" />
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">Vehicle (car, bakkie, scooter, etc.)</div>
          <input id="drvVehicle" class="mt-1 w-full border rounded-lg p-2" placeholder="e.g. Polo Vivo" />
        </label>

        <button type="submit" class="w-full py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700">
          Submit
        </button>
      </form>

      <!-- Login form -->
      <form id="driverFormLogin" class="space-y-3 hidden" aria-label="Driver login form">
        <label class="block">
          <div class="text-xs font-medium text-slate-600">WhatsApp Number</div>
          <input id="drvLoginPhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required />
        </label>

        <button type="submit" class="w-full py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700">
          Log in
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Driver Dashboard Modal (Demo) -->
<div id="driverDashModal"
     class="fixed inset-0 hidden items-start justify-center pt-12 sm:pt-16 bg-black/40 p-4 z-[10000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="driverDashTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-md flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold">
        <div id="driverDashTitle">Driver Dashboard</div>
        <div class="text-xs text-slate-500">Your current stats</div>
      </div>
      <button id="closeDriverDash" class="text-slate-500 hover:text-slate-700" aria-label="Close driver dashboard modal">✕</button>
    </div>

    <div class="p-4 text-sm space-y-3">
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Pending balance</div>
        <div class="text-lg font-semibold">R<span id="driverPayoutPending">0</span></div>
        <div class="text-[11px] text-slate-500 leading-snug">
          You’ve accepted these drops. Waiting for admin approval.
        </div>
      </div>
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Approved payout</div>
        <div class="text-lg font-semibold">R<span id="driverPayoutApproved">0</span></div>
        <div class="text-[11px] text-slate-500 leading-snug">
          Will be paid to you by EFT.
        </div>
      </div>
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Next delivery window</div>
        <div class="text-lg font-semibold" id="driverNextWindow">Fri 17:00</div>
      </div>
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Your zone / km radius</div>
        <div class="text-lg font-semibold">
          <span id="driverZoneDisplay">A</span> / <span id="driverRadiusDisplay">10km</span>
        </div>
      </div>
      <div class="text-[11px] text-slate-500 leading-snug">
        Drivers are paid weekly by EFT.
      </div>
    </div>
  </div>
</div>

<!-- Bot-style Checkout Modal -->
<div id="botChat"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[9500] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="botChatTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-md flex flex-col max-h-[80vh] outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="botChatTitle">Checkout</span>
        <span class="text-xs text-slate-500">We’ll confirm in WhatsApp</span>
      </div>
      <button id="closeBot" class="text-slate-500 hover:text-slate-700" aria-label="Close checkout modal">✕</button>
    </div>

    <div id="botFeed" class="flex-1 overflow-y-auto p-4 space-y-2 text-sm bg-slate-50" aria-live="polite"></div>

    <div class="p-4 border-t space-y-3 text-sm">
      <label class="block">
        <div class="text-xs font-medium text-slate-600">Payment method</div>
        <select id="botPayChoice" class="mt-1 w-full border rounded-lg p-2" aria-label="Payment method">
          <option value="card">Card (Yoco link)</option>
          <option value="eft">Instant EFT (Ozow)</option>
          <option value="deposit_cod">50% deposit + COD</option>
        </select>
      </label>

      <div class="flex flex-wrap gap-2">
        <button id="botNext" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700">
          Pay
        </button>
        <!-- Renamed label only (keep id for scripts) -->
        <button id="botSendWA" class="flex-1 py-2 rounded-xl border border-slate-300 font-medium hover:bg-slate-100 hidden">
          Contact support
        </button>
        <button id="botNewOrder" class="flex-1 py-2 rounded-xl border border-slate-300 font-medium hover:bg-slate-100 hidden">
          New order
        </button>
      </div>

      <div class="text-[11px] text-slate-500 leading-snug" id="botDemoNote" hidden>
        No money is taken — this is a demo. We’ll WhatsApp a real secure link.
      </div>
    </div>
  </div>
</div>

<!-- FAKE Payment Modal -->
<div id="payModal"
     class="fixed inset-0 hidden items-start justify-center pt-20 bg-black/60 p-4 z-[9600] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="payModalTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-sm flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="payModalTitle">Secure Payment (Demo)</span>
        <span class="text-xs text-slate-500">This is a preview — no real charge yet</span>
      </div>
      <button id="closePayModal" class="text-slate-500 hover:text-slate-700" aria-label="Close payment modal">✕</button>
    </div>

    <div class="p-4 text-sm space-y-2">
      <div><b>Order Ref:</b> <span id="payOrderRef">--</span></div>
      <div><b>Amount:</b> R<span id="payAmount">0</span></div>
      <div class="text-[11px] text-slate-500 leading-snug">
        We’ll send the real Yoco / Ozow payment link in WhatsApp once confirmed.
      </div>
      <div class="text-[11px] text-emerald-700 leading-snug font-medium">
        No money is taken here. This is just a demo.
      </div>
    </div>

    <div class="p-4 border-t flex flex-col sm:flex-row gap-2 text-sm">
      <button id="btnFakePayNow" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
        Pay
      </button>
      <button id="btnCancelPay" class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Order Builder Modal -->
<div id="orderBuilder"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[9000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="orderBuilderTitle">
  <div class="w-full max-w-xl rounded-2xl bg-white shadow-xl border flex flex-col max-h-[85vh] outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="orderBuilderTitle">Your Order</span>
        <span class="text-xs text-slate-500">We’ll confirm by WhatsApp</span>
      </div>
      <button id="closeOrderBuilder" class="text-slate-500 hover:text-slate-700" aria-label="Close order builder modal">✕</button>
    </div>

    <div class="flex-1 overflow-y-auto p-4 space-y-5 text-sm">
      <!-- Items list -->
      <div>
        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-600 font-medium">Items</div>
          <button id="addCustomItem" class="text-[11px] text-emerald-700 underline">+ Add custom</button>
        </div>
        <div id="itemsList" class="mt-2 grid gap-2"></div>
      </div>

      <!-- Pickup depot (no default; JS will populate) -->
      <div>
        <label class="block text-xs text-slate-600 font-medium">Pickup depot</label>
        <select id="zoneSelect" class="mt-1 w-full border rounded-lg p-2" aria-label="Pickup depot">
          <!-- Options injected by JS (no default) -->
        </select>
        <div class="flex items-center gap-2 mt-2">
          <input id="rushToggle" type="checkbox" class="h-4 w-4" />
          <label for="rushToggle" class="text-xs text-slate-600">
            Rush (+R30 when available)<span id="rushNote" class="text-[10px] text-amber-700"></span>
          </label>
        </div>
      </div>

      <!-- Customer details -->
      <div class="grid sm:grid-cols-2 gap-3">
        <label class="block">
          <div class="text-xs text-slate-600 font-medium">Your name</div>
          <input id="custName" class="mt-1 w-full border rounded-lg p-2" placeholder="Full name" required />
        </label>
        <label class="block">
          <div class="text-xs text-slate-600 font-medium">WhatsApp number</div>
          <input id="custPhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required />
        </label>
      </div>

      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Delivery address</div>
        <textarea id="custAddress" class="mt-1 w-full border rounded-lg p-2" rows="2" placeholder="House number, street, area" required></textarea>
      </label>

      <!-- Payment choice -->
      <div>
        <div class="text-xs text-slate-600 font-medium mb-1">How will you pay?</div>
        <div class="space-y-2">
          <label class="flex items-start gap-2">
            <input type="radio" name="pay" value="card" class="mt-1" checked>
            <div>
              <div class="text-sm font-medium">Card link (Yoco)</div>
              <div class="text-[11px] text-slate-500">Tap and pay from your phone.</div>
            </div>
          </label>

          <label class="flex items-start gap-2">
            <input type="radio" name="pay" value="eft" class="mt-1">
            <div>
              <div class="text-sm font-medium">Instant EFT (Ozow)</div>
              <div class="text-[11px] text-slate-500">Instant secure bank transfer.</div>
            </div>
          </label>

          <label class="flex items-start gap-2">
            <input type="radio" name="pay" value="deposit_cod" class="mt-1">
            <div>
              <div class="text-sm font-medium">50% deposit + COD</div>
              <div class="text-[11px] text-slate-500">Returning customers only.</div>
            </div>
          </label>
        </div>
      </div>

      <!-- Deposit banner -->
      <div id="depositBanner"
           class="hidden rounded-lg border border-amber-300 bg-amber-50 text-amber-800 text-[11px] leading-snug p-2">
        You’ll pay a deposit of R<span id="depositAmt">0</span> to lock your driver. Balance on delivery.
      </div>

      <!-- Total -->
      <div class="rounded-xl bg-slate-50 border p-3 text-sm flex flex-col gap-2">
        <div class="flex justify-between">
          <div>Total to pay now</div>
          <div class="font-semibold">R<span id="orderTotal">0</span></div>
        </div>
        <div class="text-[11px] text-slate-500 leading-snug">
          We’ll confirm and send a payment link on WhatsApp. If we can’t deliver, you’re refunded.
        </div>
      </div>
    </div>

    <div class="p-4 border-t flex flex-col sm:flex-row gap-2 text-sm">
      <button id="confirmOrderBtn"
              class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
        Confirm &amp; Continue
      </button>
      <button class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100" id="cancelOrderBuilder">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Orders Panel (Admin) -->
<div id="ordersPanel"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[11000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="ordersPanelTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-4xl flex flex-col outline-none" tabindex="-1">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b yt-sticky yt-sticky-top">
      <div class="font-semibold flex flex-col">
        <span id="ordersPanelTitle">Orders Admin</span>
        <span class="text-xs text-slate-500">Assign drivers • Mark delivered</span>
      </div>
      <button id="closeOrdersPanel" class="text-slate-500 hover:text-slate-700" aria-label="Close admin panel">✕</button>
    </div>

    <!-- Tabs (injected by JS) -->
    <div id="ordersTabs" class="p-3 border-b yt-sticky yt-sticky-top flex flex-wrap gap-2 text-xs" role="tablist" aria-label="Order status filter">
      <!-- JS will inject tab buttons -->
    </div>

    <!-- Scrollable body (orders + drivers + stats; toggled by JS tabs) -->
    <div class="yt-modal-body">
      <!-- Orders list (populated by JS) -->
      <div class="p-4 space-y-4 text-sm" id="ordersList" aria-live="polite"></div>

      <!-- Drivers section (shown when Drivers tab active; populated by JS) -->
      <div class="px-4 pb-4 space-y-3">
        <div class="flex gap-2">
          <button id="driversRefresh" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 text-sm">
            Drivers refresh
          </button>
        </div>
        <div id="driversList" class="divide-y divide-slate-200 rounded-xl border text-sm"></div>
      </div>

      <!-- Stats section -->
      <div id="statsContainer" class="px-4 pb-4 space-y-3 hidden"></div>
    </div>

    <!-- Sticky footer actions -->
    <div class="p-4 border-t yt-sticky yt-sticky-bottom">
      <div class="flex flex-col sm:flex-row gap-2 text-sm">
        <button id="ordersRefresh" class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">
          Refresh
        </button>
        <button id="ordersAssign" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
          Auto assign all
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Store Onboarding Modal -->
<div id="storeModal"
     class="fixed inset-0 hidden items-start justify-center pt-12 sm:pt-16 bg-black/40 p-4 z-[12000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="storeModalTitle">
  <div class="w-full max-w-xl rounded-2xl bg-white shadow-xl border flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="storeModalTitle">Add Your Store</span>
        <span class="text-xs text-slate-500">We’ll list your items for delivery</span>
      </div>
      <button id="closeStoreModal" class="text-slate-500 hover:text-slate-700" aria-label="Close store modal">✕</button>
    </div>

    <div class="p-4 space-y-4 text-sm">
      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Store name</div>
        <input id="storeName" class="mt-1 w-full border rounded-lg p-2" placeholder="e.g. Bathurst Health Shop" required>
      </label>

      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Store WhatsApp</div>
        <input id="storePhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required>
      </label>

      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Zone</div>
        <select id="storeZone" class="mt-1 w-full border rounded-lg p-2">
          <option value="A">Zone A – Port Alfred</option>
          <option value="B">Zone B – Bathurst</option>
          <option value="C">Zone C – Kenton / Bushmans</option>
          <option value="D">Zone D – Makhanda / Eirini</option>
          <option value="E">Zone E – Alexandria / Alicedale</option>
        </select>
      </label>

      <div>
        <div class="text-xs text-slate-600 font-medium mb-2 flex items-center justify-between">
          <span>Items you sell</span>
          <button id="addStoreItem" class="text-emerald-700 underline text-[11px]">+ Add item</button>
        </div>
        <div id="storeItemsList" class="space-y-2"></div>
      </div>

      <div class="rounded-lg bg-slate-50 border p-2 text-[11px] text-slate-600 leading-snug">
        We'll review and then list your store so people can buy through YiThume and get same-day local delivery.
      </div>
    </div>

    <div class="p-4 border-t flex flex-col sm:flex-row gap-2 text-sm">
      <button id="submitStore" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
        Submit store
      </button>
      <button id="cancelStore" class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">
        Cancel
      </button>
    </div>
  </div>
</div>
<script>
window.addEventListener('DOMContentLoaded', () => {
// ========================================================================
// CONFIG & GLOBALS
// ========================================================================
const BASE_API = "/api/app";
const WHATSAPP_NUMBER = "270691456201";
const ADMIN_WHATSAPP = "270691456201";
const ADMIN_PASS = "1234";

const DEMO_MODE = false; // true = local demo mode

const BASE_DELIVERY_FEE = 15;
const PER_KM_PRICE = 8;
const RUSH_FEE = 30;

const LS_ORDERS = "YT_DEMO_ORDERS_V1";
const LS_DRIVERS = "YT_DEMO_DRIVERS_V1";

const emerald = { 600:'#059669', 500:'#10b981', 400:'#34d399' };

// ========================================================================
// HELPERS
// ========================================================================
const waText = (str) => encodeURIComponent(str);
const digits = (val) => (val || "").replace(/\D+/g, "");
const clamp = (v,lo,hi)=> Math.min(hi, Math.max(lo, v));
const pad2 = (n)=> String(n).padStart(2,'0');

const kmBetween = (a,b)=>{
  if(!a||!b) return 0;
  const R = 6371;
  const dLat = (b.lat-a.lat)*Math.PI/180;
  const dLng = (b.lng-a.lng)*Math.PI/180;
  const s1 = Math.sin(dLat/2)**2 +
    Math.cos(a.lat*Math.PI/180) *
    Math.cos(b.lat*Math.PI/180) *
    Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s1));
};

function salesSafe(str){
  return (str || '').toString().replace(/[<>&]/g, c => (
    c === '<' ? '&lt;' : c === '>' ? '&gt;' : '&amp;'
  ));
}

// ========================================================================
// BODY SCROLL LOCK + FOCUS RESTORE
// ========================================================================
const lastFocus = new Map();
const firstFocusable = (el) =>
  el?.querySelector?.('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
const lockScroll = () => document.body.classList.add('overflow-locked');
const unlockScroll = () => document.body.classList.remove('overflow-locked');

function openFlex(el){
  if(!el) return;
  lastFocus.set(el, document.activeElement);
  el.classList.remove('hidden');
  el.classList.add('flex');
  lockScroll();
  setTimeout(()=>{
    const ff = firstFocusable(el);
    if(ff) ff.focus();
  }, 0);
}
function closeFlex(el){
  if(!el) return;
  el.classList.add('hidden');
  el.classList.remove('flex');
  unlockScroll();
  const prev = lastFocus.get(el);
  if(prev && typeof prev.focus === 'function') prev.focus();
}

document.addEventListener('keydown', (e)=>{
  if(e.key !== 'Escape') return;
  const modals = [
    document.getElementById('ordersPanel'),
    document.getElementById('storeModal'),
    document.getElementById('driverDashModal'),
    document.getElementById('driverModal'),
    document.getElementById('payModal'),
    document.getElementById('botChat'),
    document.getElementById('orderBuilder')
  ];
  for(const m of modals){
    if(m && !m.classList.contains('hidden')) { closeFlex(m); break; }
  }
});

// ========================================================================
// RUNTIME / GLOBAL STATE
// ========================================================================
let latestOrderData = null;
let botStage = 0;

const currentOrdersByTab = {};
let ALL_ORDERS_MAP = {}; // _internal_id -> order
let DEMO_ORDERS_DB = {};
let DEMO_DRIVERS_DB = {};

let API_DRIVERS_MAP = {}; // driver_id/_internal_id -> driver
let DRIVERS = []; // for stats & drivers cards
let DRIVERS_BY_ID = {};

let REMOTE_STATS = null;

const driverTotals = { pending: 0, approved: 0 };

let DELIVERY_COORDS = null;
let COLLECTION_COORDS = {lat:-33.590, lng:26.890};

const storeItems = [];

// Admin stats DOM refs
let adminStatsOrdersEl,
    adminStatsRevenueEl,
    adminTopProductsEl,
    adminTopAreasEl,
    adminDriversCountEl,
    adminPayPendingEl,
    adminPayApprovedEl;

// ========================================================================
// YEAR
// ========================================================================
const yearEl = document.getElementById('year');
if (yearEl) yearEl.textContent = new Date().getFullYear();

// ========================================================================
// ELEMENT REFS
// ========================================================================
const mobileBtn = document.getElementById('mobileMenuBtn');
const mobileDropdown = document.getElementById('mobileNavDropdown');
const mobileIconOpen = document.getElementById('mobileMenuIconOpen');
const mobileIconClose = document.getElementById('mobileMenuIconClose');

const modal = document.getElementById('orderBuilder');
const closeBtn = document.getElementById('closeOrderBuilder');
const cancelOrderBuilder = document.getElementById('cancelOrderBuilder');
const itemsList = document.getElementById('itemsList');

const zoneSelect = document.getElementById('zoneSelect');
const rushToggle = document.getElementById('rushToggle');
const totalEl = document.getElementById('orderTotal');
const rushNote = document.getElementById('rushNote');
const depositBanner = document.getElementById('depositBanner');
const depositAmtEl = document.getElementById('depositAmt');
const custNameEl = document.getElementById('custName');
const custPhoneEl = document.getElementById('custPhone');
const custAddrEl = document.getElementById('custAddress');

const adminBtn = document.getElementById('adminLoginBtn');

const confirmBtn2 = document.getElementById('confirmOrderBtn');
const botModal = document.getElementById('botChat');
const botFeed = document.getElementById('botFeed');
const botNext = document.getElementById('botNext');
const botSendWA = document.getElementById('botSendWA');
const botNewOrder = document.getElementById('botNewOrder');
const botPayChoice = document.getElementById('botPayChoice');
const botDemoNote = document.getElementById('botDemoNote');

const payModal = document.getElementById('payModal');
const payOrderRef = document.getElementById('payOrderRef');
const payAmountEl = document.getElementById('payAmount');
const closePayModalBtn = document.getElementById('closePayModal');
const btnFakePayNow = document.getElementById('btnFakePayNow');
const btnCancelPay = document.getElementById('btnCancelPay');

const driverModal = document.getElementById('driverModal');
const closeDriver = document.getElementById('closeDriverModal');
const tabSignup = document.getElementById('tabSignup');
const tabLogin = document.getElementById('tabLogin');
const formSignup = document.getElementById('driverFormSignup');
const formLogin = document.getElementById('driverFormLogin');

const driverDashModal = document.getElementById('driverDashModal');
const closeDriverDash = document.getElementById('closeDriverDash');
const driverPayoutPendingEl = document.getElementById('driverPayoutPending');
const driverPayoutApprovedEl = document.getElementById('driverPayoutApproved');
const driverNextWindowEl = document.getElementById('driverNextWindow');
const driverZoneDisplayEl = document.getElementById('driverZoneDisplay');
const driverRadiusDisplayEl = document.getElementById('driverRadiusDisplay');

const ordersPanel = document.getElementById('ordersPanel');
const ordersList = document.getElementById('ordersList');
const ordersClose = document.getElementById('closeOrdersPanel');
const ordersAssign = document.getElementById('ordersAssign');
const ordersRefresh = document.getElementById('ordersRefresh');

const driversList = document.getElementById('driversList');
const driversRefresh = document.getElementById('driversRefresh');

const ordersTabsContainer = document.getElementById('ordersTabs');
let statsContainer = document.getElementById('statsContainer'); // created if missing

const storeModal = document.getElementById('storeModal');
const openStoreFooter = document.getElementById('openStoreModalFooter');
const closeStoreModalBtn = document.getElementById('closeStoreModal');
const cancelStoreBtn = document.getElementById('cancelStore');
const submitStoreBtn = document.getElementById('submitStore');
const addStoreItemBtn = document.getElementById('addStoreItem');
const storeItemsList = document.getElementById('storeItemsList');
const storeNameEl = document.getElementById('storeName');
const storePhoneEl = document.getElementById('storePhone');
const storeZoneEl = document.getElementById('storeZone');

// ========================================================================
// COLLECTION POINTS
// ========================================================================
const COLLECTIONS = [
  { id:'DEPOT-PA',  name:'Port Alfred Depot',         lat:-33.590, lng:26.890 },
  { id:'DEPOT-KENT',name:'Kenton-on-Sea Depot',       lat:-33.686, lng:26.668 },
  { id:'DEPOT-GHT', name:'Makhanda / Grahamstown',    lat:-33.310, lng:26.520 },
  { id:'DEPOT-ALC', name:'Alice Depot',               lat:-32.789, lng:26.834 },
  { id:'DEPOT-GQ',  name:'Gqeberha (Port Elizabeth)', lat:-33.958, lng:25.602 },
  { id:'DEPOT-PTA', name:'Pretoria (Main Depot)',     lat:-25.746, lng:28.188 }
];

function ensureCollectionSelectPopulated(){
  if(!zoneSelect) return;
  if(zoneSelect.dataset.enhanced === '1') return;
  zoneSelect.innerHTML = '';
  COLLECTIONS.forEach((c,i)=>{
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    opt.dataset.lat = String(c.lat);
    opt.dataset.lng = String(c.lng);
    if(i===0){
      opt.selected = true;
      COLLECTION_COORDS = {lat:c.lat, lng:c.lng};
    }
    zoneSelect.appendChild(opt);
  });
  zoneSelect.dataset.enhanced = '1';
}

// ========================================================================
// CATALOG
// ========================================================================
const CATALOG = [
  {name:'Panado 500mg (24s)', price:35},
  {name:'Allergex 10mg (10s)',price:30},
  {name:'Cough Syrup 100ml',  price:55},
  {name:'Electrolyte Sachet', price:15},
  {name:'Bandages (set)',     price:25}
];

// ========================================================================
// DEMO PERSISTENCE
// ========================================================================
function saveOrdersToLS(){
  try{ localStorage.setItem(LS_ORDERS, JSON.stringify(DEMO_ORDERS_DB)); }catch(_){}
}
function saveDriversToLS(){
  try{ localStorage.setItem(LS_DRIVERS, JSON.stringify(DEMO_DRIVERS_DB)); }catch(_){}
}
function loadOrdersFromLS(){
  let parsed=null;
  try{ parsed = JSON.parse(localStorage.getItem(LS_ORDERS)||'null'); }catch(_){}
  return (parsed && typeof parsed==='object') ? parsed : null;
}
function loadDriversFromLS(){
  let parsed=null;
  try{ parsed = JSON.parse(localStorage.getItem(LS_DRIVERS)||'null'); }catch(_){}
  return (parsed && typeof parsed==='object') ? parsed : null;
}

function seedIfEmpty(){
  if(!DEMO_DRIVERS_DB || Object.keys(DEMO_DRIVERS_DB).length===0){
    DEMO_DRIVERS_DB = {
      "DRV-100001": {
        driver_id:"DRV-100001", name:"Sipho N", phone:"27810000001", vehicle:"Bike",
        stats:{assigned:0,in_transit:0,delivered:0}, payout_pending:0, payout_approved:0
      },
      "DRV-100002": {
        driver_id:"DRV-100002", name:"Anele M", phone:"27810000002", vehicle:"Car",
        stats:{assigned:0,in_transit:0,delivered:0}, payout_pending:0, payout_approved:0
      },
      "DRV-100003": {
        driver_id:"DRV-100003", name:"Thandi D", phone:"27810000003", vehicle:"Car",
        stats:{assigned:0,in_transit:0,delivered:0}, payout_pending:0, payout_approved:0
      }
    };
  }
  if(!DEMO_ORDERS_DB || Object.keys(DEMO_ORDERS_DB).length===0){
    const o = (id, total, delivery_fee, status, driver_id=null) => ({
      _internal_id: id,
      order_id: id.replace("demo-","YI-").toUpperCase(),
      order_public_id: id.toUpperCase(),
      status,
      total,
      delivery_fee,
      items: [
        {name:"Panado 500mg (24s)",qty:1},
        {name:"Cough Syrup 100ml",qty:1}
      ],
      meta: { collection_name: 'Port Alfred Depot', distance_km: 3.2 },
      fraud_score: 0.04,
      driver_id,
      driver_pay_status: status === 'delivered' ? 'approved' : 'pending',
      driver_pay_pending: status === 'delivered' ? 0 : clamp(delivery_fee,25,45),
      driver_pay_approved: status === 'delivered' ? clamp(delivery_fee,25,45) : 0
    });
    DEMO_ORDERS_DB = {
      "demo-abc123": o("demo-abc123",180,35,"pending",   "DRV-100001"),
      "demo-def456": o("demo-def456",240,45,"assigned",  "DRV-100002"),
      "demo-ghi789": o("demo-ghi789",120,25,"in_transit","DRV-100002"),
      "demo-jkl012": o("demo-jkl012",220,30,"delivered", "DRV-100003")
    };
  }
}

function hydrateState(){
  if(DEMO_MODE){
    const o = loadOrdersFromLS();
    const d = loadDriversFromLS();
    DEMO_ORDERS_DB = o || {};
    DEMO_DRIVERS_DB = d || {};
    seedIfEmpty();

    Object.values(DEMO_DRIVERS_DB).forEach(dr=>{
      dr.stats = {assigned:0,in_transit:0,delivered:0};
      dr.payout_pending = 0;
      dr.payout_approved= 0;
    });
    Object.values(DEMO_ORDERS_DB).forEach(ord=>{
      const did = ord.driver_id;
      if(did && DEMO_DRIVERS_DB[did]){
        const dr = DEMO_DRIVERS_DB[did];
        if(ord.status === 'assigned')    dr.stats.assigned++;
        if(ord.status === 'in_transit')  dr.stats.in_transit++;
        if(ord.status === 'delivered')   dr.stats.delivered++;
        if(ord.driver_pay_status === 'pending')
          dr.payout_pending += (ord.driver_pay_pending||0);
        if(ord.driver_pay_status === 'approved')
          dr.payout_approved += (ord.driver_pay_approved||0);
      }
    });
    saveOrdersToLS();
    saveDriversToLS();
  }
}
hydrateState();

// ========================================================================
// CUSTOMER UI: items + totals
// ========================================================================
function renderItems(){
  if(!itemsList) return;
  itemsList.innerHTML = '';
  CATALOG.forEach((item,idx)=>{
    const row=document.createElement('div');
    row.className='flex items-center justify-between gap-3 border rounded-lg p-2';
    row.innerHTML = `
<label class="flex items-center gap-2">
  <input type="checkbox" data-idx="${idx}" class="itemCheck h-4 w-4" aria-label="Select ${item.name}"/>
  <span>${item.name}</span>
</label>
<div class="flex items-center gap-2">
  <span class="text-slate-500">R${item.price}</span>
  <input
    type="number"
    min="1"
    value="1"
    aria-label="Quantity for ${item.name}"
    data-idx="${idx}"
    class="itemQty w-14 border rounded-lg p-1"
  />
</div>`;
    itemsList.appendChild(row);
  });
}

document.getElementById('addCustomItem')?.addEventListener('click', ()=>{
  const name = prompt('Item name?');
  if(!name) return;
  const p = Number(prompt('Price (R)?'));
  if(!Number.isFinite(p) || p<=0) return;
  CATALOG.push({name,price:p});
  renderItems();
});

const selectedPay = () => {
  const el = document.querySelector('input[name="pay"]:checked');
  return el ? el.value : 'card';
};

function tryGetCustomerCoords(){
  return new Promise((resolve)=>{
    if(!navigator.geolocation){ return resolve(null); }
    navigator.geolocation.getCurrentPosition(
      pos=> resolve({lat:pos.coords.latitude, lng:pos.coords.longitude}),
      ()=> resolve(null),
      { enableHighAccuracy:true, timeout:2500 }
    );
  });
}

async function osrmDistanceMeters(a,b){
  try{
    const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=false`;
    const r = await fetch(url);
    const j = await r.json();
    const meters = j?.routes?.[0]?.distance;
    if(Number.isFinite(meters)){ return meters; }
  }catch(_){}
  return kmBetween(a,b)*1000;
}

async function computeTotal(){
  ensureCollectionSelectPopulated();

  if(!totalEl || !rushNote){
    return {
      items:[], itemsTotal:0, fee:0, rush:0, total:0,
      collectionName:'Port Alfred Depot',
      hubLat:COLLECTION_COORDS.lat, hubLng:COLLECTION_COORDS.lng, distanceKm:0
    };
  }

  const items = Array.from(document.querySelectorAll('.itemCheck'))
    .filter(c => c.checked)
    .map(c => {
      const i = Number(c.dataset.idx);
      const qtyInput = document.querySelector(`.itemQty[data-idx="${i}"]`);
      const qty = Math.max(1, Number(qtyInput?.value || 1));
      return { name: CATALOG[i].name, price: Number(CATALOG[i].price), qty };
    });

  const itemsTotal = items.reduce((sum,it)=> sum + (it.price * it.qty), 0);

  const opt = zoneSelect?.options?.[zoneSelect.selectedIndex] || {};
  const hubLat = Number(opt?.dataset?.lat ?? COLLECTION_COORDS.lat);
  const hubLng = Number(opt?.dataset?.lng ?? COLLECTION_COORDS.lng);
  const collectionName = opt?.textContent || 'Port Alfred Depot';
  COLLECTION_COORDS = {lat:hubLat, lng:hubLng};

  if(!DELIVERY_COORDS){
    DELIVERY_COORDS = await tryGetCustomerCoords();
  }

  let distanceKm = 0;
  if(DELIVERY_COORDS){
    const meters = await osrmDistanceMeters(COLLECTION_COORDS, DELIVERY_COORDS);
    distanceKm = Math.max(0, meters/1000);
  } else {
    distanceKm = 3;
  }

  const rushFee = rushToggle?.checked ? RUSH_FEE : 0;
  rushNote.textContent = rushFee ? ' + rush' : '';

  const deliveryFee = Math.round(BASE_DELIVERY_FEE + (PER_KM_PRICE * distanceKm));
  const total = itemsTotal + deliveryFee + rushFee;
  totalEl.textContent = String(total);

  return {
    items, itemsTotal,
    fee: deliveryFee,
    rush: rushFee,
    total,
    collectionName,
    hubLat, hubLng,
    distanceKm
  };
}

function nextETA(rush){
  const now = new Date();
  const windows = [[8,10],[12,14],[16,18]];
  const allowed = new Set([0,3,4,5,6]);
  const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  const fmt = (date,[h1,h2])=>{
    const sameDay = (date.toDateString()===new Date().toDateString());
    if (sameDay){
      return `${pad2(h1)}:00–${pad2(h2)}:00 ${rush?'today (rush)':'today'}`;
    }
    return `${dayNames[date.getDay()]} ${pad2(h1)}:00–${pad2(h2)}:00`;
  };

  if (allowed.has(now.getDay())){
    for(const w of windows){
      if(now.getHours()<w[1]) return fmt(now,w);
    }
  }
  for(let i=1;i<=7;i++){
    const d = new Date(now);
    d.setDate(now.getDate()+i);
    if(allowed.has(d.getDay())){
      return fmt(d,windows[0]);
    }
  }
  return 'TBC';
}

function toggleDepositBanner(total){
  const pay=selectedPay();
  if(!depositBanner || !depositAmtEl) return;
  if(pay==='deposit_cod'){
    depositAmtEl.textContent = Math.ceil(total*0.5);
    depositBanner.classList.remove('hidden');
  } else {
    depositBanner.classList.add('hidden');
  }
}

// ========================================================================
// MODALS & NAV
// ========================================================================
const openOrder = async ()=>{
  openFlex(modal);
  const s = await computeTotal();
  toggleDepositBanner(s.total);
};
const closeOrder = ()=> closeFlex(modal);

const openBot = ()=>{
  botStage = 0;
  if(!botNext || !botSendWA || !botNewOrder || !botDemoNote || !botFeed) return;
  botNext.disabled = false;
  botNext.textContent = "Pay";
  botSendWA.classList.add('hidden');
  botNewOrder.classList.add('hidden');
  botDemoNote.hidden = true;
  botFeed.innerHTML = "";
  openFlex(botModal);
};
const closeBot = ()=>{
  if(botFeed) botFeed.innerHTML='';
  closeFlex(botModal);
};

const openPayModal = (orderRef, amount)=>{
  if(!payModal) return;
  if(payOrderRef) payOrderRef.textContent = orderRef || '--';
  if(payAmountEl) payAmountEl.textContent = amount || '0';
  openFlex(payModal);
};
const closePayModal = ()=> closeFlex(payModal);

const openDriverWindow = ()=> openFlex(driverModal);
const closeDriverWindow = ()=> closeFlex(driverModal);

const openStore = ()=> openFlex(storeModal);
const closeStore= ()=> closeFlex(storeModal);

let ordersTab = 'pending';

const openOrders = ()=>{
  if(!ordersPanel) return;
  openFlex(ordersPanel);
  ensureAdminTabs();
  setActiveAdminTab(ordersTab);
  refreshAllData();
};
const closeOrders= ()=> closeFlex(ordersPanel);

const openDriverDash = ()=>{
  if(driverPayoutPendingEl) driverPayoutPendingEl.textContent = String(driverTotals.pending);
  if(driverPayoutApprovedEl) driverPayoutApprovedEl.textContent = String(driverTotals.approved);
  openFlex(driverDashModal);
};
const closeDriverDashWindow = ()=> closeFlex(driverDashModal);

function appendBot(msg,who='bot'){
  if(!botFeed) return;
  const wrap=document.createElement('div');
  wrap.className = `flex ${who==='bot'?'justify-start':'justify-end'}`;
  wrap.innerHTML = `
<div class="max-w-[80%] rounded-2xl px-3 py-2 text-sm ${who==='bot'?'bg-slate-100':'bg-emerald-600 text-white'}">
  ${msg}
</div>`;
  botFeed.appendChild(wrap);
  botFeed.scrollTop = botFeed.scrollHeight;
}

// ========================================================================
// MOBILE NAV
// ========================================================================
function toggleMobileMenu() {
  if(!mobileDropdown || !mobileBtn || !mobileIconOpen || !mobileIconClose) return;
  const isHidden = mobileDropdown.classList.contains('hidden');
  if (isHidden) {
    mobileDropdown.classList.remove('hidden');
    mobileIconOpen.classList.add('hidden');
    mobileIconClose.classList.remove('hidden');
    mobileBtn.setAttribute('aria-expanded', 'true');
  } else {
    mobileDropdown.classList.add('hidden');
    mobileIconOpen.classList.remove('hidden');
    mobileIconClose.classList.add('hidden');
    mobileBtn.setAttribute('aria-expanded', 'false');
  }
}
mobileBtn?.addEventListener('click', toggleMobileMenu);

document.querySelectorAll('#mobileNavDropdown .mobile-nav-link').forEach(el => {
  el.addEventListener('click', () => {
    if(!mobileDropdown || !mobileBtn || !mobileIconOpen || !mobileIconClose) return;
    mobileDropdown.classList.add('hidden');
    mobileIconOpen.classList.remove('hidden');
    mobileIconClose.classList.add('hidden');
    mobileBtn.setAttribute('aria-expanded', 'false');
  });
});

document.getElementById('openOrderBuilderTopMobile')?.addEventListener('click', ()=>{
  document.getElementById('openOrderBuilder')?.click();
});
document.getElementById('openDriverModalTopMobile')?.addEventListener('click', ()=>{
  document.getElementById('openDriverModal')?.click();
});
document.getElementById('adminLoginBtnMobile')?.addEventListener('click', ()=>{
  adminBtn?.click();
});
document.getElementById('openDriverModalSection')?.addEventListener('click', ()=>{
  document.getElementById('openDriverModal')?.click();
});

// ========================================================================
// INIT CUSTOMER UI
// ========================================================================
renderItems();
ensureCollectionSelectPopulated();
computeTotal();

zoneSelect?.addEventListener('change', async ()=>{
  const s = await computeTotal(); toggleDepositBanner(s.total);
});
rushToggle?.addEventListener('change', async ()=>{
  const s = await computeTotal(); toggleDepositBanner(s.total);
});
document.addEventListener('change', async e=>{
  const t = e.target;
  if(
    (t?.classList && t.classList.contains('itemCheck')) ||
    (t?.classList && t.classList.contains('itemQty')) ||
    t?.name === 'pay'
  ){
    const s = await computeTotal(); toggleDepositBanner(s.total);
  }
});

[custNameEl, custPhoneEl, custAddrEl].forEach((el)=>{
  if(!el) return;
  const key = 'yt_'+el.id;
  const saved = localStorage.getItem(key);
  if(saved) el.value = saved;
  el.addEventListener('input', ()=> localStorage.setItem(key, el.value));
});

// Store items add
addStoreItemBtn?.addEventListener('click', e=>{
  e.preventDefault();
  const name = prompt('Item name');
  const priceVal = prompt('Price (R)');
  const price = Number(priceVal);
  if(!name || !Number.isFinite(price) || price<=0){ return; }
  CATALOG.push({name,price});
  storeItems.push({name,price});
  renderItems();
  computeTotal().then(s=>toggleDepositBanner(s.total));
});

// ========================================================================
// MODAL / ADMIN BTN WIRING
// ========================================================================
document.getElementById('closeBot')?.addEventListener('click', closeBot);
closeBtn?.addEventListener('click', closeOrder);
cancelOrderBuilder?.addEventListener('click', closeOrder);
closePayModalBtn?.addEventListener('click', closePayModal);
btnCancelPay?.addEventListener('click', closePayModal);
closeDriver?.addEventListener('click', closeDriverWindow);
closeDriverDash?.addEventListener('click', closeDriverDashWindow);
ordersClose?.addEventListener('click', closeOrders);

adminBtn?.addEventListener('click', (e)=>{
  e.preventDefault();
  const pw = prompt("Enter admin PIN:");
  if (pw === null) return;
  if (pw === ADMIN_PASS) {
    openOrders();
  } else {
    alert("Incorrect PIN");
  }
});

window.addEventListener('yt-open-orders', openOrders);

btnFakePayNow?.addEventListener('click', ()=>{
  alert('No money taken. Demo only.');
  closePayModal();

  botSendWA?.classList.remove('hidden');
  botNewOrder?.classList.remove('hidden');
  if(botDemoNote) botDemoNote.hidden = false;

  appendBot(`<b>Payment marked (demo)</b><br/>We'll WhatsApp you the real secure link next.`, 'bot');
  botStage = 2;
});

['openOrderBuilder','openOrderBuilderTop','openOrderBuilderFooter'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.addEventListener('click', openOrder);
});
['openDriverModal','openDriverModalTop','openDriverModalFooter'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.addEventListener('click', openDriverWindow);
});

tabSignup?.addEventListener('click',()=>{
  tabSignup.classList.add('bg-emerald-600','text-white');
  tabLogin.classList.remove('bg-emerald-600','text-white');
  formSignup?.classList.remove('hidden');
  formLogin?.classList.add('hidden');
  tabSignup.setAttribute('aria-selected','true');
  tabLogin.setAttribute('aria-selected','false');
});
tabLogin?.addEventListener('click',()=>{
  tabLogin.classList.add('bg-emerald-600','text-white');
  tabSignup.classList.remove('bg-emerald-600','text-white');
  formSignup?.classList.add('hidden');
  formLogin?.classList.remove('hidden');
  tabSignup.setAttribute('aria-selected','false');
  tabLogin.setAttribute('aria-selected','true');
});

// ========================================================================
// STORE MODAL
// ========================================================================
function renderStoreItems(){
  if(!storeItemsList) return;
  storeItemsList.innerHTML = '';
  storeItems.forEach((it,idx)=>{
    const row = document.createElement('div');
    row.className = "flex items-center justify-between border rounded-lg p-2";
    row.innerHTML = `
<div class="text-sm">
  <div class="font-medium">${it.name}</div>
  <div class="text-xs text-slate-500">R${it.price}</div>
</div>
<button data-idx="${idx}" class="removeStoreItem text-[11px] text-red-600 underline" aria-label="Remove ${it.name}">remove</button>
`;
    storeItemsList.appendChild(row);
  });

  storeItemsList.querySelectorAll('.removeStoreItem').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = Number(btn.getAttribute('data-idx'));
      storeItems.splice(i,1);
      renderStoreItems();
    });
  });
}

openStoreFooter?.addEventListener('click', openStore);
closeStoreModalBtn?.addEventListener('click', closeStore);
cancelStoreBtn?.addEventListener('click', closeStore);

submitStoreBtn?.addEventListener('click', async ()=>{
  const storeName = storeNameEl?.value.trim();
  const storePhone = digits(storePhoneEl?.value.trim());
  const zone = storeZoneEl?.value || 'A';
  if(!storeName || !storePhone){
    alert("Please add store name & WhatsApp.");
    return;
  }
  if(storeItems.length === 0){
    if(!confirm("No items added yet. Submit anyway?")) return;
  }

  const payload = {
    name: storeName,
    owner_name: storeName,
    phone: storePhone,
    zone,
    address: {}
  };

  if(!DEMO_MODE){
    try{
      const r = await fetch(`${BASE_API}/stores`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || j.ok === false){ alert("Store save failed on server."); }
    }catch(err){ console.error("store create failed",err); }
  }

  const adminMsg =
`New store signup:
Name: ${storeName}
Phone: ${storePhone}
Items:
${storeItems.map(i=>"- "+i.name+" (R"+i.price+")").join("\n")}`;

  window.open(`https://wa.me/${ADMIN_WHATSAPP}?text=${waText(adminMsg)}`,'_blank');

  alert("Thanks! We'll review your store.");
  closeStore();

  if(storeNameEl) storeNameEl.value = '';
  if(storePhoneEl) storePhoneEl.value = '';
  if(storeZoneEl) storeZoneEl.value = 'A';
  storeItems.splice(0,storeItems.length);
  renderStoreItems();
});

// ========================================================================
// DATA EVENTS
// ========================================================================
window.addEventListener('yt-orders-updated', ()=>{
  if(ordersPanel && !ordersPanel.classList.contains('hidden')) {
    renderOrders();
    renderDrivers();
    renderStats();
  }
});

// ========================================================================
// ADMIN STATS (live from API) — YOUR SNIPPET (slightly extended)
// ========================================================================
async function fetchAllOrders(){
  try{
    const r = await fetch(`${BASE_API}/orders`);
    const j = await r.json().catch(()=>({}));
    if(!r.ok || !j.ok) return [];
    return Array.isArray(j.orders) ? j.orders : [];
  }catch(e){
    console.error("fetchAllOrders", e);
    return [];
  }
}

async function fetchDrivers(){
  try{
    const r = await fetch(`${BASE_API}/drivers`);
    const j = await r.json().catch(()=>({}));
    if(!r.ok || !j.ok) {
      DRIVERS = [];
      DRIVERS_BY_ID = {};
      API_DRIVERS_MAP = {};
      return;
    }
    DRIVERS = Array.isArray(j.drivers) ? j.drivers : [];
    DRIVERS_BY_ID = Object.create(null);
    API_DRIVERS_MAP = Object.create(null);

    for(const d of DRIVERS){
      if(!d) continue;
      const key = d._internal_id || d.driver_id;
      if(key){
        DRIVERS_BY_ID[key] = d;
        API_DRIVERS_MAP[key] = d;
      }
    }
  }catch(e){
    console.error("fetchDrivers", e);
    DRIVERS = [];
    DRIVERS_BY_ID = {};
    API_DRIVERS_MAP = {};
  }
}

function recalcAdminPayoutWidgets(){
  if(!adminDriversCountEl || !adminPayPendingEl || !adminPayApprovedEl) return;

  adminDriversCountEl.textContent = String(DRIVERS.length || 0);

  let pending = 0;
  let approved = 0;
  const source = DEMO_MODE ? DEMO_ORDERS_DB : ALL_ORDERS_MAP;

  Object.values(source).forEach(o=>{
    if(o.driver_pay_status === 'pending'){
      pending += Number(o.driver_pay_pending || 0);
    }
    if(o.driver_pay_status === 'approved'){
      approved += Number(o.driver_pay_approved || 0);
    }
  });

  adminPayPendingEl.textContent = `R${Math.round(pending)}`;
  adminPayApprovedEl.textContent = `R${Math.round(approved)}`;
}

async function renderAdminStats(){
  // Ensure stats container exists
  if(!statsContainer){
    statsContainer = document.createElement('div');
    statsContainer.id = 'statsContainer';
    statsContainer.className = 'mt-4';
    (ordersPanel || document.body).appendChild(statsContainer);
  }

  adminStatsOrdersEl  = document.getElementById('adminStatsOrders');
  adminStatsRevenueEl = document.getElementById('adminStatsRevenue');
  adminTopProductsEl  = document.getElementById('adminTopProducts');
  adminTopAreasEl     = document.getElementById('adminTopAreas');

  if(!document.getElementById('adminStatsWrap')){
    const stats = document.createElement('div');
    stats.id = 'adminStatsWrap';
    stats.className = ''; // visible; Stats tab toggles container
    stats.innerHTML = `
      <div class="grid gap-3 sm:grid-cols-3">
        <div class="border rounded-xl p-3 flex flex-col">
          <div class="text-xs text-slate-500 mb-1">Total Orders</div>
          <div id="adminStatsOrders" class="text-2xl font-semibold">0</div>
        </div>
        <div class="border rounded-xl p-3 flex flex-col">
          <div class="text-xs text-slate-500 mb-1">Revenue</div>
          <div id="adminStatsRevenue" class="text-2xl font-semibold">R0</div>
        </div>
        <div class="border rounded-xl p-3 flex flex-col">
          <div class="text-xs text-slate-500 mb-1">Drivers</div>
          <div class="text-sm"><b id="adminDriversCount">0</b></div>
          <div class="text-xs text-slate-500 mt-2">Payouts</div>
          <div class="text-xs">Pending: <b id="adminPayPending">R0</b></div>
          <div class="text-xs">Approved: <b id="adminPayApproved">R0</b></div>
        </div>
      </div>
      <div class="grid gap-3 sm:grid-cols-2 mt-4">
        <div class="border rounded-xl p-3">
          <div class="text-sm font-medium mb-2">Top Products</div>
          <ul id="adminTopProducts" class="text-sm space-y-1"></ul>
        </div>
        <div class="border rounded-xl p-3">
          <div class="text-sm font-medium mb-2">Top Areas</div>
          <ul id="adminTopAreas" class="text-sm space-y-1"></ul>
        </div>
      </div>
    `;
    statsContainer.appendChild(stats);
    adminStatsOrdersEl  = document.getElementById('adminStatsOrders');
    adminStatsRevenueEl = document.getElementById('adminStatsRevenue');
    adminTopProductsEl  = document.getElementById('adminTopProducts');
    adminTopAreasEl     = document.getElementById('adminTopAreas');
    adminDriversCountEl = document.getElementById('adminDriversCount');
    adminPayPendingEl   = document.getElementById('adminPayPending');
    adminPayApprovedEl  = document.getElementById('adminPayApproved');
  }

  const orders = DEMO_MODE ? Object.values(DEMO_ORDERS_DB) : await fetchAllOrders();
  const totalOrders = orders.length;
  const revenue = orders.reduce((s,o)=> s + Number(o.total||0), 0);

  if(adminStatsOrdersEl)  adminStatsOrdersEl.textContent  = String(totalOrders);
  if(adminStatsRevenueEl) adminStatsRevenueEl.textContent = `R${revenue}`;

  // Top products
  const prodMap = new Map();
  orders.forEach(o=>{
    (o.items||[]).forEach(it=>{
      if(!it) return;
      prodMap.set(it.name, (prodMap.get(it.name)||0) + (it.qty||1));
    });
  });
  const topProducts = Array.from(prodMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5);
  if(adminTopProductsEl){
    adminTopProductsEl.innerHTML = topProducts.length
      ? topProducts.map(([name,c])=>`<li>${salesSafe(name)} — <b>${c}</b></li>`).join('')
      : '<li class="text-slate-500">No data yet</li>';
  }

  // Top areas
  const areaMap = new Map();
  orders.forEach(o=>{
    const k = o.meta?.collection_name || '—';
    areaMap.set(k, (areaMap.get(k)||0)+1);
  });
  const topAreas = Array.from(areaMap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5);
  if(adminTopAreasEl){
    adminTopAreasEl.innerHTML = topAreas.length
      ? topAreas.map(([name,c])=>`<li>${salesSafe(name)} — <b>${c}</b></li>`).join('')
      : '<li class="text-slate-500">No data yet</li>';
  }

  if(!DEMO_MODE){
    await fetchDrivers();
  }
  recalcAdminPayoutWidgets();
}

function renderStats(){
  renderAdminStats();
}

// ========================================================================
// ADMIN TABS
// ========================================================================
function ensureAdminTabs(){
  let tabButtons = Array.from(document.querySelectorAll('.yt-o-tab'));

  function makeTabBtn(label, tabKey){
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'yt-o-tab px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100 text-xs';
    btn.dataset.oTab = tabKey;
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-selected','false');
    btn.textContent = label;
    btn.addEventListener('click', ()=> setActiveAdminTab(tabKey));
    return btn;
  }

  const wanted = [
    ['Pending','pending'],
    ['Assigned','assigned'],
    ['In Transit','in_transit'],
    ['Delivered','delivered'],
    ['Drivers','drivers'],
    ['Stats','stats']
  ];

  const host = ordersTabsContainer || ordersList?.parentElement || ordersPanel || document.body;
  const haveKeys = new Set(tabButtons.map(b=>b.dataset.oTab));

  wanted.forEach(([label,key])=>{
    if(!haveKeys.has(key)){
      host.appendChild(makeTabBtn(label, key));
    }
  });

  tabButtons = Array.from(document.querySelectorAll('.yt-o-tab'));
  tabButtons.forEach(b=>{
    if(!b.dataset.wired){
      b.addEventListener('click', ()=> setActiveAdminTab(b.dataset.oTab));
      b.dataset.wired = '1';
    }
  });
}

function setActiveAdminTab(tabKey){
  ordersTab = tabKey;

  document.querySelectorAll('.yt-o-tab').forEach(x=>{
    x.classList.remove('bg-emerald-600','text-white');
    x.setAttribute('aria-selected','false');
    if(x.dataset.oTab === tabKey){
      x.classList.add('bg-emerald-600','text-white');
      x.setAttribute('aria-selected','true');
    }
  });

  const showDrivers = (tabKey === 'drivers' || (tabKey||'').startsWith('by_driver:'));
  const showStats = (tabKey === 'stats');

  const ordersWrapper = ordersList?.parentElement;
  const driversWrapper = driversList?.parentElement;

  if (ordersWrapper) ordersWrapper.classList.toggle('hidden', showDrivers || showStats);
  if (driversWrapper) driversWrapper.classList.toggle('hidden', !showDrivers);
  if (statsContainer) statsContainer.classList.toggle('hidden', !showStats);

  if(showDrivers){
    renderDrivers();
  } else if(showStats){
    renderAdminStats();
  } else {
    renderOrders();
  }
}

function hardRefresh(){
  refreshAllData();
  setActiveAdminTab(ordersTab);
}
ordersRefresh?.addEventListener('click', hardRefresh);
driversRefresh?.addEventListener('click', hardRefresh);

// ========================================================================
// ORDER / DRIVER ACTIONS
// ========================================================================
let rrIdx = 0;
function pickDriverId(){
  const ids = DEMO_MODE ? Object.keys(DEMO_DRIVERS_DB) : Object.keys(API_DRIVERS_MAP);
  if(ids.length===0) return null;
  const id = ids[rrIdx % ids.length];
  rrIdx++;
  return id;
}

function mutateOrder(internalId, mut){
  if(DEMO_MODE){
    const o = DEMO_ORDERS_DB[internalId];
    if(!o) return null;
    mut(o);
    saveOrdersToLS();
    hydrateState();
    window.dispatchEvent(new Event('yt-orders-updated'));
    return o;
  }
  return null;
}

function calcDriverPayout(order){
  const fee = Number(order?.delivery_fee ?? 0);
  return clamp(fee, 25, 45);
}

async function assignOneOrder(internalId){
  if(!internalId){ alert("Missing order id."); return; }

  if(DEMO_MODE){
    mutateOrder(internalId, (o)=>{
      if(!o.driver_id){ o.driver_id = pickDriverId(); }
      const pay = calcDriverPayout(o);
      o.driver_pay_status = 'pending';
      o.driver_pay_pending = pay;
      o.driver_pay_approved = 0;
      if(o.status === 'pending') o.status = 'assigned';
    });
    renderOrders(); renderDrivers(); renderStats();
    alert(`[DEMO] Assigned ${internalId}.`);
    return;
  }

  try{
    const res = await fetch(`${BASE_API}/orders/${encodeURIComponent(internalId)}/auto-assign`, {
      method: "POST",
      headers: {"Content-Type":"application/json"}
    });
    const data = await res.json().catch(()=>({}));

    if(res.ok && data && data.ok){
      alert(`Assigned: ${internalId} -> ${data.driver_id || 'driver?'}`);
    } else if (res.status === 409 && data && data.error === "no_driver_available") {
      alert(`No driver available for ${internalId}`);
    } else {
      alert(`Failed to assign ${internalId} (${res.status})`);
    }
  }catch(err){
    console.error("assignOneOrder err",err);
    alert(`Network error assigning ${internalId}`);
  }
  refreshAllData();
}

async function markDelivered(internalId){
  if(!internalId){ alert("Missing order id."); return; }

  if(DEMO_MODE){
    mutateOrder(internalId, (o)=>{
      const pay = calcDriverPayout(o);
      o.status = 'delivered';
      o.driver_pay_status = 'approved';
      o.driver_pay_approved = pay;
      o.driver_pay_pending = 0;
    });
    renderOrders(); renderDrivers(); renderStats();
    alert(`[DEMO] Delivered ${internalId}.`);
    return;
  }

  try{
    const res = await fetch(`${BASE_API}/orders/${encodeURIComponent(internalId)}/status`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({status:"delivered"})
    });
    const data = await res.json().catch(()=>({}));
    if(res.ok && data && data.ok){
      alert(`Marked delivered: ${internalId}`);
    } else {
      alert(`Failed to mark delivered (${res.status})`);
    }
  }catch(err){
    console.error("markDelivered err",err);
    alert(`Network error marking delivered ${internalId}`);
  }
  refreshAllData();
}

async function autoAssignForAll(){
  const source = DEMO_MODE ? DEMO_ORDERS_DB : ALL_ORDERS_MAP;
  const ids = Object.values(source)
    .filter(o => o.status === 'pending')
    .map(o => o._internal_id || o.internal_id);

  if (ids.length === 0){ alert("No pending orders to assign."); return; }

  const results = [];
  for (const internalId of ids){
    if (DEMO_MODE){
      mutateOrder(internalId, (o)=>{
        if(!o.driver_id){ o.driver_id = pickDriverId(); }
        const pay = calcDriverPayout(o);
        o.driver_pay_status = 'pending';
        o.driver_pay_pending = pay;
        o.status = 'assigned';
        results.push(`✅ (demo) ${internalId} -> ${o.driver_id} (R${pay})`);
      });
      continue;
    }

    try {
      const res = await fetch(`${BASE_API}/orders/${encodeURIComponent(internalId)}/auto-assign`, {
        method: "POST",
        headers: {"Content-Type":"application/json"}
      });
      const data = await res.json().catch(()=>({}));

      if(res.ok && data && data.ok){
        const driverId = data.driver_id || "driver?";
        results.push(`✅ ${internalId} → ${driverId}`);
      } else if (res.status === 409 && data && data.error === "no_driver_available") {
        results.push(`⚠️ ${internalId}: no driver`);
      } else {
        results.push(`❌ ${internalId}: failed (${res.status})`);
      }
    } catch (err){
      console.error("autoAssignForAll error", err);
      results.push(`❌ ${internalId}: network error`);
    }
  }
  alert(results.join("\n"));
  refreshAllData();
}
ordersAssign?.addEventListener('click', autoAssignForAll);

// ========================================================================
// ORDER LIST RENDERING
// ========================================================================
async function renderOrders(){
  if(!ordersList) return;

  // by driver tab
  if((ordersTab||'').startsWith('by_driver:')){
    const did = ordersTab.split(':',2)[1];
    const src = DEMO_MODE ? Object.values(DEMO_ORDERS_DB) : Object.values(ALL_ORDERS_MAP);
    const data = src.filter(o => {
      const assigned = o.assigned_driver_id || o.driver_id;
      return assigned === did;
    });

    currentOrdersByTab[ordersTab] = data;

    ordersList.innerHTML = data.length
      ? ''
      : `<div class="text-sm text-slate-500 p-4">No orders for that driver.</div>`;

    data.forEach(o => ordersList.appendChild(buildOrderRow(o)));
    wireOrderRowButtons(ordersList);
    return;
  }

  // status tabs
  const data = DEMO_MODE
    ? Object.values(DEMO_ORDERS_DB).filter(o=>o.status===ordersTab)
    : Object.values(ALL_ORDERS_MAP).filter(o=>o.status===ordersTab);

  currentOrdersByTab[ordersTab] = data;

  ordersList.innerHTML = data.length
    ? ''
    : `<div class="text-sm text-slate-500 p-4">No ${ordersTab} orders.</div>`;

  data.forEach(o => ordersList.appendChild(buildOrderRow(o)));
  wireOrderRowButtons(ordersList);
}

function buildOrderRow(o){
  const itemsText = (o.items || []).map(i=>`${i.name} x${i.qty}`).join(', ');
  const internalId = o._internal_id || o.internal_id || null;
  const refDisplay = o.order_public_id || o.order_id || internalId || "REF?";
  const kmText = (o.meta && Number.isFinite(o.meta.distance_km))
    ? ` • ${Number(o.meta.distance_km).toFixed(1)} km`
    : "";
  const fraudDisplay = (typeof o.fraud_score === "number")
    ? ` • Fraud: ${Number(o.fraud_score).toFixed(2)}`
    : "";

  const driverMaps = DEMO_MODE ? DEMO_DRIVERS_DB : API_DRIVERS_MAP;
  const driverKey = o.assigned_driver_id || o.driver_id || null;
  let driverName = '—';

  if(driverKey && driverMaps[driverKey]){
    driverName = driverMaps[driverKey].name || driverMaps[driverKey].driver_id || driverKey;
  } else if(o.driver_id && driverMaps[o.driver_id]){
    driverName = driverMaps[o.driver_id].name || o.driver_id;
  }

  let driverPayText = "Driver pay: R0";
  let driverPayStatusText = "Pay: –";
  if(o.driver_pay_status === "pending"){
    driverPayText = `Driver pay: R${o.driver_pay_pending || 0}`;
    driverPayStatusText = "Pay: pending";
  } else if(o.driver_pay_status === "approved"){
    driverPayText = `Driver pay: R${o.driver_pay_approved || 0}`;
    driverPayStatusText = "Pay: approved";
  }

  const isDelivered = o.status === "delivered";
  const canAssign = (o.status === "pending" || o.status === "review_required") && !isDelivered;
  const canDeliver = (o.status === "assigned" || o.status === "in_transit") && !isDelivered;

  const createdRaw =
    o.created_at_iso || o.created_at || o.createdAt || (o.meta && o.meta.created_at);
  const createdText = createdRaw
    ? new Date(createdRaw).toLocaleString()
    : '';

  const row = document.createElement('div');
  row.className = 'p-3 flex flex-col sm:flex-row sm:items-center gap-3 border-b border-slate-200';
  row.setAttribute('data-order-id', internalId || '');
  row.setAttribute('data-order-status', o.status || '');

  row.innerHTML = `
<div class="flex-1 min-w-0">
  <div class="font-medium flex flex-wrap items-center gap-1">
    <span>Ref ${salesSafe(refDisplay)}</span>
    <span>• Total R${o.total}</span>
    ${kmText}
  </div>
  <div class="text-xs text-slate-500 break-words">${salesSafe(itemsText || '')}</div>
  <div class="text-xs text-slate-500">
    Status: <b>${salesSafe(o.status || '')}</b> • Driver: ${salesSafe(driverName)}${fraudDisplay}
  </div>
  <div class="text-[11px] leading-snug text-slate-500 mt-1">
    ${driverPayText} • ${driverPayStatusText}
  </div>
  ${ createdText
    ? `<div class="text-[9px] text-slate-400 mt-0.5">Created: ${salesSafe(createdText)}</div>`
    : ''
  }
</div>
<div class="flex flex-row flex-wrap gap-2 text-xs sm:justify-end">
  <button
    class="btn-assign px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100 disabled:opacity-40 disabled:cursor-not-allowed"
    ${(!canAssign || !internalId) ? 'disabled' : ''}
    data-id="${internalId || ''}">
    Assign
  </button>
  <button
    class="btn-start px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100 disabled:opacity-40 disabled:cursor-not-allowed"
    ${(o.status !== 'assigned' || !internalId) ? 'disabled' : ''}
    data-id="${internalId || ''}">
    Start trip
  </button>
  <button
    class="btn-delivered px-2 py-1 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-40 disabled:cursor-not-allowed"
    ${(!canDeliver || !internalId) ? 'disabled' : ''}
    data-id="${internalId || ''}">
    Delivered
  </button>
</div>
`;
  return row;
}

function wireOrderRowButtons(scopeEl){
  scopeEl.querySelectorAll('.btn-assign').forEach(btn=>{
    btn.addEventListener('click', ()=> assignOneOrder(btn.getAttribute('data-id')));
  });
  scopeEl.querySelectorAll('.btn-start').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-id');
      if(DEMO_MODE && DEMO_ORDERS_DB[id]){
        mutateOrder(id, (o)=>{
          if(o.status === 'assigned') o.status = 'in_transit';
        });
        renderOrders();
        renderDrivers();
        renderStats();
      }
    });
  });
  scopeEl.querySelectorAll('.btn-delivered').forEach(btn=>{
    btn.addEventListener('click', ()=> markDelivered(btn.getAttribute('data-id')));
  });
}

// ========================================================================
// DRIVER METRICS & RENDERING
// ========================================================================
function computeDriverDerived(driverKey){
  const source = DEMO_MODE ? DEMO_ORDERS_DB : ALL_ORDERS_MAP;
  const mine = Object.values(source).filter(o => {
    const assigned = o.assigned_driver_id || o.driver_id;
    return assigned === driverKey;
  });

  let assigned = 0, in_transit = 0, delivered = 0;
  let pendingPay = 0, approvedPay = 0;
  let deliveredRevenue = 0;
  let totalFee = 0, feeCount = 0;
  const deliveredRefs = [];

  mine.forEach(o=>{
    if(o.status === 'assigned')   assigned++;
    if(o.status === 'in_transit') in_transit++;
    if(o.status === 'delivered'){
      delivered++;
      deliveredRevenue += Number(o.total || 0);
      deliveredRefs.push(o.order_public_id || o.order_id || o._internal_id || '—');
    }
    if(Number.isFinite(o.delivery_fee)){
      totalFee += Number(o.delivery_fee);
      feeCount++;
    }
    if(o.driver_pay_status === 'pending')
      pendingPay += Number(o.driver_pay_pending || 0);
    if(o.driver_pay_status === 'approved')
      approvedPay += Number(o.driver_pay_approved || 0);
  });

  const avgFee = feeCount ? Math.round(totalFee / feeCount) : 0;
  const lastDeliveries = deliveredRefs.slice(-3);

  return {
    assigned,
    in_transit,
    delivered,
    pendingPay: Math.round(pendingPay),
    approvedPay: Math.round(approvedPay),
    deliveredRevenue: Math.round(deliveredRevenue),
    avgFee,
    lastDeliveries
  };
}

function renderDrivers(){
  if(!driversList) return;

  const pairs = DEMO_MODE
    ? Object.entries(DEMO_DRIVERS_DB)
    : Object.entries(API_DRIVERS_MAP);

  driversList.innerHTML = '';
  if(pairs.length===0){
    driversList.innerHTML = `<div class="text-sm text-slate-500 p-4">No drivers yet.</div>`;
    return;
  }

  const wrapper = document.createElement('div');
  wrapper.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3';

  for(const [driverKey, dr] of pairs){
    const stats = computeDriverDerived(driverKey);
    const labelId = dr.driver_id || driverKey;
    const area =
      dr.area || dr.zone || dr.base_area || dr.depot_name || dr.hub_name || 'Area not set';

    const card = document.createElement('div');
    card.className =
      'bg-white border border-slate-200 rounded-2xl p-3 shadow-sm flex flex-col gap-2 text-xs';

    card.innerHTML = `
<div class="flex flex-col gap-1">
  <div class="flex flex-wrap items-baseline gap-2">
    <div class="text-[9px] px-1.5 py-0.5 rounded-full bg-emerald-50 text-emerald-700 font-semibold">
      #${salesSafe(labelId)}
    </div>
    <div class="font-semibold text-slate-900">${salesSafe(dr.name || '')}</div>
  </div>
  <div class="text-[10px] text-slate-500">📞 ${salesSafe(dr.phone || '—')}</div>
  <div class="text-[10px] text-slate-500">📍 ${salesSafe(area)}</div>
</div>

<div class="grid grid-cols-3 gap-2 text-[9px] mt-1">
  <div class="bg-slate-50 rounded-xl px-2 py-1">
    <div class="text-slate-500">Delivered</div>
    <div class="text-sm font-semibold text-emerald-700">${stats.delivered}</div>
  </div>
  <div class="bg-slate-50 rounded-xl px-2 py-1">
    <div class="text-slate-500">Assigned</div>
    <div class="text-sm font-semibold text-slate-800">${stats.assigned}</div>
  </div>
  <div class="bg-slate-50 rounded-xl px-2 py-1">
    <div class="text-slate-500">In transit</div>
    <div class="text-sm font-semibold text-slate-800">${stats.in_transit}</div>
  </div>
</div>

<div class="text-[9px] text-slate-500">
  Delivered value:
  <span class="font-semibold text-slate-900">R${stats.deliveredRevenue}</span>
  &nbsp;• Avg fee:
  <span class="font-semibold text-slate-900">R${stats.avgFee}</span>
</div>

<div class="text-[9px] text-slate-500">
  Pending pay:
  <span class="font-semibold text-amber-600">R${stats.pendingPay}</span>
  &nbsp;• Approved:
  <span class="font-semibold text-emerald-700">R${stats.approvedPay}</span>
</div>

${stats.lastDeliveries.length
  ? `<div class="text-[8px] text-slate-400">
      Recent refs:
      ${stats.lastDeliveries.map(x=>`<code>${salesSafe(x)}</code>`).join(', ')}
    </div>`
  : ''}

<div class="mt-2 flex flex-wrap gap-2">
  <button
    class="btn-view-orders px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100"
    data-id="${salesSafe(driverKey)}">
    View Orders
  </button>
  <button
    class="btn-approve-pay px-2 py-1 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700"
    data-id="${salesSafe(driverKey)}">
    Approve All Pay
  </button>
  ${dr.phone
    ? `<a
        class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100"
        href="https://wa.me/${salesSafe(dr.phone)}"
        target="_blank" rel="noopener">
        WhatsApp
      </a>`
    : ''
  }
</div>
`;
    wrapper.appendChild(card);
  }

  driversList.appendChild(wrapper);

  // Approve payouts
  driversList.querySelectorAll('.btn-approve-pay').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const did = btn.getAttribute('data-id');

      if (DEMO_MODE){
        let count = 0;
        Object.values(DEMO_ORDERS_DB).forEach(o=>{
          const assigned = o.assigned_driver_id || o.driver_id;
          if(assigned===did && o.driver_pay_status==='pending'){
            const amount = o.driver_pay_pending || 0;
            o.driver_pay_status = 'approved';
            o.driver_pay_approved = amount;
            o.driver_pay_pending = 0;
            count++;
          }
        });
        saveOrdersToLS();
        hydrateState();
        renderDrivers(); renderOrders(); renderStats();
        alert(count ? `Approved ${count} payout(s) for driver.` : `No pending payouts.`);
        return;
      }

      try{
        const res = await fetch(`${BASE_API}/drivers/${encodeURIComponent(did)}/approve-all-pay`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'}
        });
        const data = await res.json().catch(()=>({}));
        if(res.ok && data && data.ok){
          alert(`Approved payouts for driver.`);
        } else {
          alert('Server did not approve payouts.');
        }
      }catch(err){
        console.error('approve payouts err', err);
        alert('Network/API error approving payouts.');
      }
      refreshAllData();
    });
  });

  // View orders for driver
  driversList.querySelectorAll('.btn-view-orders').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const did = btn.getAttribute('data-id');
      ordersTab = `by_driver:${did}`;
      setActiveAdminTab(ordersTab);
    });
  });
}

// ========================================================================
// MAP + ANIMATION
// ========================================================================
(function initMapSafely(){
  const heroEl = document.getElementById('heroMap');
  if(!heroEl) return;

  let heroMap;
  const localCars = [];
  const movers = [];

  function carIcon(){
    const svg=`<svg viewBox='0 0 64 28' aria-hidden='true'><g>
<rect x='6' y='10' rx='6' ry='6' width='52' height='10' fill='${emerald[600]}' opacity='.95'/>
<rect x='10' y='5' rx='6' ry='6' width='44' height='14' fill='#ffffff'/>
<rect x='24' y='6' width='16' height='7' rx='2' fill='#e5e7eb'/>
<rect x='10' y='9' width='4' height='3' fill='#f59e0b'/>
<rect x='50' y='9' width='4' height='3' fill='#f59e0b'/>
<circle cx='18' cy='20' r='3' fill='#111827'/>
<circle cx='46' cy='20' r='3' fill='#111827'/>
</g></svg>`;
    return L.divIcon({ className:'car-dot', html:svg, iconSize:[28,14], iconAnchor:[14,7] });
  }

  const pkgSvg=`<svg viewBox='0 0 24 24' aria-hidden='true'>
<path fill='${emerald[600]}' d='M3 7l9-4 9 4-9 4-9-4zm0 3l9 4 9-4v7c0 .4-.2.8-.6 1l-7.8 3.5c-.4.2-.8.2-1.2 0L3.6 18c-.4-.2-.6-.6-.6-1V10z'/>
</svg>`;
  const pkgIcon = () => L.divIcon({ className:'pkg-dot', html:pkgSvg, iconSize:[20,20], iconAnchor:[10,10] });

  async function osrmRoute(a,b){
    try{
      const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
      const r = await fetch(url);
      const j = await r.json();
      const coords = j?.routes?.[0]?.geometry?.coordinates;
      if(Array.isArray(coords) && coords.length>1){
        return coords.map(([lng,lat])=>[lat,lng]);
      }
    }catch(_){}
    return null;
  }

  function buildStraight(a,b){ return [[a.lat,a.lng],[b.lat,b.lng]]; }

  function cumulativeLengths(latlngs){
    const lens=[0];
    let acc=0;
    for(let i=1;i<latlngs.length;i++){
      const a = {lat:latlngs[i-1][0], lng:latlngs[i-1][1]};
      const b = {lat:latlngs[i][0], lng:latlngs[i][1]};
      acc += kmBetween(a,b);
      lens.push(acc);
    }
    return { lensKm:lens, totalKm:acc };
  }

  function pointAtFraction(latlngs, lensKm, frac){
    const target = frac*lensKm[lensKm.length-1];
    let i=1;
    while(i<lensKm.length && lensKm[i]<target) i++;
    const a=latlngs[i-1], b=latlngs[i];
    const segLen = lensKm[i]-lensKm[i-1] || 1e-6;
    const t = (target - lensKm[i-1]) / segLen;
    return [
      a[0] + (b[0]-a[0])*t,
      a[1] + (b[1]-a[1])*t
    ];
  }

  function spawnLocalTraffic(center, count){
    for(let i=0;i<count;i++){
      const r = 0.01 + Math.random()*0.02;
      const ang0 = Math.random()*Math.PI*2;
      const spd = 0.10 + Math.random()*0.15;
      const m = L.marker(
        [center.lat + r*Math.sin(ang0), center.lng + r*Math.cos(ang0)],
        { icon:carIcon() }
      ).addTo(heroMap);
      localCars.push({m, cx:center.lat, cy:center.lng, r, ang:ang0, spd});
    }
  }

  async function centerAndDraw(){
    DELIVERY_COORDS = DELIVERY_COORDS || await tryGetCustomerCoords();

    const centerLatLng = [-33.20, 26.55];
    const centerZoom = 7;

    if(!DELIVERY_COORDS){
      heroMap.setView(centerLatLng, centerZoom);
      COLLECTIONS.slice(0,3).forEach(c=>{
        L.marker([c.lat, c.lng], { icon: pkgIcon(), title: c.name }).addTo(heroMap).bindTooltip(c.name);
      });
      spawnLocalTraffic({lat:centerLatLng[0], lng:centerLatLng[1]}, 4);
      return;
    }

    let best = null;
    for(const c of COLLECTIONS){
      const d = kmBetween({lat:c.lat,lng:c.lng}, DELIVERY_COORDS);
      if(!best || d < best.d) best = { c, d };
    }
    const depot = best.c;

    document.getElementById('coverageBadge')?.classList.add('bg-[rgba(15,23,42,.75)]');

    L.marker([depot.lat,depot.lng], { icon: pkgIcon(), title: depot.name })
      .addTo(heroMap).bindTooltip(depot.name);
    L.circleMarker([DELIVERY_COORDS.lat, DELIVERY_COORDS.lng], {
      radius: 7, color: emerald[600], fillColor: emerald[600], fillOpacity: 0.95
    }).addTo(heroMap).bindTooltip('You');

    let latlngs = await osrmRoute({lat:depot.lat, lng:depot.lng}, DELIVERY_COORDS);
    if(!latlngs){ latlngs = buildStraight({lat:depot.lat, lng:depot.lng}, DELIVERY_COORDS); }

    L.polyline(latlngs, { weight:3, color:emerald[600], opacity:0.9 }).addTo(heroMap);

    const bounds = L.latLngBounds(latlngs);
    bounds.extend([depot.lat,depot.lng]);
    bounds.extend([DELIVERY_COORDS.lat,DELIVERY_COORDS.lng]);
    heroMap.fitBounds(bounds, { padding:[30,30], maxZoom:14 });

    const { lensKm } = cumulativeLengths(latlngs);
    for(let i=0;i<3;i++){
      const m = L.marker(latlngs[0], {icon:carIcon()}).addTo(heroMap);
      movers.push({ m, latlngs, lensKm, t: Math.random(), speed: 0.05 + Math.random()*0.03, dir: 1 });
    }

    spawnLocalTraffic(DELIVERY_COORDS, 3);

    const pulse = L.circle([DELIVERY_COORDS.lat, DELIVERY_COORDS.lng], {
      radius: 50,
      color: emerald[500],
      weight: 1,
      opacity: 0.6,
      fillOpacity: 0
    }).addTo(heroMap);

    let grow = true;
    setInterval(()=>{
      const r = pulse.getRadius();
      pulse.setRadius(grow ? r+6 : r-6);
      if(pulse.getRadius()>120) grow=false;
      if(pulse.getRadius()<40) grow=true;
    }, 220);
  }

  (async function(){
    try{
      if(typeof L === 'undefined'){
        throw new Error("Leaflet not loaded");
      }

      const southAfricaBounds = L.latLngBounds([[-35.5, 16.0], [-22.0, 33.5]]);

      heroMap = L.map(heroEl, {
        zoomControl:false,
        dragging:false,
        scrollWheelZoom:false,
        doubleClickZoom:false,
        boxZoom:false,
        touchZoom:false
      }).setView([-33.20, 26.55], 7);

      L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        { attribution:'', opacity:0.98, noWrap:true, detectRetina:true }
      ).addTo(heroMap);

      heroMap.setMaxBounds(southAfricaBounds.pad(0.05));

      if(COLLECTIONS.length >= 2){
        const bgPairs = [];
        for(let i=0;i<COLLECTIONS.length;i++){
          const a = COLLECTIONS[i];
          const b = COLLECTIONS[(i+1)%COLLECTIONS.length];
          bgPairs.push([a,b]);
        }
        for(const [A,B] of bgPairs){
          let latlngs = await osrmRoute({lat:A.lat,lng:A.lng}, {lat:B.lat,lng:B.lng});
          if(!latlngs){ latlngs = buildStraight({lat:A.lat,lng:A.lng}, {lat:B.lat,lng:B.lng}); }
          const { lensKm } = cumulativeLengths(latlngs);
          L.polyline(latlngs, { weight:2, color:emerald[500], opacity:0.25 }).addTo(heroMap);

          for(let i=0;i<2;i++){
            const m = L.marker(latlngs[0], {icon:carIcon()}).addTo(heroMap);
            movers.push({
              m,
              latlngs,
              lensKm,
              t: Math.random(),
              speed: 0.03 + Math.random()*0.02,
              dir: Math.random()<0.5 ? 1 : -1
            });
          }
        }
      }

      function animate(){
        movers.forEach(o=>{
          o.t += o.speed * o.dir * (1/60);
          if(o.t > 1) o.t = 0;
          if(o.t < 0) o.t = 1;
          const [lat,lng] = pointAtFraction(o.latlngs, o.lensKm, o.t);
          o.m.setLatLng([lat,lng]);
        });
        localCars.forEach(lc=>{
          lc.ang += lc.spd * 0.0015;
          const lat = lc.cx + lc.r*Math.sin(lc.ang);
          const lng = lc.cy + lc.r*Math.cos(lc.ang);
          lc.m.setLatLng([lat,lng]);
        });
        requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);

      await centerAndDraw();

      setTimeout(()=>{ try{ heroMap.invalidateSize(); }catch(_){ } }, 150);
      window.addEventListener('resize', ()=> {
        try { heroMap.invalidateSize(); } catch(_){}
      });

      // Driver signup via map
      formSignup?.addEventListener('submit', async e=>{
        e.preventDefault();
        const name = document.getElementById('drvName')?.value.trim();
        const phone = digits(document.getElementById('drvPhone')?.value.trim());
        const radius = Math.max(1, Number(document.getElementById('drvRadius')?.value || 10));
        const vehicle = document.getElementById('drvVehicle')?.value.trim() || 'Car';
        if(!name || !phone){
          alert("Please enter name and phone.");
          return;
        }

        const jitter = ()=>{
          const d = 1500 / 111111;
          const a = Math.random()*Math.PI*2;
          const r = Math.random()*d;
          return {
            lat: COLLECTION_COORDS.lat + r*Math.cos(a),
            lng: COLLECTION_COORDS.lng + r*Math.sin(a)
          };
        };
        const start = jitter();
        L.marker([start.lat,start.lng], {icon:carIcon()}).addTo(heroMap);

        const driver_id = `DRV-${Date.now().toString().slice(-6)}`;
        if (DEMO_MODE){
          DEMO_DRIVERS_DB[driver_id] = {
            driver_id, name, phone, vehicle,
            stats:{assigned:0,in_transit:0,delivered:0},
            payout_pending:0, payout_approved:0
          };
          saveDriversToLS();
          renderDrivers();
          renderStats();
        } else {
          try{
            await fetch(`${BASE_API}/drivers`, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({driver_id, name, phone, vehicle, radius_km: radius})
            });
          }catch(_){}
          refreshAllData();
        }

        const text = `New driver sign-up
Name: ${name}
Phone: ${phone}
Radius: ${radius}km
Vehicle: ${vehicle}`;
        window.open(`https://wa.me/${ADMIN_WHATSAPP}?text=${waText(text)}`,'_blank');

        closeDriverWindow();
        alert('Driver submitted.');
      });

    }catch(err){
      console.warn("Map disabled:", err);
    }
  })();
})();

// ========================================================================
// DRIVER LOGIN → DASH
// ========================================================================
formLogin?.addEventListener('submit',e=>{
  e.preventDefault();
  alert('Logged in (demo). Opening dashboard.');
  closeDriverWindow();
  if(driverDashModal){ openDriverDash(); }
});

// ========================================================================
// ORDER SUBMISSION
// ========================================================================
confirmBtn2?.addEventListener('click', async ()=>{
  confirmBtn2.disabled = true;
  try{
    const summary = await computeTotal();
    if (!summary.items.length){
      alert('Please select at least one item.');
      return;
    }

    const custName = (custNameEl?.value||'').trim();
    const custPhone = digits((custPhoneEl?.value||'').trim());
    const custAddr = (custAddrEl?.value||'').trim();
    if(!custName || !custPhone || !custAddr){
      alert('Please fill name, WhatsApp and address.');
      return;
    }

    const paymentMethod = selectedPay();
    const eta = nextETA(Boolean(summary.rush));

    const orderPayload = {
      customer: {
        name: custName,
        phone: custPhone,
        address: { line1: custAddr, suburb: '—', coords: DELIVERY_COORDS || null }
      },
      items: summary.items.map(it => ({
        sku: null,
        name: it.name,
        qty: it.qty,
        price: it.price
      })),
      subtotal: summary.itemsTotal,
      delivery_fee: summary.fee + summary.rush,
      total: summary.total,
      payment: { method: paymentMethod, status: "pending", provider_ref: null },
      created_by: "web",
      route: {
        eta_minutes: null,
        distance_km: Number(summary.distanceKm.toFixed(2)),
        eta_text: eta
      },
      meta: { rush: !!summary.rush, collection_name: summary.collectionName }
    };

    if(DEMO_MODE){
      const refStub = Date.now().toString().slice(-6);
      const internalId = "demo-" + refStub.toLowerCase();
      const driverPay = clamp(orderPayload.delivery_fee,25,45);
      const did = pickDriverId();
      DEMO_ORDERS_DB[internalId] = {
        _internal_id: internalId,
        order_id: ("YI-" + refStub).toUpperCase(),
        order_public_id: ("DEMO-" + refStub).toUpperCase(),
        status: "pending",
        total: orderPayload.total,
        delivery_fee: orderPayload.delivery_fee,
        items: orderPayload.items.map(x=>({name:x.name, qty:x.qty})),
        meta: {
          collection_name: orderPayload.meta.collection_name,
          distance_km: orderPayload.route.distance_km,
          rush: !!summary.rush
        },
        fraud_score: 0.00,
        driver_id: did,
        driver_pay_status: 'pending',
        driver_pay_pending: driverPay,
        driver_pay_approved: 0
      };
      saveOrdersToLS();
      hydrateState();
      window.dispatchEvent(new Event('yt-orders-updated'));

      latestOrderData = {
        order_public_id: ("DEMO-" + refStub).toUpperCase(),
        status: "pending",
        fraud_score: 0.0,
        total: summary.total,
        items: summary.items,
        eta,
        payment_method: paymentMethod,
        wa_message:
          `Yi Thume, my order is:\n` +
          `Ref: DEMO-${refStub}\n` +
          `Deliver to: ${custAddr}\n` +
          `Items: ${summary.items.map(i=>`${i.name} x${i.qty}`).join(', ')}\n` +
          `Total: R${summary.total}\n` +
          `Expected: ${eta}\n` +
          `Payment: ${paymentMethod}\n` +
          `Please confirm + send payment link.`
      };
    } else {
      let data = null;
      try{
        const res = await fetch(`${BASE_API}/orders`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(orderPayload)
        });
        try { data = await res.json(); } catch(_){ data=null; }

        if (res.status === 409 && data && data.error === "no_driver_available") {
          alert(data.message || `Sorry, no driver currently available near your area.`);
          return;
        }
        if(!res.ok || !data || data.ok === false){
          console.error("Order failed", res.status, data);
          alert("Order failed on server.");
          return;
        }

        latestOrderData = {
          order_public_id: data.order_public_id || data.order_id || ("YI-" + Date.now().toString().slice(-6)),
          status: data.status || "pending",
          fraud_score: data.fraud_score ?? null,
          total: summary.total,
          items: summary.items,
          eta,
          payment_method: paymentMethod,
          wa_message: data.wa_message || null
        };

        await refreshAllData();
      }catch(err){
        console.error("Network/Fetch error", err);
        alert("Network error creating order.");
        return;
      }
    }

    closeOrder();
    openBot();

    appendBot(
      `<b>YiThume</b> 🤖<br/>
Thanks for your order!<br/>
<b>Ref:</b> ${latestOrderData.order_public_id}<br/>
<b>Items:</b> ${latestOrderData.items.map(i=>`${i.name} x${i.qty}`).join(', ')}<br/>
<b>Total:</b> R${latestOrderData.total}<br/>
<b>Estimated window:</b> ${eta}`
    );

    if(latestOrderData.status === "review_required"){
      appendBot(`<b>Note:</b> We're quickly reviewing this order for safety. We'll confirm shortly.`);
    } else {
      appendBot(`Choose your payment method below and tap <b>Pay</b>.`);
    }

    if(botPayChoice) botPayChoice.value = latestOrderData.payment_method;

  } finally {
    confirmBtn2.disabled = false;
    renderStats();
  }
});

// ========================================================================
// BOT PAY & WHATSAPP
// ========================================================================
botNext?.addEventListener('click', ()=>{
  if(!latestOrderData) return;

  const pay = botPayChoice?.value || selectedPay();
  latestOrderData.payment_method = pay;

  if(botStage === 0){
    if(pay === 'eft'){
      appendBot(
        `<b>Instant EFT (Ozow)</b><br/>
We'll WhatsApp you a secure Ozow link.<br/>
Use ref <code>${latestOrderData.order_public_id}</code>.`
      );
    } else if(pay === 'card'){
      appendBot(
        `We'll WhatsApp you a secure <b>card link</b> (Yoco).<br/>
Use ref <code>${latestOrderData.order_public_id}</code>.`
      );
    } else {
      const deposit = Math.ceil(latestOrderData.total*0.5);
      appendBot(
        `<b>50% deposit + COD</b><br/>
Pay deposit now: <b>R${deposit}</b>.<br/>
Balance due at delivery.<br/>
Ref <code>${latestOrderData.order_public_id}</code>.`
      );
    }

    appendBot(`This next screen is a demo. No money is taken here.`);
    openPayModal(latestOrderData.order_public_id, latestOrderData.total);
    botStage = 1;
    return;
  }

  appendBot(`Click "Contact support" so we can confirm the order and send the real secure payment link.`);
});

botSendWA?.addEventListener('click', () => {
  if(!latestOrderData){
    alert("No order data.");
    return;
  }

  const msg = latestOrderData.wa_message
    ? latestOrderData.wa_message
    : [
        "Yi Thume, my order is:",
        `Ref: ${latestOrderData.order_public_id}`,
        `Items: ${latestOrderData.items.map(i=>`${i.name} x${i.qty}`).join(', ')}`,
        `Total: R${latestOrderData.total}`,
        `Expected: ${latestOrderData.eta}`,
        `Payment: ${latestOrderData.payment_method}`,
        "Please confirm + send payment link."
      ].join("\n");

  const wa = `https://wa.me/${WHATSAPP_NUMBER}?text=${waText(msg)}`;
  window.open(wa,'_blank');

  closeBot();
  alert(`Order sent to WhatsApp. Ref: ${latestOrderData.order_public_id}`);
});

botNewOrder?.addEventListener('click', ()=>{
  closeBot();
  openOrder();
});

// ========================================================================
// REFRESH ALL DATA
// ========================================================================
async function refreshAllData(){
  if(DEMO_MODE){
    hydrateState();
    const map = {};
    Object.values(DEMO_ORDERS_DB).forEach(o=>{
      const key = o._internal_id || o.internal_id || o.order_public_id || o.order_id;
      if(key) map[key] = o;
    });
    ALL_ORDERS_MAP = map;
    renderOrders();
    renderDrivers();
    renderStats();
    return;
  }

  const orders = await fetchAllOrders();
  await fetchDrivers();

  const map = {};
  orders.forEach(o=>{
    const key =
      o._internal_id || o.internal_id ||
      o.order_public_id || o.order_id ||
      Math.random().toString(36).slice(2);
    map[key] = o;
  });
  ALL_ORDERS_MAP = map;

  renderOrders();
  renderDrivers();
  renderStats();
}

// ========================================================================
// FINAL INIT
// ========================================================================
renderStoreItems();

if (DEMO_MODE) {
  // Ensure demo data is hydrated
  hydrateState();

  const map = {};
  Object.values(DEMO_ORDERS_DB).forEach(o => {
    const key = o._internal_id || o.internal_id || o.order_public_id || o.order_id;
    if (key) map[key] = o;
  });
  ALL_ORDERS_MAP   = map;
  DRIVERS          = Object.values(DEMO_DRIVERS_DB);
  API_DRIVERS_MAP  = { ...DEMO_DRIVERS_DB };

  ensureAdminTabs();
  setActiveAdminTab(ordersTab);   // default "Pending"

  renderOrders();
  renderDrivers();
  renderAdminStats();             // 🔴 build + populate Stats UI
} else {
  // Live mode: load from API first, then wire UI
  refreshAllData().then(() => {
    ensureAdminTabs();
    setActiveAdminTab(ordersTab); // default "Pending"
    renderAdminStats();           // 🔴 ensure Stats DOM + numbers exist
  });
}
}); // end DOMContentLoaded
</script>







</body>
</html>
