<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Favicon: Gradient square with a white Y -->
  <link
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%2310b981'/%3E%3Cstop offset='100%25' stop-color='%23059669'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect rx='12' width='36' height='36' fill='url(%23g)'/%3E%3Cpath d='M10 10h4l4 4 4-4h4l-8 8v8h-4v-8z' fill='%23fff'/%3E%3C/svg%3E"
  />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YiThume — Health delivered. Fast.</title>
  <meta name="description" content="YiThume delivers OTC meds to remote areas. Order on website, confirm on WhatsApp. Port Alfred, Bathurst, Kenton-on-Sea, Makhanda, Alice, Alexandria, Alicedale." />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --emerald-600:#059669; --emerald-500:#10b981; --emerald-400:#34d399; --emerald-800:#047857; --emerald-900:#065f46;
      --map-bg:#f6f8f9; --hero-h: 360px;
    }
    @media (max-width:640px){ :root{ --hero-h: 280px; } }

    /* Leaflet layers above Tailwind sections */
    .leaflet-pane,
    .leaflet-top,
    .leaflet-bottom { z-index: 10 !important; }
    #heroMap{
      height:var(--hero-h);
      border-radius:16px;
      position:relative;
      overflow:hidden;
      background:var(--map-bg);
    }
    .leaflet-control-container{display:none;}

    /* Animated map markers */
    .car-dot{transform:translate(-50%,-50%);}
    .car-dot svg{
      width:18px;
      height:18px;
      filter:drop-shadow(0 1px 1px rgba(0,0,0,.18));
    }
    .pkg-dot{transform:translate(-50%,-50%);}
    .pkg-dot svg{
      width:20px;
      height:20px;
      filter:drop-shadow(0 1px 1px rgba(0,0,0,.15))
    }

    /* Overlay tint + region badge */
    .tint{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(5,150,105,.04),rgba(5,150,105,.03));
      pointer-events:none;
    }
    .ec-badge{
      position:absolute;
      left:14px;
      bottom:12px;
      padding:6px 10px;
      border-radius:10px;
      background:rgba(15,23,42,.75);
      color:#fff;
      font-size:12px;
      line-height:1.2;
      backdrop-filter: blur(2px);
    }

    /* Body scroll lock class used while modals are open */
    .overflow-locked {
      overflow: hidden;
      touch-action: none;
    }

    /* =========================
       Orders Admin layout helpers
       ========================= */
    .yt-modal-body{
      max-height:70vh;      /* scroll body only */
      overflow-y:auto;
    }
    .yt-sticky{ position:sticky; z-index:10; background:#fff; }
    .yt-sticky-top{ top:0; }
    .yt-sticky-bottom{ bottom:0; }
    .yt-chip{ line-height:1.1; }

    /* Driver card grid for "Drivers" tab content */
    .yt-driver-card{
      display:grid;
      grid-template-columns: 1fr auto; /* info | actions */
      gap:.75rem;
    }
    @media (max-width:640px){
      .yt-driver-card{ grid-template-columns: 1fr; } /* stack on mobile */
    }
    .yt-actions{
      display:flex; align-items:flex-start; justify-content:flex-end;
      gap:.5rem; flex-wrap:wrap;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900">

<!-- Header -->
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <!-- Header logo: Gradient square with a white Y -->
      <svg width="36" height="36" viewBox="0 0 36 36" class="rounded-2xl" aria-label="YiThume logo">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stop-color="#10b981"/><stop offset="100%" stop-color="#059669"/>
          </linearGradient>
        </defs>
        <rect rx="12" width="36" height="36" fill="url(#g)"/>
        <path d="M10 10h4l4 4 4-4h4l-8 8v8h-4v-8z" fill="#fff"/>
      </svg>
      <div class="text-xl font-semibold tracking-tight">YiThume</div>
    </div>

    <!-- Desktop nav -->
    <nav class="hidden md:flex items-center gap-6" aria-label="Primary">
      <a href="#how" class="text-sm hover:text-emerald-700">How It Works</a>
      <a href="#services" class="text-sm hover:text-emerald-700">Services</a>
      <a href="#pricing" class="text-sm hover:text-emerald-700">Pricing</a>
      <a href="#drivers" class="text-sm hover:text-emerald-700">For Drivers</a>
      <a href="#faq" class="text-sm hover:text-emerald-700">FAQ</a>
    </nav>

    <div class="flex items-center gap-2">
      <!-- Mobile hamburger -->
      <button id="mobileMenuBtn"
        class="md:hidden p-2 rounded-lg border border-slate-300 active:scale-95 transition"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobileNavDropdown">
        <svg id="mobileMenuIconOpen" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 6h16M4 12h16M4 18h16"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg id="mobileMenuIconClose" width="20" height="20" viewBox="0 0 24 24" class="hidden" fill="none" aria-hidden="true">
          <path d="M6 6L18 18M6 18L18 6"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <!-- CTAs (desktop / sm+) -->
      <div class="hidden sm:flex items-center gap-2">
        <button id="openOrderBuilderTop"
          class="px-3 py-2 text-sm rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
          Start order
        </button>
        <button id="openDriverModalTop"
          class="px-3 py-2 text-sm rounded-xl border border-slate-300 hover:bg-slate-100">
          Driver sign-in / up
        </button>

        <button id="adminLoginBtn"
          class="px-3 py-2 text-xs rounded-xl border border-slate-300 hover:bg-slate-100">
          Admin
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile dropdown nav -->
  <div id="mobileNavDropdown"
       class="md:hidden hidden border-t border-slate-200 bg-white shadow-xl"
       role="menu" aria-label="Mobile navigation">
    <nav class="px-4 py-4 text-sm flex flex-col gap-2 max-w-6xl mx-auto w-full">
      <a href="#how" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">How It Works</a>
      <a href="#services" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">Services</a>
      <a href="#pricing" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">Pricing</a>
      <a href="#drivers" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">For Drivers</a>
      <a href="#faq" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">FAQ</a>

      <div class="h-px bg-slate-200 my-3"></div>

      <button id="openOrderBuilderTopMobile"
        class="w-full py-2 rounded-xl bg-emerald-600 text-white text-center active:scale-[.98] transition mobile-nav-link">
        Start order
      </button>

      <button id="openDriverModalTopMobile"
        class="w-full py-2 rounded-xl border border-slate-300 text-center active:scale-[.98] transition mobile-nav-link">
        Driver sign-in / up
      </button>

      <button id="adminLoginBtnMobile"
        class="w-full py-2 rounded-xl border border-slate-300 text-center text-xs active:scale-[.98] transition mobile-nav-link">
        Admin
      </button>
    </nav>
  </div>
</header>

<!-- Hero -->
<section class="relative">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-14 sm:py-20 grid md:[grid-template-columns:1.2fr_1fr] gap-10 items-stretch">
    <!-- Left card -->
    <div class="flex">
      <div class="rounded-3xl border bg-white p-6 shadow-sm h-full w-full min-h-[var(--hero-h)] flex flex-col">
        <div>
          <h1 class="text-4xl sm:text-5xl font-bold leading-tight">
            Health delivered. <span class="text-emerald-600">Fast</span>.
          </h1>
          <p class="mt-4 text-slate-700 max-w-xl">
            Order on the website, then we confirm and send a secure payment link in WhatsApp. Clear pricing, trusted local drivers.
          </p>
        </div>
        <ul class="mt-6 grid grid-cols-2 gap-3 text-sm">
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Website ➜ WhatsApp</b>
              <div class="text-slate-500 text-xs">No app needed</div>
            </div>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Same-day windows</b>
              <div class="text-slate-500 text-xs">08–10 • 12–14 • 16–18</div>
            </div>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Card or EFT</b>
              <div class="text-slate-500 text-xs">Yoco link / Ozow EFT</div>
            </div>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Deposit + COD</b>
              <div class="text-slate-500 text-xs">Returning customers only</div>
            </div>
          </li>
        </ul>
        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <button id="openOrderBuilder" class="px-5 py-3 rounded-2xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700">
            Start order
          </button>
          <button id="openDriverModal" class="px-5 py-3 rounded-2xl border border-slate-300 text-slate-800 text-sm font-medium hover:bg-slate-100">
            Sign up / Log in (Driver)
          </button>
        </div>
        <div class="mt-3 text-xs text-slate-500">Build your basket here — we’ll send it to WhatsApp for confirmation &amp; payment.</div>
        <div class="mt-auto"></div>
      </div>
    </div>

    <!-- Right map card -->
    <div class="flex">
      <div class="rounded-3xl border bg-white p-3 shadow-sm h-full w-full relative min-h-[var(--hero-h)]">
        <div class="flex items-center justify-between px-1 pb-2">
          <div class="text-sm text-slate-600">Coverage map</div>
          <span class="px-2 py-1 text-xs rounded-lg bg-emerald-100 text-emerald-700">LIVE</span>
        </div>
        <div id="heroMap" class="rounded-2xl" aria-label="Active delivery coverage map"></div>
        <div class="tint" aria-hidden="true"></div>
        <div class="ec-badge">Eastern Cape</div>
      </div>
    </div>
  </div>
</section>

<!-- How it works -->
<section id="how" class="py-12 sm:py-16 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <h2 class="text-2xl sm:text-3xl font-bold">How YiThume Works</h2>
    <div class="mt-6 grid md:grid-cols-4 gap-4">
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 1</div>
        <div class="mt-1 font-semibold">Build order</div>
        <p class="mt-2 text-sm text-slate-700">Choose items and your nearest pickup depot on the website.</p>
      </div>
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 2</div>
        <div class="mt-1 font-semibold">WhatsApp confirm</div>
        <p class="mt-2 text-sm text-slate-700">We send summary + payment instructions in WhatsApp.</p>
      </div>
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 3</div>
        <div class="mt-1 font-semibold">Pay online</div>
        <p class="mt-2 text-sm text-slate-700">
          Card link (Yoco) or Instant EFT (Ozow). Returning customers can do 50% deposit + COD.
        </p>
      </div>
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 4</div>
        <div class="mt-1 font-semibold">Delivery</div>
        <p class="mt-2 text-sm text-slate-700">
          We dispatch a verified local driver in your time window.
        </p>
      </div>
    </div>
  </div>
</section>

<!-- Services / Drivers pitch block -->
<section id="drivers" class="py-12 sm:py-16 border-t border-slate-200 bg-white/50">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 grid md:grid-cols-2 gap-8">
    <div class="rounded-2xl border bg-white shadow-sm p-6 flex flex-col">
      <div class="text-xs font-semibold uppercase tracking-wide text-emerald-700">Drive with us</div>
      <h2 class="text-2xl sm:text-3xl font-bold mt-2 leading-tight">
        We deliver to remote locations using trusted local drivers.
      </h2>
      <p class="mt-3 text-sm text-slate-700 leading-relaxed">
        Sign up to put your community on the map and get paid per successful delivery.
        Flexible windows, weekly EFT payouts.
      </p>
      <ul class="mt-4 text-sm space-y-2">
        <li class="flex items-start gap-2">
          <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700 text-[11px] font-bold">1</span>
          <div>
            Take small health + essentials orders from local shops to local people.
          </div>
        </li>
        <li class="flex items-start gap-2">
          <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700 text-[11px] font-bold">2</span>
          <div>
            Get a payout per drop. You’ll always see the amount before you accept.
          </div>
        </li>
        <li class="flex items-start gap-2">
          <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700 text-[11px] font-bold">3</span>
          <div>
            We handle payment and customer support. You just deliver.
          </div>
        </li>
      </ul>

      <button id="openDriverModalSection"
        class="mt-6 inline-flex justify-center px-4 py-3 rounded-xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700">
        Become a driver
      </button>

      <div class="mt-3 text-[11px] text-slate-500 leading-snug">
        We’re especially looking for reliable drivers in rural / township areas.
      </div>
    </div>

    <div class="rounded-2xl border bg-white shadow-sm p-6 flex flex-col" id="services">
      <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">What we deliver</div>
      <h2 class="text-xl sm:text-2xl font-bold mt-2 leading-tight">OTC meds &amp; essentials</h2>
      <p class="mt-3 text-sm text-slate-700 leading-relaxed">
        Flu, pain, stomach, allergy, dressings, hydration, pads, nappies, hygiene basics —
        all from local independent pharmacies and shops.
      </p>
      <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">Headache &amp; fever</div>
          <div class="text-[11px] text-slate-500">Panado, etc.</div>
        </div>
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">Cold &amp; flu</div>
          <div class="text-[11px] text-slate-500">Cough syrups, throat</div>
        </div>
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">Tummy &amp; hydration</div>
          <div class="text-[11px] text-slate-500">Electrolytes, nausea</div>
        </div>
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">First aid &amp; hygiene</div>
          <div class="text-[11px] text-slate-500">Bandages, pads, etc.</div>
        </div>
      </div>

      <div class="mt-auto pt-6 text-[11px] text-slate-500 leading-snug">
        We are a delivery service only. We do not provide medical advice.
      </div>
    </div>
  </div>
</section>

<!-- Pricing (distance-based, no zones) -->
<section id="pricing" class="py-12 sm:py-16 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <h2 class="text-2xl sm:text-3xl font-bold">Pricing</h2>

    <div class="mt-6 grid md:grid-cols-3 gap-4">
      <div class="rounded-2xl border bg-white p-5 shadow-sm">
        <div class="text-sm text-slate-500">Base</div>
        <div class="mt-1 text-2xl font-bold">R15</div>
        <div class="mt-2 text-sm text-slate-600">Base delivery fee per order.</div>
      </div>
      <div class="rounded-2xl border bg-white p-5 shadow-sm">
        <div class="text-sm text-slate-500">Distance</div>
        <div class="mt-1 text-2xl font-bold">R8 / km</div>
        <div class="mt-2 text-sm text-slate-600">From pickup depot to your address.</div>
      </div>
      <div class="rounded-2xl border bg-white p-5 shadow-sm">
        <div class="text-sm text-slate-500">Rush (optional)</div>
        <div class="mt-1 text-2xl font-bold">+ R30</div>
        <div class="mt-2 text-sm text-slate-600">When available in your area.</div>
      </div>
    </div>

    <div class="mt-6 rounded-2xl border bg-white p-5 shadow-sm">
      <div class="text-sm text-slate-500">Pickup depots (select in checkout)</div>
      <ul class="mt-2 text-sm text-slate-700 list-disc pl-5">
        <li>Port Alfred Depot</li>
        <li>Alice Depot</li>
        <li>Makhanda / Grahamstown</li>
        <li>Gqeberha (Port Elizabeth)</li>
        <li>Pretoria (Main Depot)</li>
      </ul>
      <div class="mt-3 text-xs text-slate-500">
        No defaults — choose the nearest pickup depot at checkout for the most accurate quote.
      </div>
    </div>

    <div class="mt-4 text-xs text-slate-500">Delivery days: Wed–Sun. Windows: 08–10 • 12–14 • 16–18. If we can’t deliver, you’re refunded.</div>
  </div>
</section>

<!-- FAQ -->
<section id="faq" class="py-12 sm:py-16 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <h2 class="text-2xl sm:text-3xl font-bold">FAQ</h2>
    <div class="mt-6 grid md:grid-cols-2 gap-4">
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">How do I pay?</summary>
        <p class="mt-2 text-sm text-slate-700">
          We send a secure <b>Yoco card link</b> or <b>Ozow Instant EFT</b> via WhatsApp. Returning customers may use
          <b>50% deposit + COD</b> for the balance at delivery.
        </p>
      </details>
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">Cash on delivery?</summary>
        <p class="mt-2 text-sm text-slate-700">
          To keep orders safe, first-time customers pay online. For repeat customers, COD is available with a
          <b>50% deposit</b>. Drivers wait up to 5 minutes. Failed delivery forfeits the deposit.
        </p>
      </details>
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">Do you give medical advice?</summary>
        <p class="mt-2 text-sm text-slate-700">
          No. YiThume provides delivery only. Always follow your healthcare provider’s guidance.
        </p>
      </details>
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">Where do you operate?</summary>
        <p class="mt-2 text-sm text-slate-700">
          Port Alfred, Bathurst, Kenton-on-Sea, Makhanda/Grahamstown, Alice, Alexandria, Alicedale (more soon).
        </p>
      </details>
    </div>
  </div>
</section>

<!-- Footer -->
<footer class="py-10 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div class="flex items-center gap-2">
        <!-- Mini Y logo in footer for consistency -->
        <svg width="24" height="24" viewBox="0 0 36 36" class="rounded-xl" aria-hidden="true">
          <defs>
            <linearGradient id="gf" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0%" stop-color="#10b981"/><stop offset="100%" stop-color="#059669"/>
            </linearGradient>
          </defs>
          <rect rx="8" width="36" height="36" fill="url(#gf)"/>
          <path d="M10 10h4l4 4 4-4h4l-8 8v8h-4v-8z" fill="#fff"/>
        </svg>
        <div>
          <div class="font-semibold">YiThume</div>
          <div class="text-xs text-slate-500">
            Delivery service only • POPIA compliant • © <span id="year"></span>
          </div>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row gap-3">
        <button id="openOrderBuilderFooter"
          class="px-3 py-2 text-sm rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
          Start order
        </button>
        <button id="openDriverModalFooter"
          class="px-3 py-2 text-sm rounded-xl border border-slate-300 hover:bg-slate-100">
          Driver sign-in / up
        </button>
        <button id="openStoreModalFooter"
          class="px-3 py-2 text-sm rounded-xl border border-emerald-300 text-emerald-700 hover:bg-emerald-50">
          Add your store
        </button>
      </div>
    </div>
  </div>
</footer>

<!-- Driver Auth Modal -->
<div id="driverModal"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[9999] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="driverModalTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-md flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold">
        <div id="driverModalTitle">Driver Portal</div>
        <div class="text-xs text-slate-500">Get paid weekly per drop</div>
      </div>
      <button id="closeDriverModal" class="text-slate-500 hover:text-slate-700" aria-label="Close driver modal">✕</button>
    </div>

    <div class="p-4 text-sm">
      <div class="flex gap-2 mb-4" role="tablist" aria-label="Driver auth tabs">
        <button id="tabSignup" class="flex-1 py-2 text-center rounded-lg bg-emerald-600 text-white" role="tab" aria-selected="true">Sign up</button>
        <button id="tabLogin"  class="flex-1 py-2 text-center rounded-lg border border-slate-300" role="tab" aria-selected="false">Log in</button>
      </div>

      <!-- Signup form -->
      <form id="driverFormSignup" class="space-y-3" aria-label="Driver signup form">
        <label class="block">
          <div class="text-xs font-medium text-slate-600">Full Name</div>
          <input id="drvName" class="mt-1 w-full border rounded-lg p-2" placeholder="Name" required />
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">WhatsApp Number</div>
          <input id="drvPhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required />
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">Your Zone</div>
          <select id="drvZone" class="mt-1 w-full border rounded-lg p-2">
            <option value="A">Zone A – Port Alfred</option>
            <option value="B">Zone B – Bathurst</option>
            <option value="C">Zone C – Kenton</option>
            <option value="D">Zone D – Makhanda / Grahamstown / Alice</option>
            <option value="E">Zone E – Alexandria / Alicedale</option>
          </select>
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">How far you’ll drive (km)</div>
          <input id="drvRadius" type="number" min="1" class="mt-1 w-full border rounded-lg p-2" value="10" />
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">Vehicle (car, bakkie, scooter, etc.)</div>
          <input id="drvVehicle" class="mt-1 w-full border rounded-lg p-2" placeholder="e.g. Polo Vivo" />
        </label>

        <button type="submit" class="w-full py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700">
          Submit
        </button>
      </form>

      <!-- Login form -->
      <form id="driverFormLogin" class="space-y-3 hidden" aria-label="Driver login form">
        <label class="block">
          <div class="text-xs font-medium text-slate-600">WhatsApp Number</div>
          <input id="drvLoginPhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required />
        </label>

        <button type="submit" class="w-full py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700">
          Log in
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Driver Dashboard Modal (Demo) -->
<div id="driverDashModal"
     class="fixed inset-0 hidden items-start justify-center pt-12 sm:pt-16 bg-black/40 p-4 z-[10000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="driverDashTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-md flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold">
        <div id="driverDashTitle">Driver Dashboard</div>
        <div class="text-xs text-slate-500">Your current stats</div>
      </div>
      <button id="closeDriverDash" class="text-slate-500 hover:text-slate-700" aria-label="Close driver dashboard modal">✕</button>
    </div>

    <div class="p-4 text-sm space-y-3">
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Pending balance</div>
        <div class="text-lg font-semibold">R<span id="driverPayoutPending">0</span></div>
        <div class="text-[11px] text-slate-500 leading-snug">
          You’ve accepted these drops. Waiting for admin approval.
        </div>
      </div>
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Approved payout</div>
        <div class="text-lg font-semibold">R<span id="driverPayoutApproved">0</span></div>
        <div class="text-[11px] text-slate-500 leading-snug">
          Will be paid to you by EFT.
        </div>
      </div>
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Next delivery window</div>
        <div class="text-lg font-semibold" id="driverNextWindow">Fri 17:00</div>
      </div>
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Your zone / km radius</div>
        <div class="text-lg font-semibold">
          <span id="driverZoneDisplay">A</span> / <span id="driverRadiusDisplay">10km</span>
        </div>
      </div>
      <div class="text-[11px] text-slate-500 leading-snug">
        Drivers are paid weekly by EFT.
      </div>
    </div>
  </div>
</div>

<!-- Bot-style Checkout Modal -->
<div id="botChat"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[9500] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="botChatTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-md flex flex-col max-h-[80vh] outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="botChatTitle">Checkout</span>
        <span class="text-xs text-slate-500">We’ll confirm in WhatsApp</span>
      </div>
      <button id="closeBot" class="text-slate-500 hover:text-slate-700" aria-label="Close checkout modal">✕</button>
    </div>

    <div id="botFeed" class="flex-1 overflow-y-auto p-4 space-y-2 text-sm bg-slate-50" aria-live="polite"></div>

    <div class="p-4 border-t space-y-3 text-sm">
      <label class="block">
        <div class="text-xs font-medium text-slate-600">Payment method</div>
        <select id="botPayChoice" class="mt-1 w-full border rounded-lg p-2" aria-label="Payment method">
          <option value="card">Card (Yoco link)</option>
          <option value="eft">Instant EFT (Ozow)</option>
          <option value="deposit_cod">50% deposit + COD</option>
        </select>
      </label>

      <div class="flex flex-wrap gap-2">
        <button id="botNext" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700">
          Pay
        </button>
        <!-- Renamed label only (keep id for scripts) -->
        <button id="botSendWA" class="flex-1 py-2 rounded-xl border border-slate-300 font-medium hover:bg-slate-100 hidden">
          Contact support
        </button>
        <button id="botNewOrder" class="flex-1 py-2 rounded-xl border border-slate-300 font-medium hover:bg-slate-100 hidden">
          New order
        </button>
      </div>

      <div class="text-[11px] text-slate-500 leading-snug" id="botDemoNote" hidden>
        No money is taken — this is a demo. We’ll WhatsApp a real secure link.
      </div>
    </div>
  </div>
</div>

<!-- FAKE Payment Modal -->
<div id="payModal"
     class="fixed inset-0 hidden items-start justify-center pt-20 bg-black/60 p-4 z-[9600] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="payModalTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-sm flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="payModalTitle">Secure Payment (Demo)</span>
        <span class="text-xs text-slate-500">This is a preview — no real charge yet</span>
      </div>
      <button id="closePayModal" class="text-slate-500 hover:text-slate-700" aria-label="Close payment modal">✕</button>
    </div>

    <div class="p-4 text-sm space-y-2">
      <div><b>Order Ref:</b> <span id="payOrderRef">--</span></div>
      <div><b>Amount:</b> R<span id="payAmount">0</span></div>
      <div class="text-[11px] text-slate-500 leading-snug">
        We’ll send the real Yoco / Ozow payment link in WhatsApp once confirmed.
      </div>
      <div class="text-[11px] text-emerald-700 leading-snug font-medium">
        No money is taken here. This is just a demo.
      </div>
    </div>

    <div class="p-4 border-t flex flex-col sm:flex-row gap-2 text-sm">
      <button id="btnFakePayNow" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
        Pay
      </button>
      <button id="btnCancelPay" class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Order Builder Modal -->
<div id="orderBuilder"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[9000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="orderBuilderTitle">
  <div class="w-full max-w-xl rounded-2xl bg-white shadow-xl border flex flex-col max-h-[85vh] outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="orderBuilderTitle">Your Order</span>
        <span class="text-xs text-slate-500">We’ll confirm by WhatsApp</span>
      </div>
      <button id="closeOrderBuilder" class="text-slate-500 hover:text-slate-700" aria-label="Close order builder modal">✕</button>
    </div>

    <div class="flex-1 overflow-y-auto p-4 space-y-5 text-sm">
      <!-- Items list -->
      <div>
        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-600 font-medium">Items</div>
          <button id="addCustomItem" class="text-[11px] text-emerald-700 underline">+ Add custom</button>
        </div>
        <div id="itemsList" class="mt-2 grid gap-2"></div>
      </div>

      <!-- Pickup depot (no default; JS will populate) -->
      <div>
        <label class="block text-xs text-slate-600 font-medium">Pickup depot</label>
        <select id="zoneSelect" class="mt-1 w-full border rounded-lg p-2" aria-label="Pickup depot">
          <!-- Options injected by JS (no default) -->
        </select>
        <div class="flex items-center gap-2 mt-2">
          <input id="rushToggle" type="checkbox" class="h-4 w-4" />
          <label for="rushToggle" class="text-xs text-slate-600">
            Rush (+R30 when available)<span id="rushNote" class="text-[10px] text-amber-700"></span>
          </label>
        </div>
      </div>

      <!-- Customer details -->
      <div class="grid sm:grid-cols-2 gap-3">
        <label class="block">
          <div class="text-xs text-slate-600 font-medium">Your name</div>
          <input id="custName" class="mt-1 w-full border rounded-lg p-2" placeholder="Full name" required />
        </label>
        <label class="block">
          <div class="text-xs text-slate-600 font-medium">WhatsApp number</div>
          <input id="custPhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required />
        </label>
      </div>

      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Delivery address</div>
        <textarea id="custAddress" class="mt-1 w-full border rounded-lg p-2" rows="2" placeholder="House number, street, area" required></textarea>
      </label>

      <!-- Payment choice -->
      <div>
        <div class="text-xs text-slate-600 font-medium mb-1">How will you pay?</div>
        <div class="space-y-2">
          <label class="flex items-start gap-2">
            <input type="radio" name="pay" value="card" class="mt-1" checked>
            <div>
              <div class="text-sm font-medium">Card link (Yoco)</div>
              <div class="text-[11px] text-slate-500">Tap and pay from your phone.</div>
            </div>
          </label>

          <label class="flex items-start gap-2">
            <input type="radio" name="pay" value="eft" class="mt-1">
            <div>
              <div class="text-sm font-medium">Instant EFT (Ozow)</div>
              <div class="text-[11px] text-slate-500">Instant secure bank transfer.</div>
            </div>
          </label>

          <label class="flex items-start gap-2">
            <input type="radio" name="pay" value="deposit_cod" class="mt-1">
            <div>
              <div class="text-sm font-medium">50% deposit + COD</div>
              <div class="text-[11px] text-slate-500">Returning customers only.</div>
            </div>
          </label>
        </div>
      </div>

      <!-- Deposit banner -->
      <div id="depositBanner"
           class="hidden rounded-lg border border-amber-300 bg-amber-50 text-amber-800 text-[11px] leading-snug p-2">
        You’ll pay a deposit of R<span id="depositAmt">0</span> to lock your driver. Balance on delivery.
      </div>

      <!-- Total -->
      <div class="rounded-xl bg-slate-50 border p-3 text-sm flex flex-col gap-2">
        <div class="flex justify-between">
          <div>Total to pay now</div>
          <div class="font-semibold">R<span id="orderTotal">0</span></div>
        </div>
        <div class="text-[11px] text-slate-500 leading-snug">
          We’ll confirm and send a payment link on WhatsApp. If we can’t deliver, you’re refunded.
        </div>
      </div>
    </div>

    <div class="p-4 border-t flex flex-col sm:flex-row gap-2 text-sm">
      <button id="confirmOrderBtn"
              class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
        Confirm &amp; Continue
      </button>
      <button class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100" id="cancelOrderBuilder">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Orders Panel (Admin) -->
<div id="ordersPanel"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[11000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="ordersPanelTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-4xl flex flex-col outline-none" tabindex="-1">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b yt-sticky yt-sticky-top">
      <div class="font-semibold flex flex-col">
        <span id="ordersPanelTitle">Orders Admin</span>
        <span class="text-xs text-slate-500">Assign drivers • Mark delivered</span>
      </div>
      <button id="closeOrdersPanel" class="text-slate-500 hover:text-slate-700" aria-label="Close admin panel">✕</button>
    </div>

    <!-- Tabs (injected by JS) -->
    <div id="ordersTabs" class="p-3 border-b yt-sticky yt-sticky-top flex flex-wrap gap-2 text-xs" role="tablist" aria-label="Order status filter">
      <!-- JS will inject tab buttons -->
    </div>

    <!-- Scrollable body (orders + drivers sections; show/hide via JS tabs) -->
    <div class="yt-modal-body">
      <!-- Orders list (populated by JS) -->
      <div class="p-4 space-y-4 text-sm" id="ordersList" aria-live="polite">
        <!-- JS fills orders -->
      </div>

      <!-- Drivers section (shown when Drivers tab active; populated by JS) -->
      <div class="px-4 pb-4 space-y-3">
        <div class="flex gap-2">
          <button id="driversRefresh" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 text-sm">
            Drivers refresh
          </button>
        </div>
        <div id="driversList" class="divide-y divide-slate-200 rounded-xl border text-sm">
          <!-- JS fills drivers table/cards -->
        </div>
      </div>
    </div>

    <!-- Sticky footer actions -->
    <div class="p-4 border-t yt-sticky yt-sticky-bottom">
      <div class="flex flex-col sm:flex-row gap-2 text-sm">
        <button id="ordersRefresh" class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">
          Refresh
        </button>
        <button id="ordersAssign" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
          Auto assign all
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Store Onboarding Modal -->
<div id="storeModal"
     class="fixed inset-0 hidden items-start justify-center pt-12 sm:pt-16 bg-black/40 p-4 z-[12000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="storeModalTitle">
  <div class="w-full max-w-xl rounded-2xl bg-white shadow-xl border flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="storeModalTitle">Add Your Store</span>
        <span class="text-xs text-slate-500">We’ll list your items for delivery</span>
      </div>
      <button id="closeStoreModal" class="text-slate-500 hover:text-slate-700" aria-label="Close store modal">✕</button>
    </div>

    <div class="p-4 space-y-4 text-sm">
      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Store name</div>
        <input id="storeName" class="mt-1 w-full border rounded-lg p-2" placeholder="e.g. Bathurst Health Shop" required>
      </label>

      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Store WhatsApp</div>
        <input id="storePhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required>
      </label>

      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Zone</div>
        <select id="storeZone" class="mt-1 w-full border rounded-lg p-2">
          <option value="A">Zone A – Port Alfred</option>
          <option value="B">Zone B – Bathurst</option>
          <option value="C">Zone C – Kenton / Bushmans</option>
          <option value="D">Zone D – Makhanda / Eirini</option>
          <option value="E">Zone E – Alexandria / Alicedale</option>
        </select>
      </label>

      <div>
        <div class="text-xs text-slate-600 font-medium mb-2 flex items-center justify-between">
          <span>Items you sell</span>
          <button id="addStoreItem" class="text-emerald-700 underline text-[11px]">+ Add item</button>
        </div>
        <div id="storeItemsList" class="space-y-2"></div>
      </div>

      <div class="rounded-lg bg-slate-50 border p-2 text-[11px] text-slate-600 leading-snug">
        We'll review and then list your store so people can buy through YiThume and get same-day local delivery.
      </div>
    </div>

    <div class="p-4 border-t flex flex-col sm:flex-row gap-2 text-sm">
      <button id="submitStore" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
        Submit store
      </button>
      <button id="cancelStore" class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">
        Cancel
      </button>
    </div>
  </div>
</div>
<script>
window.addEventListener('DOMContentLoaded', () => {
  // === CONFIG & GLOBALS ======================================================
  const BASE_API        = "/api/app";
  const WHATSAPP_NUMBER = "270691456201"; // customer support / business inbox
  const ADMIN_WHATSAPP  = "270691456201";
  const DEMO_MODE       = false; // all writes go to backend

  // Delivery math
  const BASE_DELIVERY_FEE = 15; // R
  const PER_KM_PRICE      = 8;  // R per km
  const RUSH_FEE          = 30; // R flat

  // UI Colors
  const emerald = { 600:'#059669', 500:'#10b981', 400:'#34d399' };

  // Helpers
  const waText  = (str) => encodeURIComponent(str);
  const digits  = (val) => (val || "").replace(/\D+/g, "");
  const clamp   = (v,lo,hi)=> Math.min(hi, Math.max(lo, v));

  // Haversine fallback (km)
  const kmBetween = (a,b)=>{
    if(!a||!b) return 0;
    const R = 6371;
    const dLat = (b.lat-a.lat)*Math.PI/180;
    const dLng = (b.lng-a.lng)*Math.PI/180;
    const s1 = Math.sin(dLat/2)**2 +
      Math.cos(a.lat*Math.PI/180) *
      Math.cos(b.lat*Math.PI/180) *
      Math.sin(dLng/2)**2;
    return 2*R*Math.asin(Math.sqrt(s1));
  };

  // === BODY SCROLL LOCK + FOCUS RESTORE =====================================
  const lastFocus = new Map();
  const firstFocusable = (el) =>
    el?.querySelector?.('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
  const lockScroll = () => document.body.classList.add('overflow-locked');
  const unlockScroll = () => document.body.classList.remove('overflow-locked');

  function openFlex(el){
    if(!el) return;
    lastFocus.set(el, document.activeElement);
    el.classList.remove('hidden');
    el.classList.add('flex');
    lockScroll();
    setTimeout(()=>{
      const ff = firstFocusable(el);
      if(ff) ff.focus();
    }, 0);
  }
  function closeFlex(el){
    if(!el) return;
    el.classList.add('hidden');
    el.classList.remove('flex');
    unlockScroll();
    const prev = lastFocus.get(el);
    if(prev && typeof prev.focus === 'function') prev.focus();
  }

  // ESC closes topmost modal
  document.addEventListener('keydown', (e)=>{
    if(e.key !== 'Escape') return;
    const modals = [
      document.getElementById('ordersPanel'),
      document.getElementById('storeModal'),
      document.getElementById('driverDashModal'),
      document.getElementById('driverModal'),
      document.getElementById('payModal'),
      document.getElementById('botChat'),
      document.getElementById('orderBuilder')
    ];
    for(const m of modals){
      if(m && !m.classList.contains('hidden')) {
        closeFlex(m);
        break;
      }
    }
  });

  // === RUNTIME / GLOBAL STATE ===============================================
  let latestOrderData = null;
  let botStage = 0;

  // Admin tab state
  let ordersTab = 'orders';
  const currentOrdersByTab = {};
  let DRIVERS = [];
  let DRIVERS_BY_ID = Object.create(null);

  let DELIVERY_COORDS   = null;
  let COLLECTION_COORDS = {lat:-33.590, lng:26.890};

  const driverTotals = { pending: 0, approved: 0 };
  const storeItems = [];

  // === YEAR FOOTER ===========================================================
  const yearEl = document.getElementById('year');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // === ELEMENT REFS ==========================================================
  const mobileBtn       = document.getElementById('mobileMenuBtn');
  const mobileDropdown  = document.getElementById('mobileNavDropdown');
  const mobileIconOpen  = document.getElementById('mobileMenuIconOpen');
  const mobileIconClose = document.getElementById('mobileMenuIconClose');

  const modal               = document.getElementById('orderBuilder');
  const closeBtn            = document.getElementById('closeOrderBuilder');
  const cancelOrderBuilder  = document.getElementById('cancelOrderBuilder');
  const itemsList           = document.getElementById('itemsList');

  const zoneSelect          = document.getElementById('zoneSelect');
  const rushToggle          = document.getElementById('rushToggle');
  const totalEl             = document.getElementById('orderTotal');
  const rushNote            = document.getElementById('rushNote');
  const depositBanner       = document.getElementById('depositBanner');
  const depositAmtEl        = document.getElementById('depositAmt');
  const custNameEl          = document.getElementById('custName');
  const custPhoneEl         = document.getElementById('custPhone');
  const custAddrEl          = document.getElementById('custAddress');

  const adminBtn            = document.getElementById('adminLoginBtn');

  const confirmBtn2         = document.getElementById('confirmOrderBtn');
  const botModal            = document.getElementById('botChat');
  const botFeed             = document.getElementById('botFeed');
  const botNext             = document.getElementById('botNext');
  const botSendWA           = document.getElementById('botSendWA');
  const botNewOrder         = document.getElementById('botNewOrder');
  const botPayChoice        = document.getElementById('botPayChoice');
  const botDemoNote         = document.getElementById('botDemoNote');

  const payModal            = document.getElementById('payModal');
  const payOrderRef         = document.getElementById('payOrderRef');
  const payAmountEl         = document.getElementById('payAmount');
  const closePayModalBtn    = document.getElementById('closePayModal');
  const btnFakePayNow       = document.getElementById('btnFakePayNow');
  const btnCancelPay        = document.getElementById('btnCancelPay');

  // Driver modal + forms
  const driverModal         = document.getElementById('driverModal');
  const closeDriver         = document.getElementById('closeDriverModal');
  const tabSignup           = document.getElementById('tabSignup');
  const tabLogin            = document.getElementById('tabLogin');
  const formSignup          = document.getElementById('driverFormSignup');
  const formLogin           = document.getElementById('driverFormLogin');
  const drvLoginPhoneEl     = document.getElementById('drvLoginPhone');
  const drvLoginPinEl       = document.getElementById('drvLoginPin');

  // Driver dash
  const driverDashModal         = document.getElementById('driverDashModal');
  const closeDriverDash         = document.getElementById('closeDriverDash');
  const driverPayoutPendingEl   = document.getElementById('driverPayoutPending');
  const driverPayoutApprovedEl  = document.getElementById('driverPayoutApproved');
  const driverNextWindowEl      = document.getElementById('driverNextWindow');
  const driverZoneDisplayEl     = document.getElementById('driverZoneDisplay');
  const driverRadiusDisplayEl   = document.getElementById('driverRadiusDisplay');

  // Admin Panel
  const ordersPanel         = document.getElementById('ordersPanel');
  const ordersList          = document.getElementById('ordersList');
  const ordersClose         = document.getElementById('closeOrdersPanel');
  const ordersAssign        = document.getElementById('ordersAssign');
  const ordersRefresh       = document.getElementById('ordersRefresh');
  const driversList         = document.getElementById('driversList');
  const driversRefresh      = document.getElementById('driversRefresh');
  const ordersTabsContainer = document.getElementById('ordersTabs');

  // Optional widgets (auto-created later if missing)
  let adminDriversCountEl = document.getElementById('adminDriversCount');
  let adminPayPendingEl   = document.getElementById('adminPayPending');
  let adminPayApprovedEl  = document.getElementById('adminPayApproved');
  let adminStatsOrdersEl  = document.getElementById('adminStatsOrders');
  let adminStatsRevenueEl = document.getElementById('adminStatsRevenue');
  let adminTopProductsEl  = document.getElementById('adminTopProducts');
  let adminTopAreasEl     = document.getElementById('adminTopAreas');

  // Store modal
  const storeModal          = document.getElementById('storeModal');
  const addStoreItemBtn     = document.getElementById('addStoreItem');
  const storeItemsList      = document.getElementById('storeItemsList');
  const openStoreFooter     = document.getElementById('openStoreModalFooter');
  const closeStoreModalBtn  = document.getElementById('closeStoreModal');
  const cancelStoreBtn      = document.getElementById('cancelStore');
  const submitStoreBtn      = document.getElementById('submitStore');
  const storeNameEl         = document.getElementById('storeName');
  const storePhoneEl        = document.getElementById('storePhone');
  const storeZoneEl         = document.getElementById('storeZone');

  // === COLLECTION POINTS =====================================================
  const COLLECTIONS = [
    { id:'DEPOT-PA',   name:'Port Alfred Depot',         lat:-33.590, lng:26.890 },
    { id:'DEPOT-ALC',  name:'Alice Depot',               lat:-32.787, lng:26.835 },
    { id:'DEPOT-GHT',  name:'Makhanda / Grahamstown',    lat:-33.310, lng:26.520 },
    { id:'DEPOT-PE',   name:'Gqeberha (Port Elizabeth)', lat:-33.961, lng:25.602 },
    { id:'DEPOT-PTA',  name:'Pretoria (Main Depot)',     lat:-25.747, lng:28.229 }
  ];

  function ensureCollectionSelectPopulated(){
    if(!zoneSelect || zoneSelect.dataset.enhanced === '1') return;

    zoneSelect.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = 'Select a pickup depot…';
    ph.disabled = true;
    ph.selected = true;
    zoneSelect.appendChild(ph);

    COLLECTIONS.forEach((c)=>{
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.name;
      opt.dataset.lat = String(c.lat);
      opt.dataset.lng = String(c.lng);
      zoneSelect.appendChild(opt);
    });
    zoneSelect.dataset.enhanced = '1';
  }

  // === CATALOG (demo) ========================================================
  const CATALOG = [
    {name:'Panado 500mg (24s)',price:35},
    {name:'Allergex 10mg (10s)',price:30},
    {name:'Cough Syrup 100ml',price:55},
    {name:'Electrolyte Sachet',price:15},
    {name:'Bandages (set)',price:25}
  ];

  // === ADMIN DATA HELPERS ====================================================
  async function fetchAllOrders(){
    try{
      const r = await fetch(`${BASE_API}/orders`);
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok) return [];
      return Array.isArray(j.orders) ? j.orders : [];
    }catch(e){
      console.error("fetchAllOrders", e);
      return [];
    }
  }

  async function fetchDrivers(){
    try{
      const r = await fetch(`${BASE_API}/drivers`);
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok){
        DRIVERS=[]; DRIVERS_BY_ID={}; return;
      }
      DRIVERS = Array.isArray(j.drivers) ? j.drivers : [];
      DRIVERS_BY_ID = Object.create(null);
      for(const d of DRIVERS){
        if(d && d._internal_id) DRIVERS_BY_ID[d._internal_id] = d;
        if(d && d.driver_id && !DRIVERS_BY_ID[d.driver_id]) DRIVERS_BY_ID[d.driver_id] = d;
      }
    }catch(e){
      console.error("fetchDrivers", e);
      DRIVERS=[]; DRIVERS_BY_ID={};
    }
  }

  function ensureContentHost(){
    if(!ordersPanel) return;
    if(!document.getElementById('ordersContent')){
      const content = document.createElement('div');
      content.id = 'ordersContent';
      content.className = 'w-full';
      const tabs = document.getElementById('ordersTabs');
      if(tabs && tabs.nextSibling){
        ordersPanel.insertBefore(content, tabs.nextSibling);
      } else if(tabs){
        ordersPanel.appendChild(content);
      } else {
        ordersPanel.appendChild(content);
      }
    }
  }

  // === ADMIN STATS / KPIs ====================================================
  async function renderAdminStats(){
    ensureContentHost();

    if(!document.getElementById('adminStatsWrap')){
      const stats = document.createElement('div');
      stats.id = 'adminStatsWrap';
      stats.className = 'hidden w-full';
      stats.innerHTML = `
        <div class="grid gap-3 sm:grid-cols-3">
          <div class="border rounded-xl p-3 flex flex-col">
            <div class="text-xs text-slate-500 mb-1">Total Orders</div>
            <div id="adminStatsOrders" class="text-2xl font-semibold">0</div>
          </div>
          <div class="border rounded-xl p-3 flex flex-col">
            <div class="text-xs text-slate-500 mb-1">Revenue</div>
            <div id="adminStatsRevenue" class="text-2xl font-semibold">R0</div>
          </div>
          <div class="border rounded-xl p-3 flex flex-col">
            <div class="text-xs text-slate-500 mb-1">Drivers & Payouts</div>
            <div class="text-sm"><b id="adminDriversCount">0</b> drivers</div>
            <div class="text-xs text-slate-500 mt-2">Payouts</div>
            <div class="text-xs">Pending: <b id="adminPayPending">R0</b></div>
            <div class="text-xs">Approved: <b id="adminPayApproved">R0</b></div>
          </div>
        </div>
        <div class="grid gap-3 sm:grid-cols-2 mt-4">
          <div class="border rounded-xl p-3">
            <div class="text-sm font-medium mb-2">Top Products</div>
            <ul id="adminTopProducts" class="text-sm space-y-1"></ul>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-sm font-medium mb-2">Top Areas (by collection)</div>
            <ul id="adminTopAreas" class="text-sm space-y-1"></ul>
          </div>
        </div>
      `;
      document.getElementById('ordersContent')?.appendChild(stats);
    }

    adminStatsOrdersEl  = document.getElementById('adminStatsOrders');
    adminStatsRevenueEl = document.getElementById('adminStatsRevenue');
    adminTopProductsEl  = document.getElementById('adminTopProducts');
    adminTopAreasEl     = document.getElementById('adminTopAreas');
    adminDriversCountEl = document.getElementById('adminDriversCount');
    adminPayPendingEl   = document.getElementById('adminPayPending');
    adminPayApprovedEl  = document.getElementById('adminPayApproved');

    const orders = await fetchAllOrders();
    const totalOrders = orders.length;
    const revenue = orders.reduce((s,o)=> s + Number(o.total||0), 0);

    if(adminStatsOrdersEl)  adminStatsOrdersEl.textContent  = String(totalOrders);
    if(adminStatsRevenueEl) adminStatsRevenueEl.textContent = `R${revenue}`;

    // Top products
    const prodMap = new Map();
    orders.forEach(o=>{
      (o.items||[]).forEach(it=>{
        const qty = Number(it.qty || 1);
        if(!it.name) return;
        prodMap.set(it.name, (prodMap.get(it.name)||0) + qty);
      });
    });
    const topProducts = Array.from(prodMap.entries())
      .sort((a,b)=>b[1]-a[1]).slice(0,5);
    if(adminTopProductsEl){
      adminTopProductsEl.innerHTML = topProducts.length
        ? topProducts.map(([name,c])=>`<li>${name} — <b>${c}</b></li>`).join('')
        : '<li class="text-slate-500">No data yet</li>';
    }

    // Top areas
    const areaMap = new Map();
    orders.forEach(o=>{
      const k = o.meta?.collection_name || '—';
      areaMap.set(k, (areaMap.get(k)||0)+1);
    });
    const topAreas = Array.from(areaMap.entries())
      .sort((a,b)=>b[1]-a[1]).slice(0,5);
    if(adminTopAreasEl){
      adminTopAreasEl.innerHTML = topAreas.length
        ? topAreas.map(([name,c])=>`<li>${name} — <b>${c}</b></li>`).join('')
        : '<li class="text-slate-500">No data yet</li>';
    }

    await fetchDrivers();
    recalcAdminPayoutWidgets();
  }

  // === CUSTOMER UI HELPERS ===================================================
  function renderItems(){
    if(!itemsList) return;
    itemsList.innerHTML = '';
    CATALOG.forEach((item,idx)=>{
      const row=document.createElement('div');
      row.className='flex items-center justify-between gap-3 border rounded-lg p-2';
      row.innerHTML = `
        <label class="flex items-center gap-2">
          <input type="checkbox" data-idx="${idx}" class="itemCheck h-4 w-4" aria-label="Select ${item.name}"/>
          <span>${item.name}</span>
        </label>
        <div class="flex items-center gap-2">
          <span class="text-slate-500">R${item.price}</span>
          <input
            type="number"
            min="1"
            value="1"
            aria-label="Quantity for ${item.name}"
            data-idx="${idx}"
            class="itemQty w-14 border rounded-lg p-1"
          />
        </div>`;
      itemsList.appendChild(row);
    });
  }

  const selectedPay = () => {
    const el = document.querySelector('input[name="pay"]:checked');
    return el ? el.value : 'card';
  };

  function tryGetCustomerCoords(){
    return new Promise((resolve)=>{
      if(!navigator.geolocation){ return resolve(null); }
      navigator.geolocation.getCurrentPosition(
        pos=> resolve({lat:pos.coords.latitude, lng:pos.coords.longitude}),
        ()=> resolve(null),
        { enableHighAccuracy:true, timeout:2500 }
      );
    });
  }

  async function osrmDistanceMeters(a,b){
    try{
      const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=false`;
      const r = await fetch(url);
      const j = await r.json();
      const meters = j?.routes?.[0]?.distance;
      if(Number.isFinite(meters)){ return meters; }
    }catch(_){}
    return kmBetween(a,b)*1000;
  }

  async function computeTotal(){
    ensureCollectionSelectPopulated();

    if(!totalEl || !rushNote){
      return {
        items:[], itemsTotal:0, fee:0, rush:0, total:0,
        collectionName:'', hubLat:COLLECTION_COORDS.lat,
        hubLng:COLLECTION_COORDS.lng, distanceKm:0
      };
    }

    const items = Array.from(document.querySelectorAll('.itemCheck'))
      .filter(c => c.checked)
      .map(c => {
        const i   = Number(c.dataset.idx);
        const qtyInput = document.querySelector(`.itemQty[data-idx="${i}"]`);
        const qty = Math.max(1, Number(qtyInput?.value || 1));
        return { name: CATALOG[i].name, price: Number(CATALOG[i].price), qty };
      });

    const itemsTotal = items.reduce((sum,it)=> sum + (it.price * it.qty), 0);

    const opt = (zoneSelect && zoneSelect.value)
      ? zoneSelect.options[zoneSelect.selectedIndex]
      : null;

    let hubLat = COLLECTION_COORDS.lat,
        hubLng = COLLECTION_COORDS.lng,
        collectionName = '';
    if(opt){
      hubLat = Number(opt.dataset.lat);
      hubLng = Number(opt.dataset.lng);
      collectionName = opt.textContent || '';
      COLLECTION_COORDS = {lat:hubLat, lng:hubLng};
    }

    if(!DELIVERY_COORDS){
      DELIVERY_COORDS = await tryGetCustomerCoords();
    }

    let distanceKm = 0;
    if(DELIVERY_COORDS && opt){
      const meters = await osrmDistanceMeters({lat:hubLat,lng:hubLng}, DELIVERY_COORDS);
      distanceKm = Math.max(0, meters/1000);
    }

    const rushFee = rushToggle?.checked ? RUSH_FEE : 0;
    rushNote.textContent = rushFee ? ' + rush' : '';

    const deliveryFee = opt
      ? Math.round(BASE_DELIVERY_FEE + (PER_KM_PRICE * distanceKm))
      : 0;

    const total = itemsTotal + deliveryFee + rushFee;
    totalEl.textContent = String(total);

    return {
      items, itemsTotal,
      fee: deliveryFee,
      rush: rushFee,
      total,
      collectionName,
      hubLat, hubLng,
      distanceKm
    };
  }

  const pad2 = (n)=> String(n).padStart(2,'0');
  function nextETA(rush){
    const now     = new Date();
    const windows = [[8,10],[12,14],[16,18]];
    const allowed = new Set([0,3,4,5,6]); // Sun, Wed, Thu, Fri, Sat
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    const fmt = (date,[h1,h2])=>{
      const sameDay = (date.toDateString()===new Date().toDateString());
      if (sameDay){
        return `${pad2(h1)}:00–${pad2(h2)}:00 ${rush?'today (rush)':'today'}`;
      }
      return `${dayNames[date.getDay()]} ${pad2(h1)}:00–${pad2(h2)}:00`;
    };

    if (allowed.has(now.getDay())){
      for(const w of windows){
        if(now.getHours()<w[1]) return fmt(now,w);
      }
    }
    for(let i=1;i<=7;i++){
      const d = new Date(now);
      d.setDate(now.getDate()+i);
      if(allowed.has(d.getDay())){
        return fmt(d,windows[0]);
      }
    }
    return 'TBC';
  }

  function toggleDepositBanner(total){
    const pay=selectedPay();
    if(!depositBanner || !depositAmtEl) return;
    if(pay==='deposit_cod'){
      depositAmtEl.textContent = Math.ceil(total*0.5);
      depositBanner.classList.remove('hidden');
    } else {
      depositBanner.classList.add('hidden');
    }
  }

  // === MODAL WRAPPERS ========================================================
  const openOrder  = async ()=>{
    openFlex(modal);
    const s = await computeTotal();
    toggleDepositBanner(s.total);
  };
  const closeOrder = ()=> closeFlex(modal);

  const openBot = ()=>{
    botStage = 0;
    if(!botNext || !botSendWA || !botNewOrder || !botDemoNote || !botFeed) return;
    botNext.disabled = false;
    botNext.textContent = "Pay";
    botSendWA.classList.add('hidden');
    botNewOrder.classList.add('hidden');
    botDemoNote.hidden = true;
    botFeed.innerHTML = "";
    openFlex(botModal);
  };
  const closeBot = ()=>{
    if(botFeed) botFeed.innerHTML='';
    closeFlex(botModal);
  };

  const openPayModal  = (orderRef, amount)=>{
    if(!payModal) return;
    if(payOrderRef) payOrderRef.textContent = orderRef || '--';
    if(payAmountEl) payAmountEl.textContent = amount || '0';
    openFlex(payModal);
  };
  const closePayModal = ()=> closeFlex(payModal);

  function showDriverTab(which){
    const loginOn  = which === 'login';
    const signupOn = which === 'signup';
    formLogin?.classList.toggle('hidden', !loginOn);
    formSignup?.classList.toggle('hidden', !signupOn);
    tabLogin?.classList.toggle('bg-emerald-600', loginOn);
    tabLogin?.classList.toggle('text-white', loginOn);
    tabLogin?.setAttribute('aria-selected', loginOn ? 'true' : 'false');
    tabSignup?.classList.toggle('bg-emerald-600', signupOn);
    tabSignup?.classList.toggle('text-white', signupOn);
    tabSignup?.setAttribute('aria-selected', signupOn ? 'true' : 'false');
  }
  const openDriverWindow  = ()=>{ openFlex(driverModal); showDriverTab('login'); };
  const closeDriverWindow = ()=> closeFlex(driverModal);

  const openStore = ()=> openFlex(storeModal);
  const closeStore= ()=> closeFlex(storeModal);

  tabLogin?.addEventListener('click', (e)=>{ e.preventDefault(); showDriverTab('login'); });
  tabSignup?.addEventListener('click', (e)=>{ e.preventDefault(); showDriverTab('signup'); });

  // === WRAPPERS / CONTENT REGION ============================================
  function ensureWrappers(){
    ensureContentHost();

    if(ordersList && !document.getElementById('ordersListWrap')){
      const wrap = document.createElement('div');
      wrap.id = 'ordersListWrap';
      wrap.className = 'w-full';
      ordersList.parentElement?.insertBefore(wrap, ordersList);
      wrap.appendChild(ordersList);
      document.getElementById('ordersContent')?.appendChild(wrap);
    }

    if(driversList && !document.getElementById('driversListWrap')){
      const wrap = document.createElement('div');
      wrap.id = 'driversListWrap';
      wrap.className = 'w-full hidden';
      driversList.parentElement?.insertBefore(wrap, driversList);
      wrap.appendChild(driversList);
      document.getElementById('ordersContent')?.appendChild(wrap);
    }

    if(!document.getElementById('adminStatsWrap')){
      const stats = document.createElement('div');
      stats.id = 'adminStatsWrap';
      stats.className = 'hidden w-full';
      stats.innerHTML = `
        <div class="grid gap-3 sm:grid-cols-3">
          <div class="border rounded-xl p-3 flex flex-col">
            <div class="text-xs text-slate-500 mb-1">Total Orders</div>
            <div id="adminStatsOrders" class="text-2xl font-semibold">0</div>
          </div>
          <div class="border rounded-xl p-3 flex flex-col">
            <div class="text-xs text-slate-500 mb-1">Revenue</div>
            <div id="adminStatsRevenue" class="text-2xl font-semibold">R0</div>
          </div>
          <div class="border rounded-xl p-3 flex flex-col">
            <div class="text-xs text-slate-500 mb-1">Drivers & Payouts</div>
            <div class="text-sm"><b id="adminDriversCount">0</b> drivers</div>
            <div class="text-xs text-slate-500 mt-2">Payouts</div>
            <div class="text-xs">Pending: <b id="adminPayPending">R0</b></div>
            <div class="text-xs">Approved: <b id="adminPayApproved">R0</b></div>
          </div>
        </div>
        <div class="grid gap-3 sm:grid-cols-2 mt-4">
          <div class="border rounded-xl p-3">
            <div class="text-sm font-medium mb-2">Top Products</div>
            <ul id="adminTopProducts" class="text-sm space-y-1"></ul>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-sm font-medium mb-2">Top Areas (by collection)</div>
            <ul id="adminTopAreas" class="text-sm space-y-1"></ul>
          </div>
        </div>
      `;
      document.getElementById('ordersContent')?.appendChild(stats);
      adminDriversCountEl = document.getElementById('adminDriversCount');
      adminPayPendingEl   = document.getElementById('adminPayPending');
      adminPayApprovedEl  = document.getElementById('adminPayApproved');
    }

    if(!document.getElementById('payoutsWrap')){
      const p = document.createElement('div');
      p.id = 'payoutsWrap';
      p.className = 'hidden w-full';
      p.innerHTML = `<div class="text-sm text-slate-500 p-3">Loading payouts…</div>`;
      document.getElementById('ordersContent')?.appendChild(p);
    }

    if(!document.getElementById('ordersTabs')){
      const host = ordersTabsContainer || ordersPanel || document.body;
      const tabs = document.createElement('div');
      tabs.id = 'ordersTabs';
      tabs.className = 'flex gap-2 mb-3 flex-wrap';
      host.insertBefore(tabs, host.firstChild);
    }
  }

  const getWrapRefs = ()=>({
    ordersWrap:  document.getElementById('ordersListWrap'),
    driversWrap: document.getElementById('driversListWrap'),
    statsWrap:   document.getElementById('adminStatsWrap'),
    payoutsWrap: document.getElementById('payoutsWrap')
  });

  // === ADMIN OPEN/CLOSE ======================================================
  const openOrders = async ()=>{
    openFlex(ordersPanel);
    ensureAdminTabs();
    setActiveAdminTab(ordersTab);
    await fetchDrivers();
    await renderOrders();
    await renderDrivers();
    await renderAdminStats();
    await renderPayouts();
  };
  const closeOrders= ()=> closeFlex(ordersPanel);

  const openDriverDash = ()=>{
    if(driverPayoutPendingEl)  driverPayoutPendingEl.textContent = String(driverTotals.pending);
    if(driverPayoutApprovedEl) driverPayoutApprovedEl.textContent = String(driverTotals.approved);
    openFlex(driverDashModal);
  };
  const closeDriverDashWindow = ()=> closeFlex(driverDashModal);

  function appendBot(msg,who='bot'){
    if(!botFeed) return;
    const wrap=document.createElement('div');
    wrap.className = `flex ${who==='bot'?'justify-start':'justify-end'}`;
    wrap.innerHTML = `
      <div class="max-w-[80%] rounded-2xl px-3 py-2 text-sm ${who==='bot'?'bg-slate-100':'bg-emerald-600 text-white'}">
        ${msg}
      </div>`;
    botFeed.appendChild(wrap);
    botFeed.scrollTop = botFeed.scrollHeight;
  }

  // === MOBILE NAV ============================================================
  function toggleMobileMenu() {
    if(!mobileDropdown || !mobileBtn || !mobileIconOpen || !mobileIconClose) return;
    const isHidden = mobileDropdown.classList.contains('hidden');
    if (isHidden) {
      mobileDropdown.classList.remove('hidden');
      mobileIconOpen.classList.add('hidden');
      mobileIconClose.classList.remove('hidden');
      mobileBtn.setAttribute('aria-expanded', 'true');
    } else {
      mobileDropdown.classList.add('hidden');
      mobileIconOpen.classList.remove('hidden');
      mobileIconClose.classList.add('hidden');
      mobileBtn.setAttribute('aria-expanded', 'false');
    }
  }
  mobileBtn?.addEventListener('click', toggleMobileMenu);

  document.querySelectorAll('#mobileNavDropdown .mobile-nav-link').forEach(el => {
    el.addEventListener('click', () => {
      if(!mobileDropdown || !mobileBtn || !mobileIconOpen || !mobileIconClose) return;
      mobileDropdown.classList.add('hidden');
      mobileIconOpen.classList.remove('hidden');
      mobileIconClose.classList.add('hidden');
      mobileBtn.setAttribute('aria-expanded', 'false');
    });
  });

  document.getElementById('openOrderBuilderTopMobile')?.addEventListener('click', (e)=>{
    e.preventDefault();
    document.getElementById('openOrderBuilder')?.click();
  });
  document.getElementById('openDriverModalTopMobile')?.addEventListener('click', (e)=>{
    e.preventDefault();
    document.getElementById('openDriverModal')?.click();
  });
  document.getElementById('adminLoginBtnMobile')?.addEventListener('click', (e)=>{
    e.preventDefault();
    document.getElementById('adminLoginBtn')?.click();
  });
  document.getElementById('openDriverModalSection')?.addEventListener('click', (e)=>{
    e.preventDefault();
    document.getElementById('openDriverModal')?.click();
  });

  // Direct “open drivers tab” links
  function forceOpenDriversTab(e){
    e?.preventDefault?.();
    ordersTab = 'drivers';
    openOrders();
    setActiveAdminTab('drivers');
  }
  document.querySelectorAll('.openDriversTab, #openDriversTab, [data-nav="drivers"], a[href="#drivers"]')
    .forEach(el => el.addEventListener('click', forceOpenDriversTab, {capture:true}));

  // === INIT CUSTOMER UI ======================================================
  renderItems();
  ensureCollectionSelectPopulated();
  computeTotal();

  zoneSelect?.addEventListener('change', async ()=>{
    const s = await computeTotal(); toggleDepositBanner(s.total);
  });
  rushToggle?.addEventListener('change', async ()=>{
    const s = await computeTotal(); toggleDepositBanner(s.total);
  });
  document.addEventListener('change', async e=>{
    const t = e.target;
    if(
      (t?.classList && t.classList.contains('itemCheck')) ||
      (t?.classList && t.classList.contains('itemQty'))   ||
      t?.name === 'pay'
    ){
      const s = await computeTotal(); toggleDepositBanner(s.total);
    }
  });

  // Persist only customer fields
  [custNameEl, custPhoneEl, custAddrEl].forEach((el)=>{
    if(!el) return;
    const key = 'yt_'+el.id;
    const saved = localStorage.getItem(key);
    if(saved) el.value = saved;
    el.addEventListener('input', ()=> localStorage.setItem(key, el.value));
  });

  // === STORE MODAL ===========================================================
  function renderStoreItems(){
    if(!storeItemsList) return;
    storeItemsList.innerHTML = '';
    storeItems.forEach((it,idx)=>{
      const row = document.createElement('div');
      row.className = "flex items-center justify-between border rounded-lg p-2";
      row.innerHTML = `
        <div class="text-sm">
          <div class="font-medium">${it.name}</div>
          <div class="text-xs text-slate-500">R${it.price}</div>
        </div>
        <button data-idx="${idx}" class="removeStoreItem text-[11px] text-red-600 underline" aria-label="Remove ${it.name}">remove</button>
      `;
      storeItemsList.appendChild(row);
    });

    storeItemsList.querySelectorAll('.removeStoreItem').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-idx'));
        storeItems.splice(i,1);
        renderStoreItems();
      });
    });
  }

  addStoreItemBtn?.addEventListener('click', e=>{
    e.preventDefault();
    const name = prompt('Item name');
    const priceVal = prompt('Price (R)');
    const price = Number(priceVal);
    if(!name || !Number.isFinite(price) || price<=0){ return; }
    CATALOG.push({name,price});
    storeItems.push({name,price});
    renderItems();
    renderStoreItems();
    computeTotal().then(s=>toggleDepositBanner(s.total));
  });

  openStoreFooter?.addEventListener('click', (e)=>{ e.preventDefault(); openStore(); });
  document.getElementById('openStoreHeader')?.addEventListener('click', (e)=>{ e.preventDefault(); openStore(); });
  closeStoreModalBtn?.addEventListener('click', (e)=>{ e.preventDefault(); closeStore(); });
  cancelStoreBtn?.addEventListener('click', (e)=>{ e.preventDefault(); closeStore(); });

  submitStoreBtn?.addEventListener('click', async ()=>{
    const storeName  = storeNameEl?.value.trim();
    const storePhone = digits(storePhoneEl?.value.trim());
    const zone       = storeZoneEl?.value || 'A';

    if(!storeName || !storePhone){
      alert("Please add store name & WhatsApp.");
      return;
    }

    const payload = {
      name: storeName,
      owner_name: storeName,
      phone: storePhone,
      zone,
      address: {},
      items: storeItems.map(i=>({ name:i.name, price:i.price }))
    };

    try{
      const r = await fetch(`${BASE_API}/stores`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok){ alert("Store save failed."); return; }
    }catch(err){ console.error("store create failed",err); }

    const adminMsg =
`New store signup:
Name: ${storeName}
Phone: ${storePhone}
Items:
${storeItems.map(i=>"- "+i.name+" (R"+i.price+")").join("\n")}`;

    window.open(`https://wa.me/${ADMIN_WHATSAPP}?text=${waText(adminMsg)}`,'_blank');

    alert("Thanks! We'll review your store.");
    closeStore();

    if(storeNameEl) storeNameEl.value = '';
    if(storePhoneEl) storePhoneEl.value = '';
    if(storeZoneEl)  storeZoneEl.value = 'A';
    storeItems.splice(0,storeItems.length);
    renderStoreItems();
  });

  // === ADMIN PANEL: TABS =====================================================
  ordersClose?.addEventListener('click', (e)=>{ e.preventDefault(); closeOrders(); });
  window.addEventListener('yt-open-orders', openOrders);
  window.addEventListener('yt-orders-updated', ()=>{
    if(ordersPanel && !ordersPanel.classList.contains('hidden')) {
      renderOrders();
      renderDrivers();
      renderAdminStats();
      renderPayouts();
    }
  });

  function ensureAdminTabs(){
    ensureWrappers();

    function makeTabBtn(label, tabKey){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'yt-o-tab px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100 text-xs';
      btn.dataset.oTab = tabKey;
      btn.setAttribute('role','tab');
      btn.setAttribute('aria-selected','false');
      btn.textContent = label;
      btn.addEventListener('click', ()=> setActiveAdminTab(tabKey));
      return btn;
    }

    const wanted = [
      ['Orders','orders'],
      ['Pending','pending'],
      ['Assigned','assigned'],
      ['In Transit','in_transit'],
      ['Delivered','delivered'],
      ['Order History','history'],
      ['Drivers','drivers'],
      ['Stats / KPIs','stats'],
      ['Payouts','payouts']
    ];

    const host = document.getElementById('ordersTabs') || ordersTabsContainer || ordersPanel || document.body;
    const haveKeys = new Set(Array.from(document.querySelectorAll('.yt-o-tab')).map(b=>b.dataset.oTab));
    wanted.forEach(([label,key])=>{
      if(!haveKeys.has(key)){
        host.appendChild(makeTabBtn(label, key));
      }
    });

    document.querySelectorAll('.yt-o-tab').forEach(b=>{
      if(!b.dataset.wired){
        b.addEventListener('click', ()=> setActiveAdminTab(b.dataset.oTab));
        b.dataset.wired = '1';
      }
    });
  }

  function setActiveAdminTab(tabKey){
    ordersTab = tabKey;

    document.querySelectorAll('.yt-o-tab').forEach(x=>{
      x.classList.remove('bg-emerald-600','text-white');
      x.setAttribute('aria-selected','false');
      if(x.dataset.oTab === tabKey){
        x.classList.add('bg-emerald-600','text-white');
        x.setAttribute('aria-selected','true');
      }
    });

    const { ordersWrap, driversWrap, statsWrap, payoutsWrap } = getWrapRefs();

    const showDrivers = tabKey === 'drivers' || (tabKey||'').startsWith('by_driver:');
    const showStats   = tabKey === 'stats';
    const showPayouts = tabKey === 'payouts';
    const showOrders  = !showDrivers && !showStats && !showPayouts;

    if(ordersWrap)  ordersWrap.classList.toggle('hidden', !showOrders);
    if(driversWrap) driversWrap.classList.toggle('hidden', !showDrivers);
    if(statsWrap)   statsWrap.classList.toggle('hidden', !showStats);
    if(payoutsWrap) payoutsWrap.classList.toggle('hidden', !showPayouts);

    if(showDrivers)      renderDrivers();
    else if(showStats)   renderAdminStats();
    else if(showPayouts) renderPayouts();
    else                 renderOrders();
  }

  async function hardRefresh(){
    await fetchDrivers();
    await renderOrders();
    await renderDrivers();
    await renderAdminStats();
    await renderPayouts();
    setActiveAdminTab(ordersTab);
  }
  ordersRefresh?.addEventListener('click', hardRefresh);
  driversRefresh?.addEventListener('click', hardRefresh);

  function recalcAdminPayoutWidgets() {
    const driverCount  = DRIVERS.length;
    const pendingTotal = DRIVERS.reduce((s,d)=> s + Number(d.weekly_payout_due || 0), 0);
    const approvedTotal = 0; // hook real approved totals when backend supports

    driverTotals.pending  = pendingTotal;
    driverTotals.approved = approvedTotal;

    if(adminDriversCountEl) adminDriversCountEl.textContent = String(driverCount);
    if(adminPayPendingEl)   adminPayPendingEl.textContent   = `R${pendingTotal}`;
    if(adminPayApprovedEl)  adminPayApprovedEl.textContent  = `R${approvedTotal}`;

    if(driverDashModal && !driverDashModal.classList.contains('hidden')){
      if(driverPayoutPendingEl)  driverPayoutPendingEl.textContent  = String(pendingTotal);
      if(driverPayoutApprovedEl) driverPayoutApprovedEl.textContent = String(approvedTotal);
    }
  }

  // === API: Orders & actions =================================================
  async function fetchOrdersByStatus(status){
    if(status === 'drivers' || (status||'').startsWith('by_driver:') || status === 'stats' || status === 'payouts') return [];
    try {
      const res = await fetch(`${BASE_API}/orders?status=${encodeURIComponent(status)}`);
      const data = await res.json().catch(()=>({}));
      if(!res.ok || !data.ok){ return []; }
      return Array.isArray(data.orders) ? data.orders : [];
    } catch(err){
      console.error("fetchOrdersByStatus error",err);
      return [];
    }
  }

  async function assignOneOrder(internalId){
    if(!internalId){ alert("Missing order id."); return; }
    try{
      const res = await fetch(`${BASE_API}/orders/${encodeURIComponent(internalId)}/auto-assign`, {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          "X-Admin-Secret": (window.YT_ADMIN_SECRET||'changeme-admin')
        }
      });
      const data = await res.json().catch(()=>({}));

      if(res.ok && data && data.ok){
        alert(`Assigned: ${internalId} -> ${data.driver_id || 'driver?'}`);
      } else if (res.status === 409 && data && data.error === "no_driver_available") {
        alert(`No driver available for ${internalId}`);
      } else {
        alert(`Failed to assign ${internalId} (${res.status})`);
      }
    }catch(err){
      console.error("assignOneOrder err",err);
      alert(`Network error assigning ${internalId}`);
    }
    renderOrders();
  }

  async function markDelivered(internalId){
    if(!internalId){ alert("Missing order id."); return; }
    try{
      const res = await fetch(`${BASE_API}/orders/${encodeURIComponent(internalId)}/status`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({status:"delivered"})
      });
      const data = await res.json().catch(()=>({}));
      if(res.ok && data && data.ok){
        alert(`Marked delivered: ${internalId}`);
      } else {
        alert(`Failed to mark delivered (${res.status})`);
      }
    }catch(err){
      console.error("markDelivered err",err);
      alert(`Network error marking delivered ${internalId}`);
    }
    renderOrders();
  }

  async function autoAssignForAll(){
    const pend = await fetchOrdersByStatus('pending');
    const ids = pend.map(o => o._internal_id).filter(Boolean);
    if (ids.length === 0){ alert("No pending orders to assign."); return; }

    const results = [];
    for (const internalId of ids){
      try {
        const res = await fetch(`${BASE_API}/orders/${encodeURIComponent(internalId)}/auto-assign`, {
          method: "POST",
          headers: {
            "Content-Type":"application/json",
            "X-Admin-Secret": (window.YT_ADMIN_SECRET||'changeme-admin')
          }
        });
        const data = await res.json().catch(()=>({}));

        if(res.ok && data && data.ok){
          const driverId = data.driver_id || "driver?";
          results.push(`✅ ${internalId} → ${driverId}`);
        } else if (res.status === 409 && data && data.error === "no_driver_available") {
          results.push(`⚠️ ${internalId}: no driver`);
        } else {
          results.push(`❌ ${internalId}: failed (${res.status})`);
        }
      } catch (err){
        console.error("autoAssignForAll error", err);
        results.push(`❌ ${internalId}: network error`);
      }
    }
    await renderDrivers();
    alert(results.join("\n"));
    renderOrders();
  }
  ordersAssign?.addEventListener('click', autoAssignForAll);

  // === RENDER: Orders / Status / History ====================================
  async function renderOrders(){
    if(!ordersList) return;

    // Per-driver filtered
    if((ordersTab||'').startsWith('by_driver:')){
      const did = ordersTab.split(':',2)[1];
      const all = await fetchAllOrders();
      const data = all.filter(o => (o.assigned_driver_id || '') === did);
      currentOrdersByTab[ordersTab] = data;

      ordersList.innerHTML = data.length
        ? ''
        : `<div class="text-sm text-slate-500 p-4">No orders for this driver.</div>`;

      for(const o of data){
        ordersList.appendChild(buildOrderRow(o));
      }
      wireOrderRowButtons(ordersList);
      return;
    }

    // All active orders
    if(ordersTab === 'orders'){
      const all = await fetchAllOrders();
      const data = all.filter(o => o.status !== 'delivered');
      currentOrdersByTab[ordersTab] = data;

      ordersList.innerHTML = data.length
        ? ''
        : `<div class="text-sm text-slate-500 p-4">No active orders.</div>`;
      for(const o of data){
        ordersList.appendChild(buildOrderRow(o));
      }
      wireOrderRowButtons(ordersList);
      return;
    }

    // Order history (delivered)
    if(ordersTab === 'history'){
      const all = await fetchAllOrders();
      const data = all
        .filter(o => o.status === 'delivered')
        .sort((a,b)=> (new Date(b.updated_at||b.created_at||0)) - (new Date(a.updated_at||a.created_at||0)));
      currentOrdersByTab[ordersTab] = data;

      ordersList.innerHTML = data.length
        ? ''
        : `<div class="text-sm text-slate-500 p-4">No delivered orders yet.</div>`;
      for(const o of data){
        ordersList.appendChild(buildOrderRow(o));
      }
      wireOrderRowButtons(ordersList);
      return;
    }

    // Single-status view
    const data = await fetchOrdersByStatus(ordersTab);
    currentOrdersByTab[ordersTab] = data;

    ordersList.innerHTML = data.length
      ? ''
      : `<div class="text-sm text-slate-500 p-4">No ${ordersTab} orders.</div>`;

    for(const o of data){
      ordersList.appendChild(buildOrderRow(o));
    }
    wireOrderRowButtons(ordersList);
  }

  function buildOrderRow(o){
    const itemsText = (o.items || [])
      .map(i=>`${i.name} x${i.qty}`)
      .join(', ');

    const internalId   = o._internal_id || o.internal_id || null;
    const refDisplay   = o.order_id || o.order_public_id || internalId || "REF?";
    const kmText       = (o.route && Number.isFinite(o.route.distance_km))
      ? ` • ${Number(o.route.distance_km).toFixed(1)} km`
      : "";
    const fraudDisplay = (typeof o.fraud_score === "number")
      ? ` • Fraud: ${o.fraud_score.toFixed(2)}`
      : "";

    const assignedDriverId = o.assigned_driver_id || null;
    const driver = assignedDriverId && DRIVERS_BY_ID[assignedDriverId]
      ? DRIVERS_BY_ID[assignedDriverId]
      : null;
    const driverName = driver ? (driver.name || 'Driver') : '—';

    let driverPayText = "Driver pay: —";
    if (o.settlement && typeof o.settlement.driver === 'number'){
      driverPayText = `Driver pay: R${o.settlement.driver}`;
    }

    const isDelivered = o.status === "delivered";
    const canAssign   = (o.status === "pending" || o.status === "review_required") && !isDelivered;
    const canStart    = (o.status === "assigned");
    const canDeliver  = (o.status === "assigned" || o.status === "in_transit") && !isDelivered;

    const row = document.createElement('div');
    row.className = 'p-3 flex flex-col sm:flex-row sm:items-center gap-3 border-b border-slate-200';
    row.setAttribute('data-order-id', internalId || '');
    row.setAttribute('data-order-status', o.status || '');

    row.innerHTML = `
      <div class="flex-1 min-w-0">
        <div class="font-medium flex flex-wrap items-center gap-1">
          <span>Ref ${refDisplay}</span>
          <span>• Total R${o.total}</span>
          ${kmText}
        </div>
        <div class="text-xs text-slate-500 break-words">${itemsText}</div>
        <div class="text-xs text-slate-500">
          Status: <b>${o.status}</b> • Driver: ${driverName}${fraudDisplay}
        </div>
        <div class="text-[11px] leading-snug text-slate-500 mt-1">
          ${driverPayText}
        </div>
      </div>
      <div class="flex flex-row flex-wrap gap-2 text-xs sm:justify-end">
        <button
          class="btn-assign px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100 disabled:opacity-40 disabled:cursor-not-allowed"
          ${(!canAssign || !internalId) ? 'disabled' : ''}
          data-id="${internalId || ''}">
          Assign
        </button>
        <button
          class="btn-start px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100 disabled:opacity-40 disabled:cursor-not-allowed"
          ${(!canStart || !internalId) ? 'disabled' : ''}
          data-id="${internalId || ''}">
          Start trip
        </button>
        <button
          class="btn-delivered px-2 py-1 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-40 disabled:cursor-not-allowed"
          ${(!canDeliver || !internalId) ? 'disabled' : ''}
          data-id="${internalId || ''}">
          Delivered
        </button>
      </div>
    `;
    return row;
  }

  function wireOrderRowButtons(scopeEl){
    scopeEl.querySelectorAll('.btn-assign').forEach(btn=>{
      if(btn.dataset.wiredAssign) return;
      btn.dataset.wiredAssign = '1';
      btn.addEventListener('click', ()=> assignOneOrder(btn.getAttribute('data-id')));
    });
    scopeEl.querySelectorAll('.btn-start').forEach(btn=>{
      if(btn.dataset.wiredStart) return;
      btn.dataset.wiredStart = '1';
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-id');
        if(!id) return;
        try{
          const res = await fetch(`${BASE_API}/orders/${encodeURIComponent(id)}/status`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({status:"in_transit"})
          });
          await res.json().catch(()=>({}));
        }catch(e){ console.error('start trip', e); }
        renderOrders();
      });
    });
    scopeEl.querySelectorAll('.btn-delivered').forEach(btn=>{
      if(btn.dataset.wiredDelivered) return;
      btn.dataset.wiredDelivered = '1';
      btn.addEventListener('click', ()=> markDelivered(btn.getAttribute('data-id')));
    });
  }

  // === DRIVERS TAB ===========================================================
  async function renderDrivers(){
    if(!driversList) return;
    await fetchDrivers();

    const drivers = DRIVERS;
    driversList.innerHTML = '';
    if(drivers.length===0){
      driversList.innerHTML = `<div class="text-sm text-slate-500 p-4">No drivers yet.</div>`;
      recalcAdminPayoutWidgets();
      return;
    }

    for(const dr of drivers){
      const row = document.createElement('div');
      row.className = 'p-3 flex flex-col gap-2 border-b border-slate-200';

      const stats = dr.stats || {};
      const pendingDue = Number(dr.weekly_payout_due || 0);

      row.innerHTML = `
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div class="flex-1 min-w-0">
            <div class="font-medium flex flex-wrap items-center gap-2">
              <span>#${dr.driver_id || (dr._internal_id||'DRV')}</span>
              <span>• ${dr.name || 'Driver'}</span>
              <span class="text-slate-500">(${dr.vehicle || 'car'})</span>
              <span class="text-[11px] text-slate-500">WhatsApp: ${dr.phone || '—'}</span>
            </div>
            <div class="text-xs text-slate-500">
              Assigned: <b>${stats.assigned||0}</b> • In transit: <b>${stats.in_transit||0}</b> • Delivered: <b>${stats.delivered||0}</b>
            </div>
            <div class="text-xs text-slate-500">
              Weekly due: <b>R${pendingDue}</b>
            </div>
          </div>
          <div class="flex flex-row flex-wrap gap-2 text-xs sm:justify-end">
            <button class="btn-view-orders px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100"
                    data-id="${dr._internal_id || dr.driver_id}">
              View Orders
            </button>
          </div>
        </div>
      `;
      driversList.appendChild(row);
    }

    driversList.querySelectorAll('.btn-view-orders').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const did = btn.getAttribute('data-id');
        if(!did) return;
        ordersTab = `by_driver:${did}`;
        setActiveAdminTab(ordersTab);
      });
    });

    recalcAdminPayoutWidgets();
  }

  // === PAYOUTS TAB ===========================================================
  async function renderPayouts(){
    const wrap = document.getElementById('payoutsWrap');
    if(!wrap) return;

    await fetchDrivers();
    wrap.innerHTML = '';

    if(!DRIVERS.length){
      wrap.innerHTML = `<div class="text-sm text-slate-500 p-4">No drivers yet.</div>`;
      return;
    }

    const dueDrivers = DRIVERS.filter(d => Number(d.weekly_payout_due || 0) > 0);

    if(!dueDrivers.length){
      wrap.innerHTML = `<div class="text-sm text-slate-500 p-4">No pending payouts. 🎉</div>`;
      recalcAdminPayoutWidgets();
      return;
    }

    dueDrivers.forEach(dr=>{
      const due = Number(dr.weekly_payout_due || 0);
      const row = document.createElement('div');
      row.className = 'p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 border-b border-slate-200';
      row.innerHTML = `
        <div class="flex-1 min-w-0">
          <div class="font-medium flex flex-wrap items-center gap-2">
            <span>${dr.name || 'Driver'}</span>
            <span class="text-xs text-slate-500">ID: ${dr.driver_id || dr._internal_id || '-'}</span>
          </div>
          <div class="text-xs text-slate-500">
            WhatsApp: ${dr.phone || '—'} • Vehicle: ${dr.vehicle || 'car'}
          </div>
          <div class="text-sm">
            Pending payout: <b>R${due}</b>
          </div>
        </div>
        <div class="flex flex-row gap-2 text-xs sm:justify-end">
          <button
            class="btn-approve-payout px-3 py-1 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700"
            data-id="${dr._internal_id || dr.driver_id}"
            data-amt="${due}">
            Approve paid
          </button>
        </div>
      `;
      wrap.appendChild(row);
    });

    wrap.querySelectorAll('.btn-approve-payout').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id  = btn.getAttribute('data-id');
        const amt = Number(btn.getAttribute('data-amt') || 0);
        if(!id || !amt) return;

        try{
          const res = await fetch(`${BASE_API}/drivers/${encodeURIComponent(id)}/payouts/approve`, {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'X-Admin-Secret': (window.YT_ADMIN_SECRET || 'changeme-admin')
            },
            body: JSON.stringify({ amount: amt })
          });
          const j = await res.json().catch(()=>({}));
          if(res.ok && j && j.ok){
            alert('Payout approved.');
            const d = DRIVERS_BY_ID[id];
            if(d){ d.weekly_payout_due = 0; }
            recalcAdminPayoutWidgets();
            renderPayouts();
          } else {
            alert(j.message || 'Failed to approve payout.');
          }
        }catch(err){
          console.error('approve payout error', err);
          alert('Network error approving payout.');
        }
      });
    });

    recalcAdminPayoutWidgets();
  }

  // === MAP (closest depot → user route) =====================================
  ;(function initMapSafely(){
    const heroEl  = document.getElementById('heroMap');
    if(!heroEl){ return; }

    let heroMap;
    let localCars = [];
    const movers = [];

    const southAfricaBounds = (window.L && L.latLngBounds)
      ? L.latLngBounds([[-35.5, 16.0], [-22.0, 33.5]])
      : null;

    function carIcon(){
      const svg=`<svg viewBox='0 0 64 28' aria-hidden='true'><g>
        <rect x='6' y='10' rx='6' ry='6' width='52' height='10' fill='${emerald[600]}' opacity='.95'/>
        <rect x='10' y='5' rx='6' ry='6' width='44' height='14' fill='#ffffff'/>
        <rect x='24' y='6' width='16' height='7' rx='2' fill='#e5e7eb'/>
        <rect x='10' y='9' width='4' height='3' fill='#f59e0b'/>
        <rect x='50' y='9' width='4' height='3' fill='#f59e0b'/>
        <circle cx='18' cy='20' r='3' fill='#111827'/>
        <circle cx='46' cy='20' r='3' fill='#111827'/>
      </g></svg>`;
      return window.L
        ? L.divIcon({ className:'car-dot', html:svg, iconSize:[28,14], iconAnchor:[14,7] })
        : null;
    }

    const pkgSvg=`<svg viewBox='0 0 24 24' aria-hidden='true'>
      <path fill='${emerald[600]}' d='M3 7l9-4 9 4-9 4-9-4zm0 3l9 4 9-4v7c0 .4-.2.8-.6 1l-7.8 3.5c-.4.2-.8.2-1.2 0L3.6 18c-.4-.2-.6-.6-.6-1V10z'/>
    </svg>`;
    const pkgIcon = (window.L && L.divIcon)
      ? L.divIcon({ className:'pkg-dot', html:pkgSvg, iconSize:[20,20], iconAnchor:[10,10] })
      : null;

    async function osrmRoute(a,b){
      try{
        const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
        const r = await fetch(url);
        const j = await r.json();
        const coords = j?.routes?.[0]?.geometry?.coordinates;
        if(Array.isArray(coords) && coords.length>1){
          return coords.map(([lng,lat])=>[lat,lng]);
        }
      }catch(_){}
      return null;
    }
    function buildStraight(a,b){ return [[a.lat,a.lng],[b.lat,b.lng]]; }

    function cumulativeLengths(latlngs){
      const lens=[0];
      let acc=0;
      for(let i=1;i<latlngs.length;i++){
        const a = {lat:latlngs[i-1][0], lng:latlngs[i-1][1]};
        const b = {lat:latlngs[i][0],   lng:latlngs[i][1]};
        acc += kmBetween(a,b);
        lens.push(acc);
      }
      return { lensKm:lens, totalKm:acc };
    }
    function pointAtFraction(latlngs, lensKm, frac){
      const target = frac*lensKm[lensKm.length-1];
      let i=1; while(i<lensKm.length && lensKm[i]<target) i++;
      const a=latlngs[i-1], b=latlngs[i];
      const segLen = lensKm[i]-lensKm[i-1] || 1e-6;
      const t = (target - lensKm[i-1]) / segLen;
      const lat = a[0] + (b[0]-a[0])*t;
      const lng = a[1] + (b[1]-a[1])*t;
      return [lat,lng];
    }

    function spawnLocalTraffic(center, count){
      if(!window.L || !heroMap) return;
      for(let i=0;i<count;i++){
        const r    = 0.01 + Math.random()*0.02;
        const ang0 = Math.random()*Math.PI*2;
        const spd  = 0.4 + Math.random()*0.6;
        const m    = L.marker(
          [center.lat + r*Math.sin(ang0), center.lng + r*Math.cos(ang0)],
          { icon:carIcon() || undefined }
        ).addTo(heroMap);
        localCars.push({m, cx:center.lat, cy:center.lng, r, ang:ang0, spd});
      }
    }

    async function centerMapHeuristic() {
      DELIVERY_COORDS = DELIVERY_COORDS || await tryGetCustomerCoords();

      if(DELIVERY_COORDS){
        try { heroMap.setView([DELIVERY_COORDS.lat, DELIVERY_COORDS.lng], 12, { animate:true }); } catch(_){}

        // Nearest depot
        let best = null;
        for(const c of COLLECTIONS){
          const d = kmBetween({lat:c.lat,lng:c.lng}, DELIVERY_COORDS);
          if(!best || d < best.d) best = { c, d };
        }

        if(best){
          const depot = best.c;
          let latlngs = await osrmRoute(
            {lat:depot.lat, lng:depot.lng},
            {lat:DELIVERY_COORDS.lat, lng:DELIVERY_COORDS.lng}
          );
          if(!latlngs){
            latlngs = buildStraight(
              {lat:depot.lat, lng:depot.lng},
              {lat:DELIVERY_COORDS.lat, lng:DELIVERY_COORDS.lng}
            );
          }

          L.polyline(latlngs,{weight:3, opacity:.9, color:emerald[600]}).addTo(heroMap);

          const {lensKm} = cumulativeLengths(latlngs);
          for(let i=0;i<3;i++){
            const m = L.marker(latlngs[0],{icon:carIcon() || undefined}).addTo(heroMap);
            const speed = 0.22 + Math.random()*0.08;
            const start = Math.random()*0.25;
            movers.push({m, latlngs, lensKm, t:start, speed, dir:1});
          }

          // small pulse at user location
          if(window.L){
            const pulse = L.circle([DELIVERY_COORDS.lat, DELIVERY_COORDS.lng], {
              radius: 40, color:emerald[500], weight:1, opacity:0.7, fillOpacity:0
            }).addTo(heroMap);
            let grow=true;
            setInterval(()=>{
              const rr = pulse.getRadius();
              pulse.setRadius(grow ? rr+6 : rr-6);
              if(pulse.getRadius()>110) grow=false;
              if(pulse.getRadius()<40)  grow=true;
            }, 220);
          }
        }

        spawnLocalTraffic(DELIVERY_COORDS, 4);
        return;
      }

      // Fallback center
      try { heroMap.setView([COLLECTION_COORDS.lat, COLLECTION_COORDS.lng], 9, { animate:true }); } catch(_){}
    }

    (async function(){
      try {
        if (typeof L === "undefined") throw new Error("Leaflet not loaded");

        heroMap = L.map(heroEl, {
          zoomControl:false,
          dragging:false,
          scrollWheelZoom:false,
          doubleClickZoom:false,
          boxZoom:false,
          touchZoom:false
        }).setView([-33.20, 26.55], 8);

        L.tileLayer(
          'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
          { attribution:'', opacity:0.98, noWrap:true, detectRetina:true }
        ).addTo(heroMap);

        if (southAfricaBounds) heroMap.setMaxBounds(southAfricaBounds.pad(0.05));

        // Background depot-to-depot routes (visual)
        const depotPairs = [
          [COLLECTIONS[0], COLLECTIONS[1]],
          [COLLECTIONS[1], COLLECTIONS[2]],
          [COLLECTIONS[2], COLLECTIONS[3] || COLLECTIONS[0]]
        ];
        for(const [A,B] of depotPairs){
          let latlngs = await osrmRoute({lat:A.lat,lng:A.lng},{lat:B.lat,lng:B.lng});
          if(!latlngs){
            latlngs = buildStraight({lat:A.lat,lng:A.lng},{lat:B.lat,lng:B.lng});
          }
          L.polyline(latlngs,{weight:2, opacity:.35, color:emerald[500]}).addTo(heroMap);
          const {lensKm} = cumulativeLengths(latlngs);

          for(let i=0;i<2;i++){
            const m = L.marker(latlngs[0],{icon:carIcon() || undefined}).addTo(heroMap);
            const speed = 0.12 + Math.random()*0.06;
            const dir   = Math.random()<.5 ? 1 : -1;
            const start = Math.random();
            movers.push({m, latlngs, lensKm, t:start, speed, dir});
          }
          for(let i=0;i<1;i++){
            const m = L.marker(latlngs[0],{icon:pkgIcon || undefined}).addTo(heroMap);
            const speed = 0.15 + Math.random()*0.06;
            const dir   = Math.random()<.5 ? 1 : -1;
            const start = Math.random();
            movers.push({m, latlngs, lensKm, t:start, speed, dir});
          }
        }

        function animate(){
          movers.forEach(o=>{
            o.t += o.speed * o.dir * (1/60);
            if(o.t>1){ o.t=1; o.dir=-1; }
            if(o.t<0){ o.t=0; o.dir= 1; }
            o.m.setLatLng(pointAtFraction(o.latlngs,o.lensKm,o.t));
          });
          for(const lc of localCars){
            lc.ang += lc.spd * 0.004;
            const lat = lc.cx + lc.r*Math.sin(lc.ang);
            const lng = lc.cy + lc.r*Math.cos(lc.ang);
            lc.m.setLatLng([lat,lng]);
          }
          requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);

        setTimeout(()=>{
          try{ heroMap.invalidateSize(); }catch(_){}
          centerMapHeuristic();
        },180);
        window.addEventListener('resize',()=>{
          try{ heroMap.invalidateSize(); }catch(_){}
        });

        // Driver signup
        formSignup?.addEventListener('submit', async e=>{
          e.preventDefault();
          const name    = document.getElementById('drvName')?.value.trim();
          const phone   = digits(document.getElementById('drvPhone')?.value.trim());
          const radius  = Math.max(1, Number(document.getElementById('drvRadius')?.value || 10));
          const vehicle = document.getElementById('drvVehicle')?.value.trim() || 'car';
          if(!name || !phone){ alert("Please enter name and phone."); return; }

          const jitter = ()=>{
            const d=(1500)/111111, a=Math.random()*Math.PI*2, r=Math.random()*d;
            return {
              lat: COLLECTION_COORDS.lat + r*Math.cos(a),
              lng: COLLECTION_COORDS.lng + r*Math.sin(a)
            };
          };
          const start = jitter();
          if(window.L) L.marker([start.lat,start.lng],{icon:carIcon() || undefined}).addTo(heroMap);

          try{
            const payload = {
              name, phone, vehicle, radius_km: radius,
              available: true,
              current_location: { lat: start.lat, lng: start.lng }
            };
            const r = await fetch(`${BASE_API}/drivers`, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify(payload)
            });
            const j = await r.json().catch(()=>({}));
            if(!r.ok || !j.ok){ alert("Driver create failed."); return; }
          }catch(err){ console.error("driver create failed", err); }

          const text = `New driver sign-up
Name: ${name}
Phone: ${phone}
Radius: ${radius}km
Vehicle: ${vehicle}`;
          window.open(`https://wa.me/${ADMIN_WHATSAPP}?text=${waText(text)}`,'_blank');

          closeDriverWindow();
          await renderDrivers();
          alert('Driver submitted.');
        });

      } catch (err) {
        console.warn("Map disabled:", err);
      }
    })();
  })();

  // === DRIVER LOGIN → DASH ===================================================
  formLogin?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const phone = digits(drvLoginPhoneEl?.value || '');
    const pin   = (drvLoginPinEl?.value || '').trim();
    if(!phone){
      alert('Enter your WhatsApp number to log in.');
      return;
    }
    try{
      const res = await fetch(`${BASE_API}/drivers/login`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ phone, pin })
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok && j && (j.ok || j.token || j.driver)){
        closeDriverWindow();
        openDriverDash();
        return;
      }
      if(res.status === 404 || (j && j.error === 'not_implemented')){
        alert('Login endpoint not available yet. Opening dashboard for demo.');
        closeDriverWindow();
        openDriverDash();
        return;
      }
      alert(j?.message || 'Login failed. Check your details and try again.');
    }catch(err){
      console.error('Driver login error', err);
      alert('Network error during login. Please try again.');
    }
  });

  // === ORDER SUBMISSION (CUSTOMER) ==========================================
  confirmBtn2?.addEventListener('click', async ()=>{
    confirmBtn2.disabled = true;
    try{
      const summary = await computeTotal();
      if (!summary.items.length){ alert('Please select at least one item.'); return; }

      const custName  = (custNameEl?.value||'').trim();
      const custPhone = digits((custPhoneEl?.value||'').trim());
      const custAddr  = (custAddrEl?.value||'').trim();
      if(!custName || !custPhone || !custAddr){
        alert('Please fill name, WhatsApp and address.');
        return;
      }
      if(!zoneSelect?.value){
        alert('Please select a pickup depot.');
        return;
      }

      const paymentMethod = selectedPay();
      const eta           = nextETA(Boolean(summary.rush));

      const orderPayload = {
        customer: {
          name: custName,
          phone: custPhone,
          address: {
            line1: custAddr,
            suburb: '—',
            coords: DELIVERY_COORDS || null
          }
        },
        items: summary.items.map(it => ({
          sku: null, name: it.name, qty: it.qty, price: it.price
        })),
        subtotal: summary.itemsTotal,
        delivery_fee: summary.fee + summary.rush,
        total: summary.total,
        payment: { method: paymentMethod, status: "pending", provider_ref: null },
        created_by: "web",
        route: {
          eta_minutes: null,
          distance_km: Number(summary.distanceKm.toFixed(2)),
          eta_text: eta
        },
        meta: { rush: !!summary.rush, collection_name: summary.collectionName }
      };

      let data = null;
      try {
        const res = await fetch(`${BASE_API}/orders`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(orderPayload)
        });

        try { data = await res.json(); } catch(_) { data = null; }

        if (res.status === 409 && data && data.error === "no_driver_available") {
          alert(data.message || `Sorry, no driver currently available near your area.`);
          return;
        }
        if(!res.ok || !data || !data.ok){
          console.error("Order failed", res.status, data);
          alert("Order failed on server.");
          return;
        }

        latestOrderData = {
          order_public_id: data.order_public_id || data.order_id,
          status:         data.status || "pending",
          total:          summary.total,
          items:          summary.items,
          eta,
          payment_method: paymentMethod,
          wa_message:     `Hi, I need support on my order ${data.order_public_id || '—'}.`
        };
      } catch(err){
        console.error("Network/Fetch error", err);
        alert("Network error creating order.");
        return;
      }

      appendBot(`<b>Order received ✅</b><br/>We'll WhatsApp you the driver details shortly. You can use the button below any time to contact support.`);
      closeOrder();
      openBot();

      appendBot(
        `<b>YiThume</b> 🤖<br/>
         <b>Ref:</b> ${latestOrderData.order_public_id}<br/>
         <b>Items:</b> ${latestOrderData.items.map(i=>`${i.name} x${i.qty}`).join(', ')}<br/>
         <b>Total:</b> R${latestOrderData.total}<br/>
         <b>Estimated window:</b> ${eta}`
      );

      appendBot(`Choose your payment method below and tap <b>Pay</b>.`);
      if(botPayChoice) botPayChoice.value = latestOrderData.payment_method;

    } finally {
      confirmBtn2.disabled = false;
    }
  });

  // === BOT PAY & SUPPORT BUTTON =============================================
  btnFakePayNow?.addEventListener('click', async ()=>{
    alert('No money taken. Demo only.');
    closePayModal();
    try{
      if(latestOrderData?.order_public_id){
        await fetch(`${BASE_API}/simulate_payment`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ order_public_id: latestOrderData.order_public_id })
        }).then(r=>r.json()).catch(()=>({}));
      }
    }catch(e){ console.warn('simulate_payment failed', e); }

    botSendWA?.classList.remove('hidden');
    botNewOrder?.classList.remove('hidden');
    if(botDemoNote) botDemoNote.hidden = false;

    appendBot(`<b>Payment marked (demo)</b><br/>We’ll send your secure link from our side and message you on WhatsApp.`);
    botStage = 2;
  });

  botNext?.addEventListener('click', ()=>{
    if(!latestOrderData) return;
    const pay = botPayChoice?.value || selectedPay();
    latestOrderData.payment_method = pay;

    if(botStage === 0){
      if(pay === 'eft'){
        appendBot(
          `<b>Instant EFT (Ozow)</b><br/>
           We’ll send you a secure link from our side.<br/>
           Ref <code>${latestOrderData.order_public_id}</code>.`
        );
      } else if(pay === 'card'){
        appendBot(
          `We’ll send you a secure <b>card link</b> (Yoco) from our side.<br/>
           Ref <code>${latestOrderData.order_public_id}</code>.`
        );
      } else {
        const deposit = Math.ceil(latestOrderData.total*0.5);
        appendBot(
          `<b>50% deposit + COD</b><br/>
           Deposit now: <b>R${deposit}</b> (we’ll send the link).<br/>
           Ref <code>${latestOrderData.order_public_id}</code>.`
        );
      }
      appendBot(`This next screen is a demo. No money is taken here.`);
      openPayModal(latestOrderData.order_public_id, latestOrderData.total);
      botStage = 1;
      return;
    }

    appendBot(`Use the button below any time to <b>Contact support</b> on WhatsApp.`);
  });

  botSendWA?.addEventListener('click', () => {
    const msg = latestOrderData?.wa_message || 'Hi, I need support with my order.';
    const wa = `https://wa.me/${WHATSAPP_NUMBER}?text=${waText(msg)}`;
    window.open(wa,'_blank');
  });

  botNewOrder?.addEventListener('click', ()=>{
    closeBot();
    openOrder();
  });

  // === WIRING: Open/Close buttons (including top nav) ========================
  closeBtn?.addEventListener('click', (e)=>{ e.preventDefault(); closeOrder(); });
  cancelOrderBuilder?.addEventListener('click', (e)=>{ e.preventDefault(); closeOrder(); });

  closeDriver?.addEventListener('click', (e)=>{ e.preventDefault(); closeDriverWindow(); });
  closeDriverDash?.addEventListener('click', (e)=>{ e.preventDefault(); closeDriverDashWindow(); });

  closePayModalBtn?.addEventListener('click', (e)=>{ e.preventDefault(); closePayModal(); });
  btnCancelPay?.addEventListener('click', (e)=>{ e.preventDefault(); closePayModal(); });

  function wireOpenTriggers(){
    // All "Start order" triggers
    [
      '#openOrderBuilder',
      '#startOrderTop',
      '#startOrderHero',
      '[data-open-order]',
      'button[data-role="start-order"]'
    ].forEach(sel=>{
      document.querySelectorAll(sel).forEach(btn=>{
        if(btn.dataset.wiredStartOrder) return;
        btn.dataset.wiredStartOrder = '1';
        btn.addEventListener('click', (e)=>{ e.preventDefault(); openOrder(); });
      });
    });

    // All "Driver sign-in/up" triggers
    [
      '#openDriverModal',
      '#driverSignTop',
      '#driverSignInTop',
      '[data-open-driver]',
      'button[data-role="driver-signin"]'
    ].forEach(sel=>{
      document.querySelectorAll(sel).forEach(btn=>{
        if(btn.dataset.wiredDriverOpen) return;
        btn.dataset.wiredDriverOpen = '1';
        btn.addEventListener('click', (e)=>{ e.preventDefault(); openDriverWindow(); });
      });
    });

    // All "Admin" triggers (top + anywhere with data-open-admin)
    [
      '#adminLoginBtn',
      '#adminTopBtn',
      '[data-open-admin]'
    ].forEach(sel=>{
      document.querySelectorAll(sel).forEach(btn=>{
        if(btn.dataset.wiredAdminOpen) return;
        btn.dataset.wiredAdminOpen = '1';
        btn.addEventListener('click', async (e)=>{
          e.preventDefault();
          const pin = prompt('Enter admin PIN:');
          if(pin && pin.trim() !== ""){
            window.YT_ADMIN_SECRET = pin.trim();
            alert('Admin mode ON');
            await openOrders();
          } else {
            alert('Invalid PIN');
          }
        });
      });
    });
  }

  // === ADMIN ENTRY (legacy main button kept working) ========================
  adminBtn?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const pin = prompt('Enter admin PIN:');
    if(pin && pin.trim() !== ""){
      window.YT_ADMIN_SECRET = pin.trim();
      alert('Admin mode ON');
      await openOrders();
    } else {
      alert('Invalid PIN');
    }
  });

  // Bootstrap admin scaffolding & drivers cache
  ensureWrappers();
  ensureAdminTabs();
  fetchDrivers();
  wireOpenTriggers();
});
</script>

</body>
</html>
