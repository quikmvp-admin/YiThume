<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%2310b981'/%3E%3Cstop offset='100%25' stop-color='%23059669'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect rx='12' width='36' height='36' fill='url(%23g)'/%3E%3Cpath d='M10 12l5 8v4h-3v-3l-5-9h3zM26 12l-5 8v-3l5-9h-3z' fill='%23fff'/%3E%3C/svg%3E">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YiThume — Health delivered. Fast.</title>
  <meta name="description" content="YiThume delivers OTC meds to remote areas. Order on website, confirm on WhatsApp. Port Alfred, Bathurst, Kenton-on-Sea, Makhanda, Alice, Alexandria, Alicedale." />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --emerald-600:#059669; --emerald-500:#10b981; --emerald-400:#34d399; --emerald-800:#047857; --emerald-900:#065f46;
      --map-bg:#f6f8f9; --hero-h: 360px;
    }
    @media (max-width:640px){ :root{ --hero-h: 280px; } }

    /* Leaflet tweaks */
    .leaflet-pane,
    .leaflet-top,
    .leaflet-bottom { z-index: 10 !important; }
    #heroMap{
      height:var(--hero-h);
      border-radius:16px;
      position:relative;
      overflow:hidden;
      background:var(--map-bg);
    }
    .leaflet-control-container{display:none;}

    /* Moving markers */
    .car-dot{transform:translate(-50%,-50%);}
    .car-dot svg{
      width:18px;
      height:18px;
      filter:drop-shadow(0 1px 1px rgba(0,0,0,.18));
    }
    .car-A path{fill:var(--emerald-600);}
    .car-B path{fill:var(--emerald-500);}
    .car-C path{fill:var(--emerald-400);}
    .car-D path{fill:var(--emerald-800);}
    .car-E path{fill:var(--emerald-900);}

    .pkg-dot{transform:translate(-50%,-50%);}
    .pkg-dot svg{
      width:20px;
      height:20px;
      filter:drop-shadow(0 1px 1px rgba(0,0,0,.15))
    }

    /* Overlay tint + badge */
    .tint{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(5,150,105,.04),rgba(5,150,105,.03));
      pointer-events:none;
    }
    .ec-badge{
      position:absolute;
      left:14px;
      bottom:12px;
      padding:6px 10px;
      border-radius:10px;
      background:rgba(15,23,42,.75);
      color:#fff;
      font-size:12px;
      line-height:1.2;
      backdrop-filter: blur(2px);
    }

    /* Body scroll lock class */
    .overflow-locked {
      overflow: hidden;
      touch-action: none;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900">

<!-- Header -->
<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <svg width="36" height="36" viewBox="0 0 36 36" class="rounded-2xl" aria-label="YiThume logo">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stop-color="#10b981"/><stop offset="100%" stop-color="#059669"/>
          </linearGradient>
        </defs>
        <rect rx="12" width="36" height="36" fill="url(#g)"/>
        <path d="M10 12l5 8v4h-3v-3l-5-9h3zM26 12l-5 8v-3l5-9h-3z" fill="#fff"/>
      </svg>
      <div class="text-xl font-semibold tracking-tight">YiThume</div>
    </div>

    <!-- Desktop nav -->
    <nav class="hidden md:flex items-center gap-6" aria-label="Primary">
      <a href="#how" class="text-sm hover:text-emerald-700">How It Works</a>
      <a href="#services" class="text-sm hover:text-emerald-700">Services</a>
      <a href="#pricing" class="text-sm hover:text-emerald-700">Pricing &amp; Zones</a>
      <a href="#drivers" class="text-sm hover:text-emerald-700">For Drivers</a>
      <a href="#faq" class="text-sm hover:text-emerald-700">FAQ</a>
    </nav>

    <div class="flex items-center gap-2">
      <!-- Mobile hamburger -->
      <button id="mobileMenuBtn"
        class="md:hidden p-2 rounded-lg border border-slate-300 active:scale-95 transition"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobileNavDropdown">
        <svg id="mobileMenuIconOpen" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 6h16M4 12h16M4 18h16"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg id="mobileMenuIconClose" width="20" height="20" viewBox="0 0 24 24" class="hidden" fill="none" aria-hidden="true">
          <path d="M6 6L18 18M6 18L18 6"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <!-- CTAs (desktop / sm+) -->
      <div class="hidden sm:flex items-center gap-2">
        <button id="openOrderBuilderTop"
          class="px-3 py-2 text-sm rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
          Start order
        </button>
        <button id="openDriverModalTop"
          class="px-3 py-2 text-sm rounded-xl border border-slate-300 hover:bg-slate-100">
          Driver sign-in / up
        </button>

        <button id="adminLoginBtn"
          class="px-3 py-2 text-xs rounded-xl border border-slate-300 hover:bg-slate-100">
          Admin
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile dropdown nav -->
  <div id="mobileNavDropdown"
       class="md:hidden hidden border-t border-slate-200 bg-white shadow-xl"
       role="menu" aria-label="Mobile navigation">
    <nav class="px-4 py-4 text-sm flex flex-col gap-2 max-w-6xl mx-auto w-full">
      <a href="#how" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">How It Works</a>
      <a href="#services" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">Services</a>
      <a href="#pricing" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">Pricing &amp; Zones</a>
      <a href="#drivers" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">For Drivers</a>
      <a href="#faq" class="py-2 rounded-lg hover:bg-slate-50 block mobile-nav-link" role="menuitem">FAQ</a>

      <div class="h-px bg-slate-200 my-3"></div>

      <button id="openOrderBuilderTopMobile"
        class="w-full py-2 rounded-xl bg-emerald-600 text-white text-center active:scale-[.98] transition mobile-nav-link">
        Start order
      </button>

      <button id="openDriverModalTopMobile"
        class="w-full py-2 rounded-xl border border-slate-300 text-center active:scale-[.98] transition mobile-nav-link">
        Driver sign-in / up
      </button>

      <button id="adminLoginBtnMobile"
        class="w-full py-2 rounded-xl border border-slate-300 text-center text-xs active:scale-[.98] transition mobile-nav-link">
        Admin
      </button>
    </nav>
  </div>
</header>

<!-- Hero -->
<section class="relative">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-14 sm:py-20 grid md:[grid-template-columns:1.2fr_1fr] gap-10 items-stretch">
    <!-- Left card -->
    <div class="flex">
      <div class="rounded-3xl border bg-white p-6 shadow-sm h-full w-full min-h-[var(--hero-h)] flex flex-col">
        <div>
          <h1 class="text-4xl sm:text-5xl font-bold leading-tight">
            Health delivered. <span class="text-emerald-600">Fast</span>.
          </h1>
          <p class="mt-4 text-slate-700 max-w-xl">
            Order on the website, then we confirm and send a secure payment link in WhatsApp. Clear pricing, trusted local drivers.
          </p>
        </div>
        <ul class="mt-6 grid grid-cols-2 gap-3 text-sm">
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Website ➜ WhatsApp</b>
              <div class="text-slate-500 text-xs">No app needed</div>
            </div>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Same-day windows</b>
              <div class="text-slate-500 text-xs">08–10 • 12–14 • 16–18</div>
            </div>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Card or EFT</b>
              <div class="text-slate-500 text-xs">Yoco link / Ozow EFT</div>
            </div>
          </li>
          <li class="flex items-start gap-2">
            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700">✓</span>
            <div>
              <b>Deposit + COD</b>
              <div class="text-slate-500 text-xs">Returning customers only</div>
            </div>
          </li>
        </ul>
        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <button id="openOrderBuilder" class="px-5 py-3 rounded-2xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700">
            Start order
          </button>
          <button id="openDriverModal" class="px-5 py-3 rounded-2xl border border-slate-300 text-slate-800 text-sm font-medium hover:bg-slate-100">
            Sign up / Log in (Driver)
          </button>
        </div>
        <div class="mt-3 text-xs text-slate-500">Build your basket here — we’ll send it to WhatsApp for confirmation &amp; payment.</div>
        <div class="mt-auto"></div>
      </div>
    </div>

    <!-- Right map card -->
    <div class="flex">
      <div class="rounded-3xl border bg-white p-3 shadow-sm h-full w-full relative min-h-[var(--hero-h)]">
        <div class="flex items-center justify-between px-1 pb-2">
          <div class="text-sm text-slate-600">Coverage map</div>
          <span class="px-2 py-1 text-xs rounded-lg bg-emerald-100 text-emerald-700">LIVE</span>
        </div>
        <div id="heroMap" class="rounded-2xl" aria-label="Active delivery coverage map"></div>
        <div class="tint" aria-hidden="true"></div>
        <div class="ec-badge">Eastern Cape</div>
      </div>
    </div>
  </div>
</section>

<!-- How it works -->
<section id="how" class="py-12 sm:py-16 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <h2 class="text-2xl sm:text-3xl font-bold">How YiThume Works</h2>
    <div class="mt-6 grid md:grid-cols-4 gap-4">
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 1</div>
        <div class="mt-1 font-semibold">Build order</div>
        <p class="mt-2 text-sm text-slate-700">Choose items and delivery zone on the website.</p>
      </div>
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 2</div>
        <div class="mt-1 font-semibold">WhatsApp confirm</div>
        <p class="mt-2 text-sm text-slate-700">We send summary + payment instructions in WhatsApp.</p>
      </div>
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 3</div>
        <div class="mt-1 font-semibold">Pay online</div>
        <p class="mt-2 text-sm text-slate-700">
          Card link (Yoco) or Instant EFT (Ozow). Returning customers can do 50% deposit + COD.
        </p>
      </div>
      <div class="p-5 rounded-2xl bg-white border shadow-sm">
        <div class="text-sm text-slate-500">Step 4</div>
        <div class="mt-1 font-semibold">Delivery</div>
        <p class="mt-2 text-sm text-slate-700">
          We dispatch a verified local driver in your time window.
        </p>
      </div>
    </div>
  </div>
</section>

<!-- Services / Drivers pitch block -->
<section id="drivers" class="py-12 sm:py-16 border-t border-slate-200 bg-white/50">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 grid md:grid-cols-2 gap-8">
    <div class="rounded-2xl border bg-white shadow-sm p-6 flex flex-col">
      <div class="text-xs font-semibold uppercase tracking-wide text-emerald-700">Drive with us</div>
      <h2 class="text-2xl sm:text-3xl font-bold mt-2 leading-tight">
        We deliver to remote locations using trusted local drivers.
      </h2>
      <p class="mt-3 text-sm text-slate-700 leading-relaxed">
        Sign up to put your community on the map and get paid per successful delivery.
        Flexible windows, weekly EFT payouts.
      </p>
      <ul class="mt-4 text-sm space-y-2">
        <li class="flex items-start gap-2">
          <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700 text-[11px] font-bold">1</span>
          <div>
            Take small health + essentials orders from local shops to local people.
          </div>
        </li>
        <li class="flex items-start gap-2">
          <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700 text-[11px] font-bold">2</span>
          <div>
            Get a payout per drop. You’ll always see the amount before you accept.
          </div>
        </li>
        <li class="flex items-start gap-2">
          <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-md bg-emerald-100 text-emerald-700 text-[11px] font-bold">3</span>
          <div>
            We handle payment and customer support. You just deliver.
          </div>
        </li>
      </ul>

      <button id="openDriverModalSection"
        class="mt-6 inline-flex justify-center px-4 py-3 rounded-xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700">
        Become a driver
      </button>

      <div class="mt-3 text-[11px] text-slate-500 leading-snug">
        We’re especially looking for reliable drivers in rural / township areas.
      </div>
    </div>

    <div class="rounded-2xl border bg-white shadow-sm p-6 flex flex-col" id="services">
      <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">What we deliver</div>
      <h2 class="text-xl sm:text-2xl font-bold mt-2 leading-tight">OTC meds &amp; essentials</h2>
      <p class="mt-3 text-sm text-slate-700 leading-relaxed">
        Flu, pain, stomach, allergy, dressings, hydration, pads, nappies, hygiene basics —
        all from local independent pharmacies and shops.
      </p>
      <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">Headache &amp; fever</div>
          <div class="text-[11px] text-slate-500">Panado, etc.</div>
        </div>
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">Cold &amp; flu</div>
          <div class="text-[11px] text-slate-500">Cough syrups, throat</div>
        </div>
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">Tummy &amp; hydration</div>
          <div class="text-[11px] text-slate-500">Electrolytes, nausea</div>
        </div>
        <div class="rounded-xl border p-3 bg-slate-50/50">
          <div class="font-medium text-slate-800">First aid &amp; hygiene</div>
          <div class="text-[11px] text-slate-500">Bandages, pads, etc.</div>
        </div>
      </div>

      <div class="mt-auto pt-6 text-[11px] text-slate-500 leading-snug">
        We are a delivery service only. We do not provide medical advice.
      </div>
    </div>
  </div>
</section>

<!-- Pricing & Zones -->
<section id="pricing" class="py-12 sm:py-16 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <h2 class="text-2xl sm:text-3xl font-bold">Pricing &amp; Zones</h2>
    <div class="mt-6 overflow-hidden rounded-2xl border bg-white">
      <table class="w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="py-3 px-4 text-left">Zone</th>
            <th class="py-3 px-4 text-left">Areas</th>
            <th class="py-3 px-4 text-left">Delivery Fee</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-t">
            <td class="py-3 px-4 font-medium">Zone A</td>
            <td class="py-3 px-4">Port Alfred, Nemato, East Beach, Seafield</td>
            <td class="py-3 px-4">R25</td>
          </tr>
          <tr class="border-t">
            <td class="py-3 px-4 font-medium">Zone B</td>
            <td class="py-3 px-4">Bathurst, Eluce/Elitsi</td>
            <td class="py-3 px-4">R35</td>
          </tr>
          <tr class="border-t">
            <td class="py-3 px-4 font-medium">Zone C</td>
            <td class="py-3 px-4">Kenton-on-Sea, Bushmans River, Boesmansriviermond</td>
            <td class="py-3 px-4">R45</td>
          </tr>
          <tr class="border-t">
            <td class="py-3 px-4 font-medium">Zone D</td>
            <td class="py-3 px-4">Makhanda/Grahamstown, Eirini</td>
            <td class="py-3 px-4">R60</td>
          </tr>
          <tr class="border-t">
            <td class="py-3 px-4 font-medium">Zone E</td>
            <td class="py-3 px-4">Alexandria, Alicedale, Surrounding Rural Areas</td>
            <td class="py-3 px-4">R70</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="mt-4 text-xs text-slate-500">Delivery days: Wed–Sun. Rush +R30 when available.</div>
  </div>
</section>

<!-- FAQ -->
<section id="faq" class="py-12 sm:py-16 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <h2 class="text-2xl sm:text-3xl font-bold">FAQ</h2>
    <div class="mt-6 grid md:grid-cols-2 gap-4">
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">How do I pay?</summary>
        <p class="mt-2 text-sm text-slate-700">
          We send a secure <b>Yoco card link</b> or <b>Ozow Instant EFT</b> via WhatsApp. Returning customers may use
          <b>50% deposit + COD</b> for the balance at delivery.
        </p>
      </details>
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">Cash on delivery?</summary>
        <p class="mt-2 text-sm text-slate-700">
          To keep orders safe, first-time customers pay online. For repeat customers, COD is available with a
          <b>50% deposit</b>. Drivers wait up to 5 minutes. Failed delivery forfeits the deposit.
        </p>
      </details>
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">Do you give medical advice?</summary>
        <p class="mt-2 text-sm text-slate-700">
          No. YiThume provides delivery only. Always follow your healthcare provider’s guidance.
        </p>
      </details>
      <details class="p-4 rounded-xl bg-white border shadow-sm">
        <summary class="font-medium cursor-pointer">Where do you operate?</summary>
        <p class="mt-2 text-sm text-slate-700">
          Port Alfred, Bathurst, Kenton-on-Sea, Makhanda/Grahamstown, Alice, Alexandria, Alicedale (more soon).
        </p>
      </details>
    </div>
  </div>
</section>

<!-- Footer -->
<footer class="py-10 border-t border-slate-200">
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div>
        <div class="font-semibold">YiThume</div>
        <div class="text-xs text-slate-500">
          Delivery service only • POPIA compliant • © <span id="year"></span>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row gap-3">
        <button id="openOrderBuilderFooter"
          class="px-3 py-2 text-sm rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
          Start order
        </button>
        <button id="openDriverModalFooter"
          class="px-3 py-2 text-sm rounded-xl border border-slate-300 hover:bg-slate-100">
          Driver sign-in / up
        </button>
        <button id="openStoreModalFooter"
          class="px-3 py-2 text-sm rounded-xl border border-emerald-300 text-emerald-700 hover:bg-emerald-50">
          Add your store
        </button>
      </div>
    </div>
  </div>
</footer>

<!-- Driver Auth Modal -->
<div id="driverModal"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[9999] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="driverModalTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-md flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold">
        <div id="driverModalTitle">Driver Portal</div>
        <div class="text-xs text-slate-500">Get paid weekly per drop</div>
      </div>
      <button id="closeDriverModal" class="text-slate-500 hover:text-slate-700" aria-label="Close driver modal">✕</button>
    </div>

    <div class="p-4 text-sm">
      <div class="flex gap-2 mb-4">
        <button id="tabSignup" class="flex-1 py-2 text-center rounded-lg bg-emerald-600 text-white">Sign up</button>
        <button id="tabLogin"  class="flex-1 py-2 text-center rounded-lg border border-slate-300">Log in</button>
      </div>

      <!-- Signup form -->
      <form id="driverFormSignup" class="space-y-3">
        <label class="block">
          <div class="text-xs font-medium text-slate-600">Full Name</div>
          <input id="drvName" class="mt-1 w-full border rounded-lg p-2" placeholder="Name" required />
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">WhatsApp Number</div>
          <input id="drvPhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required />
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">Your Zone</div>
          <select id="drvZone" class="mt-1 w-full border rounded-lg p-2">
            <option value="A">Zone A – Port Alfred</option>
            <option value="B">Zone B – Bathurst</option>
            <option value="C">Zone C – Kenton</option>
            <option value="D">Zone D – Makhanda / Grahamstown / Alice</option>
            <option value="E">Zone E – Alexandria / Alicedale</option>
          </select>
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">How far you’ll drive (km)</div>
          <input id="drvRadius" type="number" min="1" class="mt-1 w-full border rounded-lg p-2" value="10" />
        </label>

        <label class="block">
          <div class="text-xs font-medium text-slate-600">Vehicle (car, bakkie, scooter, etc.)</div>
          <input id="drvVehicle" class="mt-1 w-full border rounded-lg p-2" placeholder="e.g. Polo Vivo" />
        </label>

        <button type="submit" class="w-full py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700">
          Submit
        </button>
      </form>

      <!-- Login form -->
      <form id="driverFormLogin" class="space-y-3 hidden">
        <label class="block">
          <div class="text-xs font-medium text-slate-600">WhatsApp Number</div>
          <input id="drvLoginPhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required />
        </label>

        <button type="submit" class="w-full py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700">
          Log in
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Driver Dashboard Modal (Demo) -->
<div id="driverDashModal"
     class="fixed inset-0 hidden items-start justify-center pt-12 sm:pt-16 bg-black/40 p-4 z-[10000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="driverDashTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-md flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold">
        <div id="driverDashTitle">Driver Dashboard</div>
        <div class="text-xs text-slate-500">Your current stats</div>
      </div>
      <button id="closeDriverDash" class="text-slate-500 hover:text-slate-700" aria-label="Close driver dashboard modal">✕</button>
    </div>

    <div class="p-4 text-sm space-y-3">
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Pending balance</div>
        <div class="text-lg font-semibold">R<span id="driverPayoutPending">0</span></div>
        <div class="text-[11px] text-slate-500 leading-snug">
          You’ve accepted these drops. Waiting for admin approval.
        </div>
      </div>
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Approved payout</div>
        <div class="text-lg font-semibold">R<span id="driverPayoutApproved">0</span></div>
        <div class="text-[11px] text-slate-500 leading-snug">
          Will be paid to you by EFT.
        </div>
      </div>
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Next delivery window</div>
        <div class="text-lg font-semibold" id="driverNextWindow">Fri 17:00</div>
      </div>
      <div class="rounded-lg border p-3">
        <div class="text-xs text-slate-500">Your zone / km radius</div>
        <div class="text-lg font-semibold">
          <span id="driverZoneDisplay">A</span> / <span id="driverRadiusDisplay">10km</span>
        </div>
      </div>
      <div class="text-[11px] text-slate-500 leading-snug">
        Drivers are paid weekly by EFT.
      </div>
    </div>
  </div>
</div>

<!-- Bot-style Checkout Modal -->
<div id="botChat"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[9500] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="botChatTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-md flex flex-col max-h-[80vh] outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="botChatTitle">Checkout</span>
        <span class="text-xs text-slate-500">We’ll confirm in WhatsApp</span>
      </div>
      <button id="closeBot" class="text-slate-500 hover:text-slate-700" aria-label="Close checkout modal">✕</button>
    </div>

    <div id="botFeed" class="flex-1 overflow-y-auto p-4 space-y-2 text-sm bg-slate-50" aria-live="polite"></div>

    <div class="p-4 border-t space-y-3 text-sm">
      <label class="block">
        <div class="text-xs font-medium text-slate-600">Payment method</div>
        <select id="botPayChoice" class="mt-1 w-full border rounded-lg p-2">
          <option value="card">Card (Yoco link)</option>
          <option value="eft">Instant EFT (Ozow)</option>
          <option value="deposit_cod">50% deposit + COD</option>
        </select>
      </label>

      <div class="flex flex-wrap gap-2">
        <button id="botNext" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700">
          Pay
        </button>
        <button id="botSendWA" class="flex-1 py-2 rounded-xl border border-slate-300 font-medium hover:bg-slate-100 hidden">
          Send to WhatsApp
        </button>
        <button id="botNewOrder" class="flex-1 py-2 rounded-xl border border-slate-300 font-medium hover:bg-slate-100 hidden">
          New order
        </button>
      </div>

      <div class="text-[11px] text-slate-500 leading-snug" id="botDemoNote" hidden>
        No money is taken — this is just a demo. We’ll WhatsApp a real secure link.
      </div>
    </div>
  </div>
</div>

<!-- FAKE Payment Modal -->
<div id="payModal"
     class="fixed inset-0 hidden items-start justify-center pt-20 bg-black/60 p-4 z-[9600] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="payModalTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-sm flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="payModalTitle">Secure Payment (Demo)</span>
        <span class="text-xs text-slate-500">This is a preview — no real charge yet</span>
      </div>
      <button id="closePayModal" class="text-slate-500 hover:text-slate-700" aria-label="Close payment modal">✕</button>
    </div>

    <div class="p-4 text-sm space-y-2">
      <div><b>Order Ref:</b> <span id="payOrderRef">--</span></div>
      <div><b>Amount:</b> R<span id="payAmount">0</span></div>
      <div class="text-[11px] text-slate-500 leading-snug">
        We’ll send the real Yoco / Ozow payment link in WhatsApp once confirmed.
      </div>
      <div class="text-[11px] text-emerald-700 leading-snug font-medium">
        No money is taken here. This is just a demo.
      </div>
    </div>

    <div class="p-4 border-t flex flex-col sm:flex-row gap-2 text-sm">
      <button id="btnFakePayNow" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
        Pay
      </button>
      <button id="btnCancelPay" class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Order Builder Modal -->
<div id="orderBuilder"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[9000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="orderBuilderTitle">
  <div class="w-full max-w-xl rounded-2xl bg-white shadow-xl border flex flex-col max-h-[85vh] outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="orderBuilderTitle">Your Order</span>
        <span class="text-xs text-slate-500">We’ll confirm by WhatsApp</span>
      </div>
      <button id="closeOrderBuilder" class="text-slate-500 hover:text-slate-700" aria-label="Close order builder modal">✕</button>
    </div>

    <div class="flex-1 overflow-y-auto p-4 space-y-5 text-sm">
      <!-- Items list -->
      <div>
        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-600 font-medium">Items</div>
          <button id="addCustomItem" class="text-[11px] text-emerald-700 underline">+ Add custom</button>
        </div>
        <div id="itemsList" class="mt-2 grid gap-2"></div>
      </div>

      <!-- Zone -->
      <div>
        <label class="block text-xs text-slate-600 font-medium">Delivery zone</label>
        <select id="zoneSelect" class="mt-1 w-full border rounded-lg p-2">
          <option value="A" data-fee="25" data-lat="-33.590" data-lng="26.890">Zone A — Port Alfred (R25)</option>
          <option value="B" data-fee="35" data-lat="-33.498" data-lng="26.833">Zone B — Bathurst (R35)</option>
          <option value="C" data-fee="45" data-lat="-33.686" data-lng="26.668">Zone C — Kenton / Bushmans (R45)</option>
          <option value="D" data-fee="60" data-lat="-33.310" data-lng="26.520">Zone D — Makhanda / Grahamstown / Alice (R60)</option>
          <option value="E" data-fee="70" data-lat="-33.653" data-lng="26.404">Zone E — Alexandria / Alicedale (R70)</option>
        </select>
        <div class="flex items-center gap-2 mt-2">
          <input id="rushToggle" type="checkbox" class="h-4 w-4" />
          <label for="rushToggle" class="text-xs text-slate-600">
            Rush (+R30 when available)<span id="rushNote" class="text-[10px] text-amber-700"></span>
          </label>
        </div>
      </div>

      <!-- Customer details -->
      <div class="grid sm:grid-cols-2 gap-3">
        <label class="block">
          <div class="text-xs text-slate-600 font-medium">Your name</div>
          <input id="custName" class="mt-1 w-full border rounded-lg p-2" placeholder="Full name" required />
        </label>
        <label class="block">
          <div class="text-xs text-slate-600 font-medium">WhatsApp number</div>
          <input id="custPhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required />
        </label>
      </div>

      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Delivery address</div>
        <textarea id="custAddress" class="mt-1 w-full border rounded-lg p-2" rows="2" placeholder="House number, street, area" required></textarea>
      </label>

      <!-- Payment choice -->
      <div>
        <div class="text-xs text-slate-600 font-medium mb-1">How will you pay?</div>
        <div class="space-y-2">
          <label class="flex items-start gap-2">
            <input type="radio" name="pay" value="card" class="mt-1" checked>
            <div>
              <div class="text-sm font-medium">Card link (Yoco)</div>
              <div class="text-[11px] text-slate-500">Tap and pay from your phone.</div>
            </div>
          </label>

          <label class="flex items-start gap-2">
            <input type="radio" name="pay" value="eft" class="mt-1">
            <div>
              <div class="text-sm font-medium">Instant EFT (Ozow)</div>
              <div class="text-[11px] text-slate-500">Instant secure bank transfer.</div>
            </div>
          </label>

          <label class="flex items-start gap-2">
            <input type="radio" name="pay" value="deposit_cod" class="mt-1">
            <div>
              <div class="text-sm font-medium">50% deposit + COD</div>
              <div class="text-[11px] text-slate-500">Returning customers only.</div>
            </div>
          </label>
        </div>
      </div>

      <!-- Deposit banner -->
      <div id="depositBanner"
           class="hidden rounded-lg border border-amber-300 bg-amber-50 text-amber-800 text-[11px] leading-snug p-2">
        You’ll pay a deposit of R<span id="depositAmt">0</span> to lock your driver. Balance on delivery.
      </div>

      <!-- Total -->
      <div class="rounded-xl bg-slate-50 border p-3 text-sm flex flex-col gap-2">
        <div class="flex justify-between">
          <div>Total to pay now</div>
          <div class="font-semibold">R<span id="orderTotal">0</span></div>
        </div>
        <div class="text-[11px] text-slate-500 leading-snug">
          We’ll confirm and send a payment link on WhatsApp. If we can’t deliver, you’re refunded.
        </div>
      </div>
    </div>

    <div class="p-4 border-t flex flex-col sm:flex-row gap-2 text-sm">
      <button id="confirmOrderBtn"
              class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
        Confirm &amp; Continue
      </button>
      <button class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100" id="cancelOrderBuilder">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Orders Panel (Admin) -->
<div id="ordersPanel"
     class="fixed inset-0 hidden items-start justify-center pt-16 sm:pt-20 bg-black/40 p-4 z-[11000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="ordersPanelTitle">
  <div class="bg-white rounded-2xl shadow-xl border w-full max-w-2xl flex flex-col max-h-[85vh] outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="ordersPanelTitle">Orders Admin</span>
        <span class="text-xs text-slate-500">Assign drivers • Mark delivered</span>
      </div>
      <button id="closeOrdersPanel" class="text-slate-500 hover:text-slate-700" aria-label="Close admin panel">✕</button>
    </div>

    <!-- tabs -->
    <div class="p-4 border-b flex flex-wrap gap-2 text-xs" role="tablist" aria-label="Order status filter">
      <button class="yt-o-tab px-3 py-1 rounded-lg bg-emerald-600 text-white" data-o-tab="pending" role="tab" aria-selected="true">
        Pending
      </button>
      <button class="yt-o-tab px-3 py-1 rounded-lg border border-slate-300" data-o-tab="review_required" role="tab" aria-selected="false">
        Review
      </button>
      <button class="yt-o-tab px-3 py-1 rounded-lg border border-slate-300" data-o-tab="assigned" role="tab" aria-selected="false">
        Assigned
      </button>
      <button class="yt-o-tab px-3 py-1 rounded-lg border border-slate-300" data-o-tab="in_transit" role="tab" aria-selected="false">
        In transit
      </button>
      <button class="yt-o-tab px-3 py-1 rounded-lg border border-slate-300" data-o-tab="delivered" role="tab" aria-selected="false">
        Delivered
      </button>
    </div>

    <div class="flex-1 overflow-y-auto p-4 space-y-4 text-sm" id="ordersList" aria-live="polite">
      <!-- JS fills orders -->
    </div>

    <div class="p-4 border-t flex flex-col sm:flex-row gap-2 text-sm">
      <button id="ordersRefresh" class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">
        Refresh
      </button>
      <button id="ordersAssign"
              class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
        Auto assign all
      </button>
    </div>
  </div>
</div>

<!-- Store Onboarding Modal -->
<div id="storeModal"
     class="fixed inset-0 hidden items-start justify-center pt-12 sm:pt-16 bg-black/40 p-4 z-[12000] overflow-y-auto"
     role="dialog" aria-modal="true" aria-labelledby="storeModalTitle">
  <div class="w-full max-w-xl rounded-2xl bg-white shadow-xl border flex flex-col outline-none" tabindex="-1">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="font-semibold flex flex-col">
        <span id="storeModalTitle">Add Your Store</span>
        <span class="text-xs text-slate-500">We’ll list your items for delivery</span>
      </div>
      <button id="closeStoreModal" class="text-slate-500 hover:text-slate-700" aria-label="Close store modal">✕</button>
    </div>

    <div class="p-4 space-y-4 text-sm">
      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Store name</div>
        <input id="storeName" class="mt-1 w-full border rounded-lg p-2" placeholder="e.g. Bathurst Health Shop" required>
      </label>

      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Store WhatsApp</div>
        <input id="storePhone" class="mt-1 w-full border rounded-lg p-2" placeholder="2782..." required>
      </label>

      <label class="block">
        <div class="text-xs text-slate-600 font-medium">Zone</div>
        <select id="storeZone" class="mt-1 w-full border rounded-lg p-2">
          <option value="A">Zone A – Port Alfred</option>
          <option value="B">Zone B – Bathurst</option>
          <option value="C">Zone C – Kenton / Bushmans</option>
          <option value="D">Zone D – Makhanda / Eirini</option>
          <option value="E">Zone E – Alexandria / Alicedale</option>
        </select>
      </label>

      <div>
        <div class="text-xs text-slate-600 font-medium mb-2 flex items-center justify-between">
          <span>Items you sell</span>
          <button id="addStoreItem" class="text-emerald-700 underline text-[11px]">+ Add item</button>
        </div>
        <div id="storeItemsList" class="space-y-2"></div>
      </div>

      <div class="rounded-lg bg-slate-50 border p-2 text-[11px] text-slate-600 leading-snug">
        We'll review and then list your store so people can buy through YiThume and get same-day local delivery.
      </div>
    </div>

    <div class="p-4 border-t flex flex-col sm:flex-row gap-2 text-sm">
      <button id="submitStore" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 font-medium">
        Submit store
      </button>
      <button id="cancelStore" class="flex-1 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">
        Cancel
      </button>
    </div>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // === CONFIG & GLOBALS ===
  const BASE_API = "/api/app";
  const WHATSAPP_NUMBER = "270691456201";
  const ADMIN_WHATSAPP  = "270691456201";
  const DEMO_MODE       = true; // set to false when backend is ready

  function waText(str) { return encodeURIComponent(str); }
  function digits(val){ return (val||"").replace(/\D+/g,''); }

  // === BODY SCROLL LOCK + FOCUS RESTORE ===
  const lastFocus = new Map();
  function firstFocusable(el){
    return el.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
  }
  function lockScroll(){ document.body.classList.add('overflow-locked'); }
  function unlockScroll(){ document.body.classList.remove('overflow-locked'); }
  function openFlex(el){
    if(!el) return;
    lastFocus.set(el, document.activeElement);
    el.classList.remove('hidden');
    el.classList.add('flex');
    lockScroll();
    setTimeout(()=>{ const ff = firstFocusable(el); if(ff) ff.focus(); }, 0);
  }
  function closeFlex(el){
    if(!el) return;
    el.classList.add('hidden');
    el.classList.remove('flex');
    unlockScroll();
    const prev = lastFocus.get(el);
    if(prev && typeof prev.focus === 'function') prev.focus();
  }

  // ESC closes the topmost visible modal
  document.addEventListener('keydown', (e)=>{
    if(e.key !== 'Escape') return;
    const modals = [
      document.getElementById('ordersPanel'),
      document.getElementById('storeModal'),
      document.getElementById('driverDashModal'),
      document.getElementById('driverModal'),
      document.getElementById('payModal'),
      document.getElementById('botChat'),
      document.getElementById('orderBuilder')
    ];
    for(const m of modals){
      if(m && !m.classList.contains('hidden')) { closeFlex(m); break; }
    }
  });

  // === RUNTIME / GLOBAL STATE ===
  let latestOrderData = null;
  let zoneDemandStats = {};
  let botStage = 0;
  const currentOrdersByTab = {};

  // lightweight in-memory driver balances for demo
  let driverTotals = {
    pending: 0,
    approved: 0
  };

  // store onboarding state
  const storeItems = []; // {name, price}

  // === YEAR FOOTER ===
  const yearEl = document.getElementById('year');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // === ELEMENT REFS ===
  // mobile nav
  const mobileBtn       = document.getElementById('mobileMenuBtn');
  const mobileDropdown  = document.getElementById('mobileNavDropdown');
  const mobileIconOpen  = document.getElementById('mobileMenuIconOpen');
  const mobileIconClose = document.getElementById('mobileMenuIconClose');

  // order builder / checkout modal
  const modal               = document.getElementById('orderBuilder');
  const openOrderButtons    = ['openOrderBuilder','openOrderBuilderTop','openOrderBuilderFooter'];
  const closeBtn            = document.getElementById('closeOrderBuilder');
  const cancelOrderBuilder  = document.getElementById('cancelOrderBuilder');
  const itemsList           = document.getElementById('itemsList');
  const zoneSelect          = document.getElementById('zoneSelect');
  const rushToggle          = document.getElementById('rushToggle');
  const totalEl             = document.getElementById('orderTotal');
  const rushNote            = document.getElementById('rushNote');
  const depositBanner       = document.getElementById('depositBanner');
  const depositAmtEl        = document.getElementById('depositAmt');
  const custNameEl          = document.getElementById('custName');
  const custPhoneEl         = document.getElementById('custPhone');
  const custAddrEl          = document.getElementById('custAddress');

  const adminBtn            = document.getElementById('adminLoginBtn');

  // Bot modal refs
  const confirmBtn2         = document.getElementById('confirmOrderBtn');
  const botModal            = document.getElementById('botChat');
  const botClose            = document.getElementById('closeBot');
  const botFeed             = document.getElementById('botFeed');
  const botNext             = document.getElementById('botNext');
  const botSendWA           = document.getElementById('botSendWA');
  const botNewOrder         = document.getElementById('botNewOrder');
  const botPayChoice        = document.getElementById('botPayChoice');
  const botDemoNote         = document.getElementById('botDemoNote');

  // Payment modal refs
  const payModal            = document.getElementById('payModal');
  const payOrderRef         = document.getElementById('payOrderRef');
  const payAmountEl         = document.getElementById('payAmount');
  const closePayModalBtn    = document.getElementById('closePayModal');
  const btnFakePayNow       = document.getElementById('btnFakePayNow');
  const btnCancelPay        = document.getElementById('btnCancelPay');

  // Driver modal refs
  const driverModal         = document.getElementById('driverModal');
  const closeDriver         = document.getElementById('closeDriverModal');
  const tabSignup           = document.getElementById('tabSignup');
  const tabLogin            = document.getElementById('tabLogin');
  const formSignup          = document.getElementById('driverFormSignup');
  const formLogin           = document.getElementById('driverFormLogin');

  // Driver dashboard modal refs (demo only)
  const driverDashModal     = document.getElementById('driverDashModal');
  const closeDriverDash     = document.getElementById('closeDriverDash');
  const driverPayoutPendingEl   = document.getElementById('driverPayoutPending');
  const driverPayoutApprovedEl  = document.getElementById('driverPayoutApproved');
  const driverNextWindowEl  = document.getElementById('driverNextWindow');
  const driverZoneDisplayEl = document.getElementById('driverZoneDisplay');
  const driverRadiusDisplayEl = document.getElementById('driverRadiusDisplay');

  // For "Drive with us" CTA
  const openDriverModalSection = document.getElementById('openDriverModalSection');

  // Admin panel refs
  const ordersPanel         = document.getElementById('ordersPanel');
  const ordersList          = document.getElementById('ordersList');
  const ordersClose         = document.getElementById('closeOrdersPanel');
  const ordersAssign        = document.getElementById('ordersAssign');
  const ordersRefresh       = document.getElementById('ordersRefresh');
  let   ordersTab           = 'pending';

  // Admin mobile buttons (mirror desktop)
  const adminBtnMobile      = document.getElementById('adminLoginBtnMobile');

  // Store modal refs
  const storeModal          = document.getElementById('storeModal');
  const openStoreFooter     = document.getElementById('openStoreModalFooter');
  const closeStoreModalBtn  = document.getElementById('closeStoreModal');
  const cancelStoreBtn      = document.getElementById('cancelStore');
  const submitStoreBtn      = document.getElementById('submitStore');
  const addStoreItemBtn     = document.getElementById('addStoreItem');
  const storeItemsList      = document.getElementById('storeItemsList');
  const storeNameEl         = document.getElementById('storeName');
  const storePhoneEl        = document.getElementById('storePhone');
  const storeZoneEl         = document.getElementById('storeZone');

  // === CATALOG ===
  const CATALOG = [
    {name:'Panado 500mg (24s)',price:35},
    {name:'Allergex 10mg (10s)',price:30},
    {name:'Cough Syrup 100ml',price:55},
    {name:'Electrolyte Sachet',price:15},
    {name:'Bandages (set)',price:25}
  ];

  // === HELPERS ===
  function renderItems(){
    itemsList.innerHTML = '';
    CATALOG.forEach((item,idx)=>{
      const row=document.createElement('div');
      row.className='flex items-center justify-between gap-3 border rounded-lg p-2';
      row.innerHTML = '
        <label class="flex items-center gap-2">
          <input type="checkbox" data-idx="${idx}" class="itemCheck h-4 w-4"/>
          <span>${item.name}</span>
        </label>
        <div class="flex items-center gap-2">
          <span class="text-slate-500">R${item.price}</span>
          <input
            type="number"
            min="1"
            value="1"
            aria-label="Quantity for ${item.name}"
            data-idx="${idx}"
            class="itemQty w-14 border rounded-lg p-1"
          />
        </div>';
      itemsList.appendChild(row);
    });
  }

  function selectedPay(){
    const el = document.querySelector('input[name="pay"]:checked');
    return el ? el.value : 'card';
  }

  function computeTotal(){
    const opt     = zoneSelect.options[zoneSelect.selectedIndex];
    const feeBase = Number(opt.dataset.fee || 0);
    const rushFee = rushToggle.checked ? 30 : 0;
    rushNote.textContent = rushFee ? ' + rush' : '';

    const items = Array.from(document.querySelectorAll('.itemCheck'))
      .filter(c => c.checked)
      .map(c => {
        const i   = Number(c.dataset.idx);
        const qty = Math.max(1, Number(document.querySelector(\'.itemQty[data-idx="\${i}"]\').value || 1));
        return {
          name:  CATALOG[i].name,
          price: Number(CATALOG[i].price),
          qty:   qty
        };
      });

    const itemsTotal = items.reduce((sum,it)=> sum + (it.price * it.qty), 0);
    const total      = itemsTotal + feeBase + rushFee;

    totalEl.textContent = String(total);
    return {
      items,
      itemsTotal,
      fee: feeBase,
      rush: rushFee,
      total,
      zoneVal: opt.value,
      hubLat: Number(opt.dataset.lat),
      hubLng: Number(opt.dataset.lng)
    };
  }

  function pad2(n){return String(n).padStart(2,'0');}

  function nextETA(rush){
    const now     = new Date();
    const windows = [[8,10],[12,14],[16,18]];
    // allow: Sun(0) Wed(3) Thu(4) Fri(5) Sat(6)
    const allowed = new Set([0,3,4,5,6]);
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    function fmt(date,[h1,h2]){
      const sameDay = (date.toDateString()===new Date().toDateString());
      if (sameDay){
        return \'\${pad2(h1)}:00–\${pad2(h2)}:00 \${rush?'today (rush)':'today'}\';
      }
      return \'\${dayNames[date.getDay()]} \${pad2(h1)}:00–\${pad2(h2)}:00\';
    }

    if (allowed.has(now.getDay())){
      for(const w of windows){
        if(now.getHours()<w[1]) return fmt(now,w);
      }
    }
    for(let i=1;i<=7;i++){
      const d = new Date(now);
      d.setDate(now.getDate()+i);
      if(allowed.has(d.getDay())){
        return fmt(d,windows[0]);
      }
    }
    return 'TBC';
  }

  function toggleDepositBanner(total){
    const pay=selectedPay();
    if(pay==='deposit_cod'){
      depositAmtEl.textContent = Math.ceil(total*0.5);
      depositBanner.classList.remove('hidden');
    } else {
      depositBanner.classList.add('hidden');
    }
  }

  // === MODAL OPEN/CLOSE HELPERS (wrappers) ===
  function openOrder(){
    openFlex(modal);
    const s = computeTotal();
    toggleDepositBanner(s.total);
  }
  function closeOrder(){ closeFlex(modal); }
  function openBot(){
    botStage = 0;
    botNext.disabled = false;
    botNext.textContent = "Pay";
    botSendWA.classList.add('hidden');
    botNewOrder.classList.add('hidden');
    botDemoNote.hidden = true;
    botFeed.innerHTML = "";
    openFlex(botModal);
  }
  function closeBot(){ botFeed.innerHTML=''; closeFlex(botModal); }
  function openPayModal(orderRef, amount){
    if(!payModal) return;
    payOrderRef.textContent = orderRef || '--';
    payAmountEl.textContent = amount || '0';
    openFlex(payModal);
  }
  function closePayModal(){ closeFlex(payModal); }
  function openDriverWindow(){ openFlex(driverModal); }
  function closeDriverWindow(){ closeFlex(driverModal); }
  function openStoreModal(){ openFlex(storeModal); }
  function closeStoreModal(){ closeFlex(storeModal); }
  function openOrders(){ openFlex(ordersPanel); renderOrders(); }
  function closeOrders(){ closeFlex(ordersPanel); }
  function openDriverDash(){ 
    // refresh dashboard numbers before showing
    driverPayoutPendingEl.textContent = String(driverTotals.pending);
    driverPayoutApprovedEl.textContent = String(driverTotals.approved);
    openFlex(driverDashModal);
  }
  function closeDriverDashWindow(){ closeFlex(driverDashModal); }

  function appendBot(msg,who='bot'){
    const wrap=document.createElement('div');
    wrap.className = \'flex \${who==='bot'?'justify-start':'justify-end'}\';
    wrap.innerHTML = '
      <div class="max-w-[80%] rounded-2xl px-3 py-2 text-sm \${who==='bot'?'bg-slate-100':'bg-emerald-600 text-white'}">
        \${msg}
      </div>';
    botFeed.appendChild(wrap);
    botFeed.scrollTop = botFeed.scrollHeight;
  }

  function demandBadge(zone){
    const missCount = zoneDemandStats[zone]?.misses || 0;
    if(missCount === 0) return "";
    return \'<span class="ml-2 inline-block text-[10px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 border border-amber-300">
      demand \${missCount}x / no driver
    </span>\';
  }

  // === MOBILE NAV TOGGLE ===
  function toggleMobileMenu() {
    const isHidden = mobileDropdown.classList.contains('hidden');
    if (isHidden) {
      mobileDropdown.classList.remove('hidden');
      mobileIconOpen.classList.add('hidden');
      mobileIconClose.classList.remove('hidden');
      mobileBtn.setAttribute('aria-expanded', 'true');
    } else {
      mobileDropdown.classList.add('hidden');
      mobileIconOpen.classList.remove('hidden');
      mobileIconClose.classList.add('hidden');
      mobileBtn.setAttribute('aria-expanded', 'false');
    }
  }
  mobileBtn?.addEventListener('click', toggleMobileMenu);

  // Close mobile menu when navigating
  document.querySelectorAll('#mobileNavDropdown .mobile-nav-link').forEach(el => {
    el.addEventListener('click', () => {
      mobileDropdown.classList.add('hidden');
      mobileIconOpen.classList.remove('hidden');
      mobileIconClose.classList.add('hidden');
      mobileBtn.setAttribute('aria-expanded', 'false');
    });
  });

  // Bridge mobile menu CTA buttons to desktop handlers
  document.getElementById('openOrderBuilderTopMobile')?.addEventListener('click', ()=>{
    document.getElementById('openOrderBuilder')?.click();
  });
  document.getElementById('openDriverModalTopMobile')?.addEventListener('click', ()=>{
    document.getElementById('openDriverModal')?.click();
  });
  document.getElementById('adminLoginBtnMobile')?.addEventListener('click', ()=>{
    document.getElementById('adminLoginBtn')?.click();
  });

  // "Drive with us" CTA
  openDriverModalSection?.addEventListener('click', ()=>{
    document.getElementById('openDriverModal')?.click();
  });

  // === INIT CART UI ===
  renderItems();
  computeTotal();

  zoneSelect?.addEventListener('change', ()=>{
    const s = computeTotal(); toggleDepositBanner(s.total);
  });
  rushToggle?.addEventListener('change', ()=>{
    const s = computeTotal(); toggleDepositBanner(s.total);
  });
  document.addEventListener('change', e=>{
    if(
      (e.target.classList && e.target.classList.contains('itemCheck')) ||
      (e.target.classList && e.target.classList.contains('itemQty'))   ||
      e.target.name === 'pay'
    ){
      const s = computeTotal(); toggleDepositBanner(s.total);
    }
  });

  // Persist & prefill customer details for convenience
  [custNameEl, custPhoneEl, custAddrEl].forEach((el)=>{
    const key = 'yt_'+el.id;
    const saved = localStorage.getItem(key);
    if(saved) el.value = saved;
    el.addEventListener('input', ()=> localStorage.setItem(key, el.value));
  });

  // Add custom item to basket
  document.getElementById('addCustomItem')?.addEventListener('click', e=>{
    e.preventDefault();
    const name = prompt('Item name');
    const priceVal = prompt('Price (R)');
    const price = Number(priceVal);
    if(!name || !Number.isFinite(price) || price<=0){ return; }
    CATALOG.push({name,price});
    renderItems();
    const s=computeTotal(); toggleDepositBanner(s.total);
  });

  // === MODAL CLOSE BUTTONS ===
  botClose?.addEventListener('click', closeBot);
  closeBtn?.addEventListener('click', closeOrder);
  cancelOrderBuilder?.addEventListener('click', closeOrder);
  closePayModalBtn?.addEventListener('click', closePayModal);
  btnCancelPay?.addEventListener('click', closePayModal);

  // === Payment demo action ===
  btnFakePayNow?.addEventListener('click', ()=>{
    // simulate "paid"
    alert('No money taken. Demo only.');
    closePayModal();

    // show WA + new order buttons, note that this is demo
    botSendWA.classList.remove('hidden');
    botNewOrder.classList.remove('hidden');
    botDemoNote.hidden = false;

    appendBot('<b>Payment marked (demo)</b><br/>We'll WhatsApp you the real secure link next.', 'bot');
    botStage = 2;
  });

  // === OPEN ORDER MODAL BUTTONS ===
  openOrderButtons.forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('click', openOrder);
  });

  // === DRIVER MODAL open/close ===
  ;['openDriverModal','openDriverModalTop','openDriverModalFooter'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.addEventListener('click',openDriverWindow); }
  });
  closeDriver?.addEventListener('click',closeDriverWindow);

  // Driver tabs
  tabSignup?.addEventListener('click',()=>{
    tabSignup.classList.add('bg-emerald-600','text-white');
    tabLogin.classList.remove('bg-emerald-600','text-white');
    formSignup.classList.remove('hidden');
    formLogin.classList.add('hidden');
  });
  tabLogin?.addEventListener('click',()=>{
    tabLogin.classList.add('bg-emerald-600','text-white');
    tabSignup.classList.remove('bg-emerald-600','text-white');
    formSignup.classList.add('hidden');
    formLogin.classList.remove('hidden');
  });

  // === DRIVER DASH close ===
  closeDriverDash?.addEventListener('click', closeDriverDashWindow);

  // === STORE MODAL ===
  function renderStoreItems(){
    storeItemsList.innerHTML = '';
    storeItems.forEach((it,idx)=>{
      const row = document.createElement('div');
      row.className = "flex items-center justify-between border rounded-lg p-2";
      row.innerHTML = '
        <div class="text-sm">
          <div class="font-medium">${it.name}</div>
          <div class="text-xs text-slate-500">R${it.price}</div>
        </div>
        <button data-idx="${idx}" class="removeStoreItem text-[11px] text-red-600 underline">remove</button>
      ';
      storeItemsList.appendChild(row);
    });

    // hook remove buttons
    storeItemsList.querySelectorAll('.removeStoreItem').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-idx'));
        storeItems.splice(i,1);
        renderStoreItems();
      });
    });
  }

  openStoreFooter?.addEventListener('click', openStoreModal);
  closeStoreModalBtn?.addEventListener('click', closeStoreModal);
  cancelStoreBtn?.addEventListener('click', closeStoreModal);

  addStoreItemBtn?.addEventListener('click', e=>{
    e.preventDefault();
    const name = prompt('Item name?');
    const priceVal = prompt('Price (R)?');
    const price = Number(priceVal);
    if(!name || !Number.isFinite(price) || price<=0){ return; }
    storeItems.push({name, price});
    renderStoreItems();
  });

  submitStoreBtn?.addEventListener('click', async ()=>{
    const storeName  = storeNameEl.value.trim();
    const storePhone = digits(storePhoneEl.value.trim());
    const zone       = storeZoneEl.value;
    if(!storeName || !storePhone){
      alert("Please add store name & WhatsApp.");
      return;
    }
    if(storeItems.length === 0){
      if(!confirm("No items added yet. Submit anyway?")) return;
    }

    const payload = {
      store_id: 'STORE-${Date.now().toString().slice(-6)}',
      name: storeName,
      phone: storePhone,
      zone: zone,
      items: storeItems.map(it=>({ name: it.name, price: it.price }))
    };

    if(!DEMO_MODE){
      try{
        const r = await fetch('${BASE_API}/stores', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.ok){ alert("Store save failed on server."); }
      }catch(err){ console.error("store create failed",err); }
    } else {
      console.info("[DEMO] Would POST store", payload);
    }

    const adminMsg =
'New store signup:
Name: ${storeName}
Phone: ${storePhone}
Zone: ${zone}
Items:
${storeItems.map(i=>"- "+i.name+" (R"+i.price+")").join("\n")}';

    window.open('https://wa.me/${ADMIN_WHATSAPP}?text=${waText(adminMsg)}','_blank');

    alert("Thanks! We'll review your store.");
    closeStoreModal();

    // reset form
    storeNameEl.value = '';
    storePhoneEl.value = '';
    storeZoneEl.value = 'A';
    storeItems.splice(0,storeItems.length);
    renderStoreItems();
  });

  // === ADMIN PANEL ===
  ordersClose?.addEventListener('click', closeOrders);
  adminBtnMobile?.addEventListener('click', () => { adminBtn?.click(); });

  window.addEventListener('yt-open-orders', openOrders);
  window.addEventListener('yt-orders-updated', ()=>{
    if(!ordersPanel.classList.contains('hidden')) renderOrders();
  });

  ordersRefresh?.addEventListener('click', renderOrders);

  function updateDriverTotalsFromOrders() {
    // loop through all tabs we have locally, sum pay
    let pendingTotal = 0;
    let approvedTotal = 0;
    Object.values(currentOrdersByTab).forEach(list => {
      (list||[]).forEach(o => {
        if(o.driver_pay_status === 'pending'){
          pendingTotal += (o.driver_pay_pending || 0);
        }
        if(o.driver_pay_status === 'approved'){
          approvedTotal += (o.driver_pay_approved || 0);
        }
      });
    });
    driverTotals.pending = pendingTotal;
    driverTotals.approved = approvedTotal;

    // if dashboard visible, live update numbers
    if(driverDashModal && !driverDashModal.classList.contains('hidden')){
      driverPayoutPendingEl.textContent = String(driverTotals.pending);
      driverPayoutApprovedEl.textContent = String(driverTotals.approved);
    }
  }

  async function assignOneOrder(internalId){
    if(!internalId){ alert("Missing order id."); return; }

    if(DEMO_MODE){
      // demo: mark pay pending for that order
      for(const tabKey in currentOrdersByTab){
        currentOrdersByTab[tabKey]?.forEach(o=>{
          if((o._internal_id||o.internal_id)===internalId){
            o.driver_pay_status = 'pending';
            if(!o.driver_pay_pending){
              // for demo let's say driver gets 30% of order total
              o.driver_pay_pending = Math.round(o.total * 0.3);
            }
          }
        });
      }
      updateDriverTotalsFromOrders();
      alert('[DEMO] Assigned ${internalId}, driver sees pending R${driverTotals.pending}');
      renderOrders();
      return;
    }

    try{
      const res = await fetch('${BASE_API}/orders/${encodeURIComponent(internalId)}/auto-assign', {
        method: "POST",
        headers: {"Content-Type":"application/json"}
      });
      const data = await res.json().catch(()=>({}));

      if(res.ok && data && data.ok){
        alert('Assigned: ${internalId} -> ${data.driver_id || 'driver?'}');
      } else if (res.status === 409 && data && data.error === "no_driver_available") {
        alert('No driver available for ${internalId}');
      } else {
        alert('Failed to assign ${internalId} (${res.status})');
      }
    }catch(err){
      console.error("assignOneOrder err",err);
      alert('Network error assigning ${internalId}');
    }
    renderOrders();
  }

  async function markDelivered(internalId){
    if(!internalId){ alert("Missing order id."); return; }

    if(DEMO_MODE){
      // demo: move pending -> approved for that order
      for(const tabKey in currentOrdersByTab){
        currentOrdersByTab[tabKey]?.forEach(o=>{
          if((o._internal_id||o.internal_id)===internalId){
            if(o.driver_pay_status === 'pending'){
              o.driver_pay_status = 'approved';
              o.driver_pay_approved = o.driver_pay_pending || o.driver_pay_approved || 0;
              o.driver_pay_pending = 0;
            } else {
              o.driver_pay_status = 'approved';
              if(!o.driver_pay_approved){
                o.driver_pay_approved = Math.round(o.total * 0.3);
              }
            }
            o.status = 'delivered';
          }
        });
      }
      updateDriverTotalsFromOrders();
      alert('[DEMO] Marked delivered ${internalId}, approved payout R${driverTotals.approved}');
      renderOrders();
      return;
    }

    try{
      const res = await fetch('${BASE_API}/orders/${encodeURIComponent(internalId)}/status', {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({status:"delivered"})
      });
      const data = await res.json().catch(()=>({}));
      if(res.ok && data && data.ok){
        alert('Marked delivered: ${internalId}');
      } else {
        alert('Failed to mark delivered (${res.status})');
      }
    }catch(err){
      console.error("markDelivered err",err);
      alert('Network error marking delivered ${internalId}');
    }
    renderOrders();
  }

  async function autoAssignForAll(){
    const ordersInTab = currentOrdersByTab[ordersTab] || [];
    const targets = ordersInTab.filter(o => o.status === 'pending');
    if (targets.length === 0){ alert("No pending orders in this view to assign."); return; }

    const results = [];
    for (const o of targets){
      const internalId = o._internal_id || o.internal_id || null;
      if(!internalId){ results.push('❓ Missing ID for an order, skipped.'); continue; }

      if (DEMO_MODE){
        o.driver_pay_status = 'pending';
        if(!o.driver_pay_pending){
          o.driver_pay_pending = Math.round(o.total * 0.3);
        }
        results.push('✅ (demo) ${internalId} -> pending R${o.driver_pay_pending}');
        continue;
      }

      try {
        const res = await fetch('${BASE_API}/orders/${encodeURIComponent(internalId)}/auto-assign', {
          method: "POST",
          headers: {"Content-Type":"application/json"}
        });
        const data = await res.json().catch(()=>({}));

        if(res.ok && data && data.ok){
          const driverId = data.driver_id || "driver?";
          results.push('✅ ${internalId} → ${driverId}');
        } else if (res.status === 409 && data && data.error === "no_driver_available") {
          results.push('⚠️ ${internalId}: no driver');
        } else {
          results.push('❌ ${internalId}: failed (${res.status})');
        }
      } catch (err){
        console.error("autoAssignForAll error", err);
        results.push('❌ ${internalId}: network error');
      }
    }
    updateDriverTotalsFromOrders();
    alert(results.join("\n"));
    renderOrders();
  }
  ordersAssign?.addEventListener('click', autoAssignForAll);

  // update tab UI
  document.querySelectorAll('.yt-o-tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.yt-o-tab')
        .forEach(x=>{
          x.classList.remove('bg-emerald-600','text-white');
          x.setAttribute('aria-selected','false');
        });
      btn.classList.add('bg-emerald-600','text-white');
      btn.setAttribute('aria-selected','true');
      ordersTab = btn.dataset.oTab;
      renderOrders();
    });
  });

  // Admin PIN gate (front-end demo; use ADMIN_SECRET on backend for real)
  adminBtn?.addEventListener('click', ()=>{
    const pin = prompt('Enter admin PIN:');
    if(pin && pin.trim() !== ""){
      alert('Admin mode ON');
      openOrders();
    } else {
      alert('Invalid PIN');
    }
  });

  async function fetchOrdersByStatus(status){
    if(DEMO_MODE){
      // Demo objects now include driver pay fields
      return [
        {
          _internal_id: "demo-abc123",
          order_id: "YI-DEMO123",
          status: status,
          total: 120,
          items: [
            {name:"Panado 500mg (24s)",qty:1},
            {name:"Cough Syrup 100ml",qty:2}
          ],
          meta: { zone:"A" },
          fraud_score: 0.07,
          driver_pay_status: "pending",
          driver_pay_pending: 36,      // 30% of 120
          driver_pay_approved: 0
        }
      ];
    }

    try {
      const res = await fetch('${BASE_API}/orders?status=${encodeURIComponent(status)}');
      const data = await res.json().catch(()=>({}));
      if(!res.ok || !data.ok){ return []; }
      if (data.zone_demand_snapshot){ zoneDemandStats = data.zone_demand_snapshot; }
      return Array.isArray(data.orders) ? data.orders : [];
    } catch(err){
      console.error("fetchOrdersByStatus error",err);
      return [];
    }
  }

  async function renderOrders(){
    const data = await fetchOrdersByStatus(ordersTab);
    currentOrdersByTab[ordersTab] = data;

    // recalc driver totals whenever we fetch
    updateDriverTotalsFromOrders();

    ordersList.innerHTML = data.length
      ? ''
      : '<div class="text-sm text-slate-500 p-4">No ${ordersTab} orders.</div>';

    for(const o of data){
      const itemsText = (o.items || [])
        .map(i=>'${i.name} x${i.qty}')
        .join(', ');

      const internalId = o._internal_id || o.internal_id || null;
      const refDisplay = o.order_public_id || o.order_id || internalId || "REF?";
      const zoneDisplay = (o.meta && o.meta.zone) ? o.meta.zone : "?";
      const fraudDisplay = (typeof o.fraud_score === "number")
        ? ' • Fraud: ${o.fraud_score.toFixed(2)}'
        : "";

      // driver pay info bloc
      let driverPayText = "Driver pay: R0";
      let driverPayStatusText = "Status: –";
      if(o.driver_pay_status === "pending"){
        driverPayText = 'Driver pay: R${o.driver_pay_pending || 0}';
        driverPayStatusText = "Status: pending";
      } else if(o.driver_pay_status === "approved"){
        driverPayText = 'Driver pay: R${o.driver_pay_approved || 0}';
        driverPayStatusText = "Status: approved";
      }

      const isDelivered = o.status === "delivered";
      const canAssign   = (o.status === "pending" || o.status === "review_required") && !isDelivered;
      const canDeliver  = (o.status === "assigned" || o.status === "in_transit" || o.status === "pending" || o.status === "review_required") && !isDelivered;

      const row = document.createElement('div');
      row.className = 'p-3 flex flex-col sm:flex-row sm:items-center gap-3 border-b border-slate-200';
      row.setAttribute('data-order-id', internalId || '');
      row.setAttribute('data-order-status', o.status || '');

      row.innerHTML = '
        <div class="flex-1 min-w-0">
          <div class="font-medium flex flex-wrap items-center gap-1">
            <span>Ref ${refDisplay}</span>
            <span>• Zone ${zoneDisplay}</span>
            <span>• Total R${o.total}</span>
            ${demandBadge(zoneDisplay)}
          </div>
          <div class="text-xs text-slate-500 break-words">${itemsText}</div>
          <div class="text-xs text-slate-500">
            Status: ${o.status}${fraudDisplay}
          </div>
          <div class="text-[11px] leading-snug text-slate-500 mt-1">
            ${driverPayText} • ${driverPayStatusText}
          </div>
        </div>
        <div class="flex flex-row flex-wrap gap-2 text-xs sm:justify-end">
          <button
            class="btn-assign px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100 disabled:opacity-40 disabled:cursor-not-allowed"
            ${(!canAssign || !internalId) ? 'disabled' : ''}
            data-id="${internalId || ''}">
            Assign
          </button>
          <button
            class="btn-delivered px-2 py-1 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-40 disabled:cursor-not-allowed"
            ${(!canDeliver || !internalId) ? 'disabled' : ''}
            data-id="${internalId || ''}">
            Delivered
          </button>
        </div>
      ';
      ordersList.appendChild(row);
    }

    ordersList.querySelectorAll('.btn-assign').forEach(btn=>{
      btn.addEventListener('click', ()=> assignOneOrder(btn.getAttribute('data-id')));
    });
    ordersList.querySelectorAll('.btn-delivered').forEach(btn=>{
      btn.addEventListener('click', ()=> markDelivered(btn.getAttribute('data-id')));
    });
  }

  // === MAP SETUP ===
  const heroEl  = document.getElementById('heroMap');
  const heroMap = L.map(heroEl,{
    zoomControl:false,
    dragging:false,
    scrollWheelZoom:false,
    doubleClickZoom:false,
    boxZoom:false,
    touchZoom:false
  }).setView([-33.20, 26.55], 8);

  L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
    { attribution:'', opacity:0.96, noWrap:true, detectRetina:true }
  ).addTo(heroMap);

  const southAfricaBounds = L.latLngBounds([[-35.5, 16.0], [-22.0, 33.5]]);
  heroMap.setMaxBounds(southAfricaBounds.pad(0.05));

  const HUBS=[
    {name:'Port Alfred',zone:'A',lat:-33.590,lng:26.890},
    {name:'Bathurst',zone:'B',lat:-33.498,lng:26.833},
    {name:'Kenton-on-Sea',zone:'C',lat:-33.686,lng:26.668},
    {name:'Makhanda/Grahamstown',zone:'D',lat:-33.310,lng:26.520},
    {name:'Alice',zone:'D',lat:-32.787,lng:26.834},
    {name:'Alexandria',zone:'E',lat:-33.653,lng:26.404},
    {name:'Alicedale',zone:'E',lat:-33.321,lng:26.078}
  ];

  const ROADS = [
    [[HUBS[1].lat,HUBS[1].lng],[HUBS[0].lat,HUBS[0].lng]],
    [[HUBS[2].lat,HUBS[2].lng],[HUBS[5].lat,HUBS[5].lng]],
    [[HUBS[6].lat,HUBS[6].lng],[HUBS[3].lat,HUBS[3].lng]],
    [[HUBS[3].lat,HUBS[3].lng],[HUBS[4].lat,HUBS[4].lng]],
    [[HUBS[4].lat,HUBS[4].lng],[HUBS[0].lat,HUBS[0].lng]],
    [[HUBS[3].lat,HUBS[3].lng],[HUBS[2].lat,HUBS[2].lng]],
    [[HUBS[5].lat,HUBS[5].lng],[HUBS[0].lat,HUBS[0].lng]],
    [[HUBS[6].lat,HUBS[6].lng],[HUBS[2].lat,HUBS[2].lng]]
  ];

  function carIcon(zone){
    const cls=\'car-dot car-\${zone}\';
    const svg=\'<svg viewBox='0 0 64 28' aria-hidden='true'><g>
      <rect x='6' y='10' rx='6' ry='6' width='52' height='10' fill='#0f172a' opacity='.85'/>
      <rect x='10' y='5' rx='6' ry='6' width='44' height='14' fill='#ffffff'/>
      <rect x='24' y='6' width='16' height='7' rx='2' fill='#e5e7eb'/>
      <rect x='10' y='9' width='4' height='3' fill='#f59e0b'/>
      <rect x='50' y='9' width='4' height='3' fill='#f59e0b'/>
      <circle cx='18' cy='20' r='3' fill='#0f172a'/>
      <circle cx='46' cy='20' r='3' fill='#0f172a'/>
    </g></svg>\';
    return L.divIcon({ className:cls, html:svg, iconSize:[24,12], iconAnchor:[12,6] });
  }

  const pkgSvg='<svg viewBox='0 0 24 24' aria-hidden='true'>
    <path fill='#059669' d='M3 7l9-4 9 4-9 4-9-4zm0 3l9 4 9-4v7c0 .4-.2.8-.6 1l-7.8 3.5c-.4.2-.8.2-1.2 0L3.6 18c-.4-.2-.6-.6-.6-1V10z'/>
  </svg>';

  const pkgIcon=L.divIcon({ className:'pkg-dot', html:pkgSvg, iconSize:[20,20], iconAnchor:[10,10] });

  function lerp(a,b,t){return a+(b-a)*t;}
  function posOnSeg(seg,t){
    const [A,B]=seg;
    return [lerp(A[0],B[0],t), lerp(A[1],B[1],t)];
  }

  const cars   = [];
  const parcels= [];

  function jitterAround(pt,meters){
    const d=(meters||800)/111111;
    const r=Math.random()*d;
    const a=Math.random()*Math.PI*2;
    return { lat: pt.lat + r*Math.cos(a), lng: pt.lng + r*Math.sin(a) };
  }

  function makeCar(zone){
    const seg     = ROADS[(Math.random()*ROADS.length)|0];
    const startT  = Math.random();
    const dir     = Math.random()<.5 ? 1 : -1;
    const speed   = 0.10+Math.random()*0.06;
    const [lat,lng]=posOnSeg(seg,startT);
    const m      = L.marker([lat,lng],{icon:carIcon(zone)}).addTo(heroMap);
    cars.push({m,seg,t:startT,dir,speed});
  }

  function makeParcel(){
    const seg     = ROADS[(Math.random()*ROADS.length)|0];
    const startT  = Math.random();
    const dir     = Math.random()<.5 ? 1 : -1;
    const speed   = 0.12+Math.random()*0.06;
    const [lat,lng]=posOnSeg(seg,startT);
    const m      = L.marker([lat,lng],{icon:pkgIcon}).addTo(heroMap);
    parcels.push({m,seg,startT,t:startT,dir,speed});
  }

  for(let i=0;i<10;i++) makeCar(['A','B','C','D','E'][i%5]);
  for(let i=0;i<6;i++)  makeParcel();

  let lastTS = performance.now();
  function animate(now){
    const dt = Math.min((now-lastTS)/1000, 0.05);
    lastTS = now;

    for(const c of cars){
      c.t += c.speed * c.dir * dt;
      if(c.t>1){ c.t=1; c.dir=-1; }
      else if(c.t<0){ c.t=0; c.dir=1; }
      const [lat,lng] = posOnSeg(c.seg,c.t);
      c.m.setLatLng([lat,lng]);
    }

    for(const p of parcels){
      p.t += p.speed * p.dir * dt;
      if(p.t>1){ p.t=1; p.dir=-1; }
      else if(p.t<0){ p.t=0; p.dir=1; }
      const [lat,lng] = posOnSeg(p.seg,p.t);
      p.m.setLatLng([lat,lng]);
    }

    requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
  setTimeout(()=>heroMap.invalidateSize(),180);
  window.addEventListener('resize',()=>heroMap.invalidateSize());

  // === DRIVER SIGNUP ===
  formSignup?.addEventListener('submit', async e=>{
    e.preventDefault();
    const name    = document.getElementById('drvName').value.trim();
    const phone   = digits(document.getElementById('drvPhone').value.trim());
    const zone    = document.getElementById('drvZone').value;
    const radius  = Math.max(1, Number(document.getElementById('drvRadius').value || 10));
    const vehicle = document.getElementById('drvVehicle').value.trim();

    if(!name || !phone){ alert("Please enter name and phone."); return; }

    const hubMap = { A:HUBS[0], B:HUBS[1], C:HUBS[2], D:HUBS[3], E:HUBS[5] };
    const hub   = hubMap[zone] || HUBS[0];
    const start = jitterAround({lat:hub.lat,lng:hub.lng},1500);

    L.marker([start.lat,start.lng],{icon:carIcon(zone)}).addTo(heroMap);

    const driverPayload = {
      driver_id: 'DRV-${Date.now().toString().slice(-6)}',
      name,
      phone,
      vehicle,
      available: true,
      current_location: { lat:start.lat, lng:start.lng },
      meta: { zone, radius_km: radius }
    };

    if(!DEMO_MODE){
      try{
        const r = await fetch('${BASE_API}/drivers',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(driverPayload)
        });
        const j = await r.json().catch(()=>({}));
        if (!r.ok || !j.ok){ alert("Driver save failed on server."); }
      }catch(err){ console.error("driver create failed",err); }
    } else { console.info("[DEMO] Would POST driver", driverPayload); }

    const text = 'New driver sign-up
Name: ${name}
Phone: ${phone}
Zone: ${zone}
Radius: ${radius}km
Vehicle: ${vehicle}';
    window.open('https://wa.me/${ADMIN_WHATSAPP}?text=${waText(text)}','_blank');

    closeDriverWindow();

    // fill dashboard demo
    if(driverDashModal){
      driverPayoutPendingEl.textContent = String(driverTotals.pending);
      driverPayoutApprovedEl.textContent = String(driverTotals.approved);
      driverNextWindowEl.textContent = 'Fri 17:00';
      driverZoneDisplayEl.textContent = zone;
      driverRadiusDisplayEl.textContent = radius+'km';
      openDriverDash();
    }
  });

  // fake driver login (front-end demo; real flow uses /driver_login)
  formLogin?.addEventListener('submit',e=>{
    e.preventDefault();
    alert('Logged in (demo). Opening dashboard.');
    closeDriverWindow();
    if(driverDashModal){ openDriverDash(); }
  });

  // === SUBMIT ORDER ===
  confirmBtn2?.addEventListener('click', async ()=>{
    // Prevent double clicks
    confirmBtn2.disabled = true;
    try{
      const summary = computeTotal();
      if (!summary.items.length){ alert('Please select at least one item.'); return; }

      const custName  = (custNameEl.value||'').trim();
      const custPhone = digits((custPhoneEl.value||'').trim());
      const custAddr  = (custAddrEl.value||'').trim();
      if(!custName || !custPhone || !custAddr){
        alert('Please fill name, WhatsApp and address.');
        return;
      }

      const paymentMethod = selectedPay();
      const eta           = nextETA(Boolean(summary.rush));

      const orderPayload = {
        customer: {
          name: custName,
          phone: custPhone,
          address: {
            line1: custAddr,
            suburb: 'Zone ${summary.zoneVal}',
            coords: { lat: summary.hubLat, lng: summary.hubLng }
          }
        },
        items: summary.items.map(it => ({
          sku: null, name: it.name, qty: it.qty, price: it.price
        })),
        subtotal: summary.itemsTotal,
        delivery_fee: summary.fee + summary.rush,
        total: summary.total,
        payment: { method: paymentMethod, status: "pending", provider_ref: null },
        created_by: "web",
        route: { eta_minutes: null, distance_km: null, eta_text: eta },
        meta: { rush: !!summary.rush, zone: summary.zoneVal }
      };

      if(DEMO_MODE){
        console.info("[DEMO] Would POST", orderPayload);
        const refStub = Date.now().toString().slice(-6);
        latestOrderData = {
          order_public_id: "DEMO-" + refStub,
          status: "pending",
          fraud_score: 0.0,
          total: summary.total,
          zone: summary.zoneVal,
          items: summary.items,
          eta,
          payment_method: paymentMethod,
          wa_message:
            'Yi Thume, my order is:\n' +
            'Ref: DEMO-${refStub}\n' +
            'Deliver to: Zone ${summary.zoneVal}, ${custAddr}\n' +
            'Items: ${summary.items.map(i=>\'\${i.name} x\${i.qty}\').join(', ')}\n' +
            'Total: R${summary.total}\n' +
            'Expected: ${eta}\n' +
            'Payment: ${paymentMethod}\n' +
            'Please confirm + send payment link.'
        };
      } else {
        let data = null;
        try {
          const res = await fetch('${BASE_API}/orders', {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(orderPayload)
          });

          try { data = await res.json(); } catch(_) { data = null; }

          if (res.status === 409 && data && data.error === "no_driver_available") {
            alert(data.message || 'Sorry, no driver currently available in Zone ${orderPayload.meta.zone}.');
            return;
          }
          if(!res.ok || !data || !data.ok){
            console.error("Order failed", res.status, data);
            alert("Order failed on server.");
            return;
          }

          latestOrderData = {
            order_public_id: data.order_public_id || data.order_id || ("YI-" + Date.now().toString().slice(-6)),
            status:         data.status || "pending",
            fraud_score:    data.fraud_score ?? null,
            total:          summary.total,
            zone:           summary.zoneVal,
            items:          summary.items,
            eta,
            payment_method: paymentMethod,
            wa_message:     data.wa_message || null
          };

          if (data.zone_demand_snapshot) { zoneDemandStats = data.zone_demand_snapshot; }
        } catch(err){
          console.error("Network/Fetch error", err);
          alert("Network error creating order.");
          return;
        }
      }

      // SUCCESS UI
      closeOrder();
      openBot();

      appendBot(
        '<b>YiThume</b> 🤖<br/>
         Thanks for your order!<br/>
         <b>Ref:</b> ${latestOrderData.order_public_id}<br/>
         <b>Items:</b> ${latestOrderData.items.map(i=>\'\${i.name} x\${i.qty}\').join(', ')}<br/>
         <b>Zone:</b> ${latestOrderData.zone}<br/>
         <b>Total:</b> R${latestOrderData.total}<br/>
         <b>Estimated window:</b> ${latestOrderData.eta}'
      );

      if(latestOrderData.status === "review_required"){
        appendBot('<b>Note:</b> We're quickly reviewing this order for safety. We'll confirm shortly.');
      } else {
        appendBot('Choose your payment method below and tap <b>Pay</b>.');
      }

      botPayChoice.value = latestOrderData.payment_method;

    } finally {
      // Re-enable button regardless of outcome
      confirmBtn2.disabled = false;
    }
  });

  // BOT PAY BUTTON
  botNext?.addEventListener('click', ()=>{
    if(!latestOrderData) return;

    const pay = botPayChoice.value;
    latestOrderData.payment_method = pay;

    if(botStage === 0){
      if(pay === 'eft'){
        appendBot(
          '<b>Instant EFT (Ozow)</b><br/>
           We’ll WhatsApp you a secure Ozow link.<br/>
           Use ref <code>${latestOrderData.order_public_id}</code>.'
        );
      } else if(pay === 'card'){
        appendBot(
          'We'll WhatsApp you a secure <b>card link</b> (Yoco).<br/>
           Use ref <code>${latestOrderData.order_public_id}</code>.'
        );
      } else {
        const deposit = Math.ceil(latestOrderData.total*0.5);
        appendBot(
          '<b>50% deposit + COD</b><br/>
           Pay deposit now: <b>R${deposit}</b>.<br/>
           Balance due at delivery.<br/>
           Ref <code>${latestOrderData.order_public_id}</code>.'
        );
      }

      appendBot('This next screen is a demo. No money is taken here.');
      // Pop fake pay portal (demo)
      openPayModal(latestOrderData.order_public_id, latestOrderData.total);
      botStage = 1;
      return;
    }

    // if they click Pay again after stage 1 we just remind them:
    appendBot('Click "Send to WhatsApp" so we can confirm the order and send the real secure payment link.');
  });

  // SEND TO WHATSAPP
  botSendWA?.addEventListener('click', () => {
    if(!latestOrderData){ alert("No order data."); return; }

    const msg = latestOrderData.wa_message
      ? latestOrderData.wa_message
      : [
          "Yi Thume, my order is:",
          'Ref: ${latestOrderData.order_public_id}',
          'Deliver to: Zone ${latestOrderData.zone}',
          'Items: ${latestOrderData.items.map(i=>\'\${i.name} x\${i.qty}\').join(', ')}',
          'Total: R${latestOrderData.total}',
          'Expected: ${latestOrderData.eta}',
          'Payment: ${latestOrderData.payment_method}',
          "Please confirm + send payment link."
        ].join("\\n");

    const wa = 'https://wa.me/${WHATSAPP_NUMBER}?text=${waText(msg)}';
    window.open(wa,'_blank');

    closeBot();
    alert('Order sent to WhatsApp. Ref: ${latestOrderData.order_public_id}');
  });

  // NEW ORDER after fake pay
  botNewOrder?.addEventListener('click', ()=>{
    closeBot();
    openOrder();
  });

  // === ADMIN OPEN VIA EVENT ===
  window.addEventListener('yt-open-orders', openOrders);
  window.addEventListener('yt-orders-updated', ()=>{
    if(!ordersPanel.classList.contains('hidden')) renderOrders();
  });

  // === INITIALIZE STORE ITEMS VIEW ===
  renderStoreItems();

  // initial dashboard numbers
  driverPayoutPendingEl.textContent = String(driverTotals.pending);
  driverPayoutApprovedEl.textContent = String(driverTotals.approved);
});
</script>
</body>
</html>
